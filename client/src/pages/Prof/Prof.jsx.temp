 import { useState, useEffect, useCallback, useRef, useMemo } from 'react'
import { useNavigate, useLocation } from 'react-router-dom'
import './Prof.css'
import { onAuthStateChanged as watchAuthState, signOutUser } from '../../firebase'
import { getProfessorByUid, setProfessor, updateProfessor } from '../../services/professors'
import { getStudentByEmail, getStudentByNumericalId, setStudent } from '../../services/students'

import { getCoursesByProfessor, getCourseByCode, createCourse, deleteCourse } from '../../services/courses'
import { createEnrollment, getEnrollmentByStudentAndCourse, getEnrollmentsByCourse, subscribeToCourseEnrollments, deleteEnrollmentByStudentAndCourse } from '../../services/enrollments'
import { getGradesByCourse, createGrade, updateGrade, deleteGrade } from '../../services/grades'
import { getAttendanceByCourse, createAttendance, updateAttendance, setAttendanceForDate } from '../../services/attendance'
import { getNotifications, markAsRead, markAllAsRead, subscribeToNotifications } from '../../services/notifications'
import { generateStudentEmail, isValidNumericalStudentId } from '../../utils/studentIdHelpers'
import { useTheme } from '../../hooks/useTheme'
import * as XLSX from 'xlsx'

const normalizeStudentId = (value) => {
  if (value === null || value === undefined) return ''
  return String(value).trim()
}

const normalizeEnrollsMap = (enrollsMap = {}) => {
  const normalized = {}
  Object.keys(enrollsMap).forEach(subjectCode => {
    const ids = Array.isArray(enrollsMap[subjectCode]) ? enrollsMap[subjectCode] : []
    const cleaned = ids
      .map(normalizeStudentId)
      .filter(Boolean)
    normalized[subjectCode] = Array.from(new Set(cleaned))
  })
  return normalized
}

function Prof() {
  const navigate = useNavigate()
  const location = useLocation()
  const [activeTab, setActiveTab] = useState('subjects')
  const [profName, setProfName] = useState('Professor User')
  const [profPic, setProfPic] = useState(null)
  const [showProfileModal, setShowProfileModal] = useState(false)
  const [showAddSubjectModal, setShowAddSubjectModal] = useState(false)
  const [showNotifDropdown, setShowNotifDropdown] = useState(false)
  const [showSubjectDetail, setShowSubjectDetail] = useState(false)
  const [selectedSubject, setSelectedSubject] = useState(null)
  
  // Form states
  const [newSubject, setNewSubject] = useState({ code: '', name: '', credits: '' })
  const [profileForm, setProfileForm] = useState({ name: '', pic: null })
  const [profileSaveSuccess, setProfileSaveSuccess] = useState(false)
  const [addSubjectError, setAddSubjectError] = useState('')
  const [isSavingSubject, setIsSavingSubject] = useState(false)
  
  // Data states
  const [subjects, setSubjects] = useState([])
  const [removedSubjects, setRemovedSubjects] = useState([]) // Track deleted subjects
  const [students, setStudents] = useState([])
  const [enrolls, setEnrolls] = useState({})
  const [alerts, setAlerts] = useState([])
  const [records, setRecords] = useState({})
  const [grades, setGrades] = useState({})
  const [currentSubject, setCurrentSubject] = useState(null)
  const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().slice(0, 10))
  const [currentTime, setCurrentTime] = useState('')
  const [quickGradeType, setQuickGradeType] = useState('quiz')
  const [quickGradeTitle, setQuickGradeTitle] = useState('')
  const [quickGradeMaxPoints, setQuickGradeMaxPoints] = useState('')
  const [quickGradeDueDate, setQuickGradeDueDate] = useState('')
  const [showQuickGradeGrid, setShowQuickGradeGrid] = useState(false)
  const [quickGradeScores, setQuickGradeScores] = useState({})
  const realtimeUnsubscribeRef = useRef(null)
  const previousDataRef = useRef(null)
  const isImportingRef = useRef(false) // Prevent real-time listener from overwriting during import
  const lastImportTimeRef = useRef(0) // Track when last import happened to prevent stale real-time updates
  const dataLoadTimeRef = useRef(0) // Track when data was loaded to prevent real-time overwrites immediately after load
  const [showLogoutModal, setShowLogoutModal] = useState(false)
  const [showAddStudentModal, setShowAddStudentModal] = useState(false)
  const [showAddStudentToSubjectModal, setShowAddStudentToSubjectModal] = useState(false)
  const [selectedSubjectForStudent, setSelectedSubjectForStudent] = useState(null)
  const [studentSubjectFilter, setStudentSubjectFilter] = useState('')
  const [showArchivedStudents, setShowArchivedStudents] = useState(false)
  const [newStudent, setNewStudent] = useState({ id: '', name: '', email: '', subjects: [] })
  const [studentToAdd, setStudentToAdd] = useState('')
  const [newStudentQuick, setNewStudentQuick] = useState({ id: '', name: '', email: '' })
  // Comprehensive modal state
  const [addStudentModalTab, setAddStudentModalTab] = useState('import') // 'archived', 'create', or 'import'
  const [selectedStudentsForBulk, setSelectedStudentsForBulk] = useState([])
  const [selectedSubjectsForBulk, setSelectedSubjectsForBulk] = useState([])
  const [selectAllStudents, setSelectAllStudents] = useState(false)
  const [archivedStudentDetailView, setArchivedStudentDetailView] = useState(null) // Student ID for detail view
  const [studentSearchTerm, setStudentSearchTerm] = useState('') // Search term for student filtering
  const [showSearchDropdown, setShowSearchDropdown] = useState(false) // Control autocomplete dropdown visibility
  const [csvFile, setCsvFile] = useState(null)
  const [csvPreview, setCsvPreview] = useState([])
  const [isImporting, setIsImporting] = useState(false)
  const [refreshTrigger, setRefreshTrigger] = useState(0) // Force re-render trigger
  const [viewMode, setViewMode] = useState('professor')
  const [selectedStudentId, setSelectedStudentId] = useState('')
  const [studentDetailSubject, setStudentDetailSubject] = useState(null)
  const [subjectPreviewCode, setSubjectPreviewCode] = useState(null)
  const [profilePreview, setProfilePreview] = useState(null)
  const [studentAlerts, setStudentAlerts] = useState([])
  const [profUid, setProfUid] = useState(null)
  const [profEmail, setProfEmail] = useState('')
  const [profProfile, setProfProfile] = useState(null)
  const [studentProfileName, setStudentProfileName] = useState(null)
  const [profileSection, setProfileSection] = useState('account') // 'account', 'appearance'
  const [realtimeUpdatesDisabled, setRealtimeUpdatesDisabled] = useState(() => {
    try {
      return localStorage.getItem('disableRealtimeUpdates') === 'true'
    } catch {
      return false
    }
  })
  const [subjectCourseMap, setSubjectCourseMap] = useState({})
  const courseEnrollmentListenersRef = useRef({})
  const [showRestoreSubjectDropdown, setShowRestoreSubjectDropdown] = useState(false)
  const [showNewStudentSubjectDropdown, setShowNewStudentSubjectDropdown] = useState(false)
  const restoreSubjectDropdownRef = useRef(null)
  const newStudentSubjectDropdownRef = useRef(null)

  const studentsById = useMemo(() => {
    const map = {}
    students.forEach(student => {
      const key = normalizeStudentId(student.id)
      if (key) {
        map[key] = student
      }
    })
    return map
  }, [students])

  const selectedStudentIdSet = useMemo(() => {
    return new Set(selectedStudentsForBulk.map(normalizeStudentId).filter(Boolean))
  }, [selectedStudentsForBulk])

  const setNormalizedEnrolls = useCallback((nextValue) => {
    if (typeof nextValue === 'function') {
      setEnrolls(prev => normalizeEnrollsMap(nextValue(prev)))
    } else {
      setEnrolls(normalizeEnrollsMap(nextValue))
    }
  }, [setEnrolls])

  const getSubjectLabel = useCallback((subjectCode) => {
    const subject = subjects.find(s => s.code === subjectCode)
    return subject ? `${subject.code} â€” ${subject.name}` : subjectCode
  }, [subjects])

  const navigateToSubjectTab = useCallback((subjectCode, tab) => {
    if (!subjectCode) return
    const findSubjectByCode = (code) => {
      if (!code) return null
      let subject = subjects.find(s => s.code === code)
      if (subject) return subject
      subject = subjects.find(s => s.code?.toLowerCase() === code.toLowerCase())
      if (subject) return subject
      subject = subjects.find(s => s.code?.includes(code) || code.includes(s.code))
      return subject || null
    }
    const subject = findSubjectByCode(subjectCode)
    if (!subject) return

    setSelectedSubject(subject)
    if (tab === 'attendance' || tab === 'grades' || tab === 'students' || tab === 'subjects') {
      setActiveTab(tab)
    }
    setShowNotifDropdown(false)

    // Best-effort URL update so deep-links remain meaningful
    try {
      const params = new URLSearchParams(location.search)
      params.set('tab', tab)
      params.set('subjectId', subject.code)
      navigate({ pathname: location.pathname, search: params.toString() })
    } catch {
      // Ignore navigation errors
    }
  }, [subjects, navigate, location.pathname, location.search])

  // Load real-time preference from Firestore (with localStorage backup) on mount
  useEffect(() => {
    const loadRealtimePreference = async () => {
      if (!profUid || !profProfile) return
      
      try {
        // Try Firestore first, with localStorage backup
        const profile = await getProfessorByUid(profUid)
        if (profile?.preferences?.disableRealtimeUpdates !== undefined) {
          const firestoreValue = profile.preferences.disableRealtimeUpdates
          const localValue = localStorage.getItem('disableRealtimeUpdates') === 'true'
          
          // If Firestore has a value, use it and sync to localStorage
          if (firestoreValue !== localValue) {
            if (firestoreValue) {
              localStorage.setItem('disableRealtimeUpdates', 'true')
            } else {
              localStorage.removeItem('disableRealtimeUpdates')
            }
            setRealtimeUpdatesDisabled(firestoreValue)
          }
        } else {
          // No Firestore preference, check localStorage backup
          const localValue = localStorage.getItem('disableRealtimeUpdates') === 'true'
          if (localValue) {
            setRealtimeUpdatesDisabled(true)
            // Try to sync localStorage preference to Firestore
            try {
              const currentProfile = await getProfessorByUid(profUid)
              // setWithBackup replaced - use updateProfessor instead {
                ...currentProfile,
                preferences: {
                  ...(currentProfile?.preferences || {}),
                  disableRealtimeUpdates: true,
                }
              }, { merge: true })
            } catch (e) {
              // Firestore unavailable, localStorage is backup
              console.warn('Could not sync preference to Firestore:', e.message)
            }
          }
        }
      } catch (error) {
        // If Firestore fails (quota, network, etc.), use localStorage value
        console.warn('Could not load real-time preference from Firestore, using localStorage:', error.message)
        const localValue = localStorage.getItem('disableRealtimeUpdates') === 'true'
        setRealtimeUpdatesDisabled(localValue)
      }
    }
    
    loadRealtimePreference()
  }, [profUid, profProfile])

  // Ensure every subject has a course document so we can attach enrollment listeners
  // OPTIMIZED: Only run once on mount, skip if quota exceeded to reduce reads
  useEffect(() => {
    if (!profUid || subjects.length === 0) return
    
    // Skip if quota exceeded to prevent more reads
    const quotaExceeded = localStorage.getItem('lastQuotaError')
    if (quotaExceeded) {
      const timeSinceError = Date.now() - parseInt(quotaExceeded)
      // Skip for 1 hour after quota error
      if (timeSinceError < 3600000) {
        console.log('â¸ï¸ Skipping course creation checks - quota exceeded recently')
        return
      }
    }
    
    let cancelled = false

    const ensureCoursesForSubjects = async () => {
      const pendingUpdates = {}

      for (const subject of subjects) {
        const code = subject?.code
        if (!code || subjectCourseMap[code] || pendingUpdates[code]) continue
        try {
          // OPTIMIZED: Check localStorage backup first to avoid Firestore read
          const storageKey = `firestore_backup_courses_${code}`
          const backup = localStorage.getItem(storageKey)
          let course = null
          
          if (backup) {
            try {
              const parsed = JSON.parse(backup)
              const courseData = parsed.data
              // Find course with matching code
              if (courseData && courseData.code === code) {
                course = { id: code, ...courseData }
              }
            } catch (e) {
              // Backup parse failed, continue to Firestore
            }
          }
          
          // Only query Firestore if not in backup
          if (!course) {
            course = await getCourseByCode(code)
          }
          
          if (!course) {
            const courseId = await createCourse({
              code: subject.code,
              name: subject.name,
              credits: subject.credits || '0',
              professorId: profUid,
            })
            course = { id: courseId }
          }
          pendingUpdates[code] = course.id
        } catch (error) {
          // If quota exceeded, stop trying
          if (error.code === 'resource-exhausted' || error.message?.includes('quota')) {
            console.warn('â¸ï¸ Quota exceeded - stopping course creation checks')
            localStorage.setItem('lastQuotaError', Date.now().toString())
            break
          }
          console.warn('Failed to resolve course for subject', code, error)
        }
      }

      if (!cancelled && Object.keys(pendingUpdates).length > 0) {
        setSubjectCourseMap(prev => ({ ...prev, ...pendingUpdates }))
      }
    }

    // Only run once on mount, not on every subject change
    const hasRun = sessionStorage.getItem('coursesEnsured')
    if (!hasRun) {
      ensureCoursesForSubjects()
      sessionStorage.setItem('coursesEnsured', 'true')
    }

    return () => {
      cancelled = true
    }
  }, [profUid]) // Removed subjects and subjectCourseMap from dependencies to prevent re-runs

  // System-wide theme management
  const { isDarkMode, toggleTheme } = useTheme()

  // DASHBOARD_COLLECTION removed - using MySQL instead
  
  // Helper function to add custom UI alerts (replaces browser alerts)
  // Note: This will be defined after saveData, so we'll use a ref or move it after saveData definition
  
  const updateSessionUser = useCallback((updates) => {
    const raw = sessionStorage.getItem('currentUser')
    if (!raw) return
    try {
      const data = JSON.parse(raw)
      const merged = { ...data, ...updates }
      sessionStorage.setItem('currentUser', JSON.stringify(merged))
    } catch (error) {
      console.warn('Unable to update currentUser session data', error)
    }
  }, [])

  const loadData = useCallback(async (uid) => {
    if (!uid) {
      console.warn('loadData called without UID')
      return false
    }
    try {
      // Try Firestore first, with localStorage backup
      const saved = await getWithBackup(DASHBOARD_COLLECTION, uid)
      if (saved) {
        console.log('ðŸ“¥ Dashboard data loaded from Firestore:', {
          subjects: (saved.subjects || []).length,
          students: (saved.students || []).length,
          enrolls: Object.keys(saved.enrolls || {}).length,
          alerts: (saved.alerts || []).length,
          records: Object.keys(saved.records || {}).length,
          grades: Object.keys(saved.grades || {}).length,
          enrollsDetails: Object.keys(saved.enrolls || {}).map(key => ({
            subject: key,
            studentCount: (saved.enrolls[key] || []).length,
            studentIds: saved.enrolls[key]
          })),
          allStudentIds: (saved.students || []).map(s => s.id)
        })
        
        // Migrate any legacy student IDs (S101, S102, etc.) to numerical IDs
        const migrated = migrateDashboardData(saved)
        
        // Check if migration occurred
        const needsMigration = JSON.stringify(saved) !== JSON.stringify(migrated)
        if (needsMigration) {
          console.log('Migrating legacy student IDs to numerical IDs...')
          // Save migrated data back to Firestore (with localStorage backup)
          // Use forceWrite to ensure migration is saved even if data looks similar
          await setWithBackup(DASHBOARD_COLLECTION, uid, {
            ...migrated,
            ownerUid: uid,
            updatedAt: new Date().toISOString(),
          }, { forceWrite: true })
          console.log('Migration complete - data saved with numerical IDs')
        }
        
        // Ensure all data fields are loaded with migrated IDs
        // Ensure archivedSubjects field exists on all students for data consistency
        // CRITICAL: Only set archivedSubjects if it's actually an array, otherwise use empty array
        const studentsWithArchived = (migrated.students || []).map(s => ({
          ...s,
          archivedSubjects: Array.isArray(s.archivedSubjects) ? s.archivedSubjects : []
        }))
        
        // CRITICAL: Log students with archived subjects to help debug
        const studentsWithArchivedSubjects = studentsWithArchived.filter(s => 
          Array.isArray(s.archivedSubjects) && s.archivedSubjects.length > 0
        )
        if (studentsWithArchivedSubjects.length > 0) {
          console.log('ðŸ“¦ Found students with archived subjects:', {
            count: studentsWithArchivedSubjects.length,
            students: studentsWithArchivedSubjects.map(s => ({
              id: s.id,
              name: s.name,
              archivedSubjects: s.archivedSubjects
            }))
          })
        }
        
        // CRITICAL: Filter out archived students from enrolls to ensure data consistency
        // This prevents archived students from reappearing after page refresh
        // CRITICAL: Normalize enrollments FIRST before filtering to ensure proper matching
        const normalizedLoadedEnrolls = normalizeEnrollsMap(migrated.enrolls || {})
        const cleanedEnrolls = {}
        Object.keys(normalizedLoadedEnrolls).forEach(subjectCode => {
          const enrolledIds = normalizedLoadedEnrolls[subjectCode] || []
          // Normalize all student IDs in enrollments for consistent matching
          const normalizedEnrolledIds = enrolledIds.map(normalizeStudentId).filter(Boolean)
          
          // Remove any student IDs that are archived for this subject
          // But KEEP enrollments even if student not found (they might be added later)
          cleanedEnrolls[subjectCode] = normalizedEnrolledIds.filter(enrolledId => {
            // Try to find student with normalized ID
            const student = studentsWithArchived.find(s => {
              const studentId = normalizeStudentId(s.id)
              return studentId === enrolledId
            })
            
            // If student not found, log warning but KEEP the enrollment
            // This prevents data loss if there's a timing issue
            if (!student) {
              console.warn(`âš ï¸ Enrollment found for student ID ${enrolledId} in subject ${subjectCode}, but student not found in students array. Keeping enrollment.`, {
                enrolledId,
                subjectCode,
                totalStudents: studentsWithArchived.length,
                studentIds: studentsWithArchived.map(s => normalizeStudentId(s.id))
              })
              return true // Keep the enrollment even if student not found
            }
            
            // Exclude if student is archived from this subject
            const isArchived = (student.archivedSubjects || []).includes(subjectCode)
            if (isArchived) {
              console.log(`ðŸ“¦ Filtering out archived student ${student.name} (${student.id}) from ${subjectCode}`)
            }
            return !isArchived
          })
        })
        
        // Check if cleaning removed any archived students from enrolls
        // Compare normalized versions for accurate comparison
        const normalizedLoadedForCompare = normalizeEnrollsMap(migrated.enrolls || {})
        const hadInconsistencies = JSON.stringify(normalizedLoadedForCompare) !== JSON.stringify(cleanedEnrolls)
        if (hadInconsistencies) {
          console.warn('âš ï¸ Data inconsistency detected: Archived students found in enrolls. Cleaning and saving...')
          // Save cleaned data back to Firestore (with localStorage backup) to fix inconsistency
          try {
            // Use full document write (no merge) to ensure complete data consistency
            // Use forceWrite to ensure the save happens even if data looks similar
            await setWithBackup(DASHBOARD_COLLECTION, uid, {
              ...migrated,
              enrolls: cleanedEnrolls,
              ownerUid: uid,
              updatedAt: new Date().toISOString(),
            }, { forceWrite: true })
            console.log('âœ… Cleaned enrolls data saved to Firestore (full document write)')
          } catch (error) {
            console.error('Failed to save cleaned enrolls:', error)
          }
        }
        
        // CRITICAL: Normalize enrollments one more time before setting state
        // This ensures consistency even if data was saved without normalization
        const finalEnrolls = normalizeEnrollsMap(cleanedEnrolls)
        
        // CRITICAL: Verify data integrity before setting state
        // Ensure all enrolled students exist in the students array
        const enrollmentStudentIds = new Set()
        Object.values(finalEnrolls || {}).forEach(enrolledIds => {
          enrolledIds.forEach(id => enrollmentStudentIds.add(normalizeStudentId(id)))
        })
        
        const studentIds = new Set(studentsWithArchived.map(s => normalizeStudentId(s.id)))
        const missingEnrollmentStudents = Array.from(enrollmentStudentIds).filter(id => !studentIds.has(id))
        
        if (missingEnrollmentStudents.length > 0) {
          console.error('âŒ CRITICAL: Found enrollments for students that don\'t exist in students array:', {
            missingStudentIds: missingEnrollmentStudents,
            totalEnrollments: enrollmentStudentIds.size,
            totalStudents: studentIds.size,
            enrollmentIds: Array.from(enrollmentStudentIds),
            studentIds: Array.from(studentIds),
            allEnrollments: Object.keys(finalEnrolls).map(key => ({
              subject: key,
              count: finalEnrolls[key].length,
              studentIds: finalEnrolls[key]
            }))
          })
          // CRITICAL: This is a data integrity issue - enrollments reference students that don't exist
          // This will cause students to disappear on refresh
          // We should NOT remove enrollments, but we should log this as a critical error
          console.error('âš ï¸ WARNING: This data inconsistency will cause students to disappear on refresh!')
          console.error('ðŸ’¡ The enrollments will be kept, but students won\'t display until students are added')
        } else {
          console.log('âœ… Data integrity check passed: All enrolled students exist in students array', {
            totalEnrollments: enrollmentStudentIds.size,
            totalStudents: studentIds.size,
            enrollmentsBySubject: Object.keys(finalEnrolls).map(key => ({
              subject: key,
              studentCount: finalEnrolls[key].length
            }))
          })
        }
        
        // CRITICAL: Set all state at once to ensure consistency
        // This prevents partial updates that could cause UI issues
        setSubjects(migrated.subjects || [])
        setRemovedSubjects(migrated.removedSubjects || []) // Load removed subjects
        setStudents(studentsWithArchived)
        setNormalizedEnrolls(finalEnrolls)
        setAlerts(migrated.alerts || [])
        setRecords(migrated.records || {})
        setGrades(migrated.grades || {})
        
        // CRITICAL: Track when data was loaded to prevent real-time listener from overwriting
        dataLoadTimeRef.current = Date.now()
        
        // Force UI refresh after loading
        setRefreshTrigger(prev => prev + 1)
        
        // Additional delayed refresh to ensure UI updates
        setTimeout(() => setRefreshTrigger(prev => prev + 1), 500)
        setTimeout(() => setRefreshTrigger(prev => prev + 1), 1000)
        
        console.log('âœ… Dashboard data loaded from Firestore:', {
          subjects: (migrated.subjects || []).length,
          students: (migrated.students || []).length,
          enrolls: Object.keys(finalEnrolls || {}).length,
          enrollsDetails: Object.keys(finalEnrolls || {}).map(key => ({
            subject: key,
            studentCount: (finalEnrolls[key] || []).length,
            studentIds: finalEnrolls[key],
            studentNames: (finalEnrolls[key] || []).map(id => {
              const student = studentsWithArchived.find(s => normalizeStudentId(s.id) === id)
              return student ? student.name : 'Unknown'
            })
          })),
          alerts: (migrated.alerts || []).length,
          records: Object.keys(migrated.records || {}).length,
          grades: Object.keys(migrated.grades || {}).length,
          updatedAt: migrated.updatedAt || 'N/A',
          migrated: needsMigration,
          cleaned: hadInconsistencies,
        })
        
        // Additional verification: Log if students are missing for enrollments
        Object.keys(finalEnrolls || {}).forEach(subjectCode => {
          const enrolledIds = finalEnrolls[subjectCode] || []
          const missingStudents = enrolledIds.filter(id => {
            const normalizedId = normalizeStudentId(id)
            return !studentsWithArchived.find(s => normalizeStudentId(s.id) === normalizedId)
          })
          if (missingStudents.length > 0) {
            console.warn(`âš ï¸ Subject ${subjectCode} has ${missingStudents.length} enrolled students not found in students array:`, {
              missingIds: missingStudents,
              enrolledIds: enrolledIds,
              totalEnrolled: enrolledIds.length,
              studentsInSystem: studentsWithArchived.map(s => normalizeStudentId(s.id)),
              subjectCode
            })
            // CRITICAL: If students are missing, they might have been filtered out incorrectly
            // Log detailed comparison to help debug
            missingStudents.forEach(missingId => {
              const normalizedMissing = normalizeStudentId(missingId)
              const similarStudents = studentsWithArchived.filter(s => {
                const studentId = normalizeStudentId(s.id)
                return studentId.includes(normalizedMissing) || normalizedMissing.includes(studentId)
              })
              if (similarStudents.length > 0) {
                console.warn(`  Found similar student IDs for ${missingId}:`, similarStudents.map(s => s.id))
              }
            })
          } else {
            // Log successful matches for debugging
            console.log(`âœ… Subject ${subjectCode}: All ${enrolledIds.length} enrolled students found in students array`)
          }
        })
        
        return true
      } else {
        // Only create defaults if no data exists (first-time user)
        const defaultSubjects = [
          { code: "CCE106 2061", name: "Application Dev", credits: "3" },
          { code: "IT 14 2062", name: "Professional Track", credits: "4" },
          { code: "IT11 2063", name: "Networking II", credits: "5" },
        ]
        const defaultStudents = []
        const defaultEnrolls = {}
        setSubjects(defaultSubjects)
        setStudents(defaultStudents)
        setNormalizedEnrolls(defaultEnrolls)
        setRecords({})
        setGrades({})
        // Save to Firestore with localStorage backup
        await setWithBackup(DASHBOARD_COLLECTION, uid, {
          subjects: defaultSubjects,
          students: defaultStudents,
          enrolls: defaultEnrolls,
          alerts: [],
          records: {},
          grades: {},
          ownerUid: uid,
          updatedAt: new Date().toISOString(),
        })
        console.log('Default dashboard data created for new user')
        return true
      }
    } catch (e) {
      console.error('Failed to load professor dashboard data', e)
      
      // Check if it's a quota error
      if (e.code === 'resource-exhausted' || e.message?.includes('quota') || e.message?.includes('Quota')) {
        console.error('âš ï¸ Firestore quota exceeded!')
        console.error('ðŸ’¡ To reduce quota usage, disable real-time updates:')
        console.error('   localStorage.setItem("disableRealtimeUpdates", "true")')
        console.error('ðŸ’¡ Or upgrade to Blaze plan for higher limits')
        // Note: addCustomAlert may not be available yet during loadData
        // Error will be shown via console and can be handled by UI
      }
      
      return false
    }
  }, [])

  // Debounce save operations to reduce Firestore writes
  const saveDataTimeoutRef = useRef(null)
  const pendingSaveRef = useRef(null)

  const saveData = useCallback(async (subjectsData, studentsData, enrollsData, alertsData, recordsData, gradesData, uidOverride = null, immediate = false) => {
    // Use uidOverride if provided, otherwise use profUid from state,
    // auth.currentUser, or sessionStorage as fallbacks
    let uidToUse = uidOverride || profUid

    if (!uidToUse && auth?.currentUser?.uid) {
      uidToUse = auth.currentUser.uid
    }

    if (!uidToUse) {
      try {
        const currentUser = sessionStorage.getItem('currentUser')
        if (currentUser) {
          const userData = JSON.parse(currentUser)
          uidToUse = userData?.uid
        }
      } catch (e) {
        console.warn('Could not get UID from sessionStorage', e)
      }
    }
    
    if (!uidToUse) {
      const error = new Error('Cannot save data: No UID available')
      console.error(error.message)
      throw error
    }
    
    // CRITICAL: Always use the provided data parameters, never fall back to state
    // State might be stale due to React's asynchronous updates
    const payload = {
      subjects: subjectsData ?? subjects,
      removedSubjects: removedSubjects, // Include removed subjects in save
      students: studentsData ?? students,
      enrolls: enrollsData ?? enrolls,
      alerts: alertsData ?? alerts,
      records: recordsData ?? records,
      grades: gradesData ?? grades,
      ownerUid: uidToUse,
      updatedAt: new Date().toISOString(),
    }
    
    // Store pending save
    pendingSaveRef.current = { payload, uidToUse }
    
    // If immediate save requested (e.g., on critical operations), save right away
    if (immediate) {
      if (saveDataTimeoutRef.current) {
        clearTimeout(saveDataTimeoutRef.current)
        saveDataTimeoutRef.current = null
      }
      const result = await executeSave(payload, uidToUse)
      return result
    }
    
    // Debounce: Clear existing timeout and set new one
    if (saveDataTimeoutRef.current) {
      clearTimeout(saveDataTimeoutRef.current)
    }
    
    // AGGRESSIVE OPTIMIZATION: Save after 10 seconds of no changes (reduces writes by 80%)
    // This prevents excessive writes when user is actively editing
    saveDataTimeoutRef.current = setTimeout(async () => {
      if (pendingSaveRef.current) {
        await executeSave(pendingSaveRef.current.payload, pendingSaveRef.current.uidToUse)
        pendingSaveRef.current = null
      }
      saveDataTimeoutRef.current = null
    }, 10000) // Increased from 2 seconds to 10 seconds
  }, [subjects, removedSubjects, students, enrolls, alerts, records, grades, profUid])

  // Separate function to execute the actual save
  const executeSave = useCallback(async (payload, uidToUse) => {
    try {
      // CRITICAL: Normalize enrollments before saving to ensure consistency
      // This ensures all student IDs are properly formatted and duplicates are removed
      const normalizedPayload = {
        ...payload,
        enrolls: normalizeEnrollsMap(payload.enrolls || {})
      }
      
      // CRITICAL: Verify data integrity before saving
      // Ensure all enrolled students exist in the students array
      const enrollmentStudentIds = new Set()
      Object.values(normalizedPayload.enrolls || {}).forEach(enrolledIds => {
        enrolledIds.forEach(id => enrollmentStudentIds.add(normalizeStudentId(id)))
      })
      const studentIds = new Set((normalizedPayload.students || []).map(s => normalizeStudentId(s.id)))
      const missingStudents = Array.from(enrollmentStudentIds).filter(id => !studentIds.has(id))
      
      if (missingStudents.length > 0) {
        console.error('âŒ CRITICAL: Attempting to save enrollments for students that don\'t exist:', {
          missingStudentIds: missingStudents,
          totalEnrollments: enrollmentStudentIds.size,
          totalStudents: studentIds.size
        })
        // Don't save if there are missing students - this would cause data loss on reload
        throw new Error(`Cannot save: ${missingStudents.length} enrolled students not found in students array`)
      }
      
      // CRITICAL: Save to Firestore with localStorage backup
      // Use setDoc WITHOUT merge to ensure complete data replacement
      // This prevents partial updates that might restore archived students
      // Use forceWrite to bypass deduplication check and ensure data is always saved
      // This is critical for imports where we need to ensure new students are saved
      const success = await setWithBackup(DASHBOARD_COLLECTION, uidToUse, normalizedPayload, { forceWrite: true })
      if (success) {
        console.log('âœ… Data saved successfully to Firestore:', {
        subjects: (normalizedPayload.subjects || []).length,
        students: (normalizedPayload.students || []).length,
        enrolls: Object.keys(normalizedPayload.enrolls || {}).length,
        enrollsDetails: Object.keys(normalizedPayload.enrolls || {}).map(key => ({
          subject: key,
          studentCount: (normalizedPayload.enrolls[key] || []).length,
          studentIds: normalizedPayload.enrolls[key]
        })),
        alerts: (normalizedPayload.alerts || []).length,
        records: Object.keys(normalizedPayload.records || {}).length,
        grades: Object.keys(normalizedPayload.grades || {}).length,
        updatedAt: normalizedPayload.updatedAt,
        dataIntegrity: 'âœ… All enrolled students exist in students array'
      })
      } else {
        console.log('âš ï¸ Data saved to localStorage backup (Firestore unavailable):', {
          subjects: (normalizedPayload.subjects || []).length,
          students: (normalizedPayload.students || []).length,
          enrolls: Object.keys(normalizedPayload.enrolls || {}).length,
          enrollsDetails: Object.keys(normalizedPayload.enrolls || {}).map(key => ({
            subject: key,
            studentCount: (normalizedPayload.enrolls[key] || []).length
          })),
          alerts: (normalizedPayload.alerts || []).length,
          records: Object.keys(normalizedPayload.records || {}).length,
          grades: Object.keys(normalizedPayload.grades || {}).length,
          updatedAt: normalizedPayload.updatedAt,
        })
      }
      return success
    } catch (e) {
      console.error('Failed to save professor dashboard data', e)
      // Check if it's a quota error
      if (e.code === 'resource-exhausted' || e.message?.includes('quota') || e.message?.includes('Quota')) {
        console.error('âš ï¸ Firestore quota exceeded! Please check Firebase Console or wait for daily reset.')
        addCustomAlert('error', 'Quota Exceeded', 'Firestore quota has been exceeded. Data will be saved when quota resets (daily at midnight Pacific Time).', false)
      }
      throw e // Re-throw to allow callers to handle errors
    }
  }, [])
  
  // Helper function to add custom UI alerts (replaces browser alerts)
  const addCustomAlert = useCallback(async (type, title, message, autoSave = true) => {
    // Create notification alert
    const newAlert = {
      id: Date.now(),
      type: type || 'general',
      title: title || 'Notification',
      message: message || '',
      timestamp: new Date(),
      read: false,
      target_courseId: null,
    }
    
    // Add to alerts array (newest first)
    const updatedAlerts = [newAlert, ...alerts]
    setAlerts(updatedAlerts)
    
    // Save to Firestore immediately if autoSave is true
    if (autoSave) {
      try {
        await saveData(subjects, students, enrolls, updatedAlerts, records, grades, profUid, true)
      } catch (error) {
        console.warn('Failed to save notification alert', error)
      }
    }
    
    return newAlert
  }, [alerts, subjects, students, enrolls, records, grades, profUid])

  const waitForAuthUser = useCallback(() => {
    return new Promise((resolve) => {
      if (auth?.currentUser) {
        resolve(auth.currentUser)
        return
      }
      const unsubscribe = watchAuthState((user) => {
        unsubscribe()
        resolve(user || null)
      })
    })
  }, [])

  useEffect(() => {
    const initializeProfessor = async () => {
      let firebaseUser = auth?.currentUser
      if (!firebaseUser) {
        firebaseUser = await waitForAuthUser()
      }

      if (!firebaseUser) {
        navigate('/login')
        return
      }

      let sessionUser = sessionStorage.getItem('currentUser')
      let userData = null
      if (sessionUser) {
        try {
          userData = JSON.parse(sessionUser)
        } catch (error) {
          console.warn('Unable to parse currentUser session data', error)
        }
      }

      if (!userData || userData.uid !== firebaseUser.uid) {
        userData = {
          uid: firebaseUser.uid,
          email: firebaseUser.email || '',
          name: firebaseUser.displayName || 'Professor User',
        }
        sessionStorage.setItem('currentUser', JSON.stringify(userData))
      }

      setProfUid(firebaseUser.uid)
      if (userData.email) setProfEmail(userData.email)
      if (userData.name) {
        setProfName(userData.name)
        setProfileForm(prev => ({ ...prev, name: userData.name }))
      }

      const profilePromise = getProfessorByUid(firebaseUser.uid).catch(err => {
        console.warn('Unable to load professor profile from Firestore', err)
        return null
      })

      const dashboardPromise = loadData(firebaseUser.uid).catch(err => {
        console.error('Failed to load professor dashboard data', err)
        return false
      })

      const profile = await profilePromise
      const dashboardLoaded = await dashboardPromise
      
      if (dashboardLoaded) {
        console.log('Dashboard data loaded successfully from Firestore on page load/refresh')
      } else if (dashboardLoaded === false) {
        console.error('Failed to load dashboard data - data may not persist correctly')
      }

      if (profile) {
        setProfProfile(profile)
        if (profile.email) setProfEmail(profile.email)
        if (profile.name) {
          setProfName(profile.name)
          setProfileForm(prev => ({ ...prev, name: profile.name }))
        }
        if (profile.photoURL) {
          setProfPic(profile.photoURL)
          setProfilePreview(profile.photoURL)
        }
      }
    }

    initializeProfessor()
    
    // Start time update
    const updateTime = () => {
      const now = new Date()
      const hours = now.getHours()
      const h12 = hours % 12 || 12
      const ampm = hours >= 12 ? 'PM' : 'AM'
      const m = now.getMinutes().toString().padStart(2, '0')
      const s = now.getSeconds().toString().padStart(2, '0')
      setCurrentTime(`${h12}:${m}:${s} ${ampm}`)
    }
    updateTime()
    const timeInterval = setInterval(updateTime, 1000)
    
    return () => {
      clearInterval(timeInterval)
      // Cleanup real-time listener
      if (realtimeUnsubscribeRef.current) {
        realtimeUnsubscribeRef.current()
        realtimeUnsubscribeRef.current = null
      }
    }
  }, [navigate, loadData, waitForAuthUser])

  // Set up real-time listener for dashboard updates
  useEffect(() => {
    if (!profUid) return
    
    // Check if real-time updates are disabled
    const isDisabled = localStorage.getItem('disableRealtimeUpdates') === 'true'
    if (isDisabled) {
      // Clean up any existing listener
      if (realtimeUnsubscribeRef.current) {
        realtimeUnsubscribeRef.current()
        realtimeUnsubscribeRef.current = null
      }
      return
    }

    // Store initial data for comparison
    const currentData = {
      subjects,
      students,
      enrolls,
      alerts,
      records,
      grades,
    }
    previousDataRef.current = currentData

    // Set up real-time listener
    const unsubscribe = // subscribeToProfessorDashboard - replaced with polling(profUid, (updatedData) => {
      if (!updatedData) return

      // CRITICAL: Don't overwrite state during import - it causes race conditions
      if (isImportingRef.current) {
        console.log('â¸ï¸ Real-time update skipped during import to prevent overwrite')
        return
      }

      // CRITICAL: Prevent overwriting data immediately after load (within 3 seconds)
      // This prevents the real-time listener from overwriting fresh data on page load
      const timeSinceLoad = Date.now() - (dataLoadTimeRef.current || 0)
      if (timeSinceLoad < 3000) {
        console.log('â¸ï¸ Real-time update skipped: Data just loaded (within 3s)', {
          timeSinceLoad: Math.round(timeSinceLoad / 1000) + 's'
        })
        return
      }

      // CRITICAL: Prevent overwriting with stale data that has fewer enrollments
      // This happens when Firestore hasn't fully propagated the import yet
      // Also check if we just imported data (within last 5 seconds)
      const timeSinceImport = Date.now() - (lastImportTimeRef.current || 0)
      if (timeSinceImport < 5000) {
        console.log('â¸ï¸ Real-time update skipped: Recent import detected (within 5s)', {
          timeSinceImport: Math.round(timeSinceImport / 1000) + 's'
        })
        return
      }
      
      if (updatedData.enrolls && Object.keys(enrolls).length > 0) {
        let hasStaleData = false
        for (const subjectCode in enrolls) {
          const incomingEnrolls = (updatedData.enrolls[subjectCode] || []).map(normalizeStudentId).filter(Boolean)
          const currentEnrolls = (enrolls[subjectCode] || []).map(normalizeStudentId).filter(Boolean)
          // If incoming data has fewer enrollments, it's likely stale
          // Also check if incoming data is missing students that exist in current state
          if (incomingEnrolls.length < currentEnrolls.length) {
            console.log('â¸ï¸ Real-time update skipped: Incoming data appears stale (fewer enrollments)', {
              subject: subjectCode,
              incoming: incomingEnrolls.length,
              current: currentEnrolls.length,
              incomingIds: incomingEnrolls,
              currentIds: currentEnrolls,
              missingStudents: currentEnrolls.filter(id => !incomingEnrolls.includes(id))
            })
            hasStaleData = true
            break
          }
          // Also check if any current students are missing from incoming data
          const missingStudents = currentEnrolls.filter(id => !incomingEnrolls.includes(id))
          if (missingStudents.length > 0 && currentEnrolls.length > 0) {
            console.log('â¸ï¸ Real-time update skipped: Incoming data missing students', {
              subject: subjectCode,
              incoming: incomingEnrolls.length,
              current: currentEnrolls.length,
              missingStudents: missingStudents
            })
            hasStaleData = true
            break
          }
        }
        if (hasStaleData) {
          return
        }
      }

      // OPTIMIZED: Skip date change detection for minimal data (grades not included in real-time)
      // Date changes will be detected on page refresh or manual grade updates
      
      // Update state with new data (this will trigger UI updates)
      // CRITICAL: Always normalize enrollments to ensure consistency
      // NOTE: Real-time updates now only include critical fields (subjects, students, enrolls, alerts)
      // Records and grades are excluded to reduce quota usage - they load on-demand
      if (updatedData.subjects) setSubjects(updatedData.subjects)
      if (updatedData.removedSubjects) setRemovedSubjects(updatedData.removedSubjects)
      if (updatedData.students) setStudents(updatedData.students)
      if (updatedData.enrolls) {
        // Normalize enrollments before setting to ensure consistency
        const normalizedEnrolls = normalizeEnrollsMap(updatedData.enrolls)
        setNormalizedEnrolls(normalizedEnrolls)
        console.log('ðŸ”„ Real-time update: Enrollments normalized and updated', {
          subjects: Object.keys(normalizedEnrolls).length,
          enrollments: Object.keys(normalizedEnrolls).map(key => ({
            subject: key,
            count: normalizedEnrolls[key].length
          }))
        })
      }
      // OPTIMIZED: Normalize alert timestamps when updating from real-time
      if (updatedData.alerts) {
        const normalizedAlerts = updatedData.alerts.map(alert => {
          // Ensure timestamp is properly formatted
          let normalizedTimestamp = alert.timestamp
          
          // Handle Firestore Timestamp objects
          if (normalizedTimestamp && typeof normalizedTimestamp === 'object' && normalizedTimestamp.toDate) {
            normalizedTimestamp = normalizedTimestamp.toDate()
          }
          // Handle ISO strings
          else if (typeof normalizedTimestamp === 'string') {
            const parsed = new Date(normalizedTimestamp)
            normalizedTimestamp = isNaN(parsed.getTime()) ? new Date() : parsed
          }
          // Handle numbers (milliseconds or seconds)
          else if (typeof normalizedTimestamp === 'number') {
            normalizedTimestamp = normalizedTimestamp > 1e12 
              ? new Date(normalizedTimestamp) 
              : new Date(normalizedTimestamp * 1000)
          }
          // Handle Date objects
          else if (normalizedTimestamp instanceof Date) {
            // Already a Date object, keep it
          }
          // Invalid timestamp - use current time
          else {
            normalizedTimestamp = new Date()
          }
          
          // Ensure timestamp is valid
          if (!normalizedTimestamp || isNaN(normalizedTimestamp.getTime())) {
            normalizedTimestamp = new Date()
          }
          
          return {
            ...alert,
            timestamp: normalizedTimestamp
          }
        })
        setAlerts(normalizedAlerts)
      }
      // OPTIMIZED: Records and grades excluded from real-time updates to reduce quota
      // They remain from initial load and update on manual save/refresh
      // This reduces data transfer and quota usage by ~60-70%
      
      // Force UI refresh after real-time update
      setRefreshTrigger(prev => prev + 1)

      // Update previous data reference
      previousDataRef.current = updatedData
    })

    realtimeUnsubscribeRef.current = unsubscribe

    return () => {
      if (realtimeUnsubscribeRef.current) {
        realtimeUnsubscribeRef.current()
        realtimeUnsubscribeRef.current = null
      }
    }
  }, [profUid, subjects, students, enrolls, alerts, records, grades, realtimeUpdatesDisabled])

  // Cleanup: Save any pending data and clear timeout on unmount
  useEffect(() => {
    return () => {
      // Save any pending data before unmounting
      if (pendingSaveRef.current && saveDataTimeoutRef.current) {
        clearTimeout(saveDataTimeoutRef.current)
        executeSave(pendingSaveRef.current.payload, pendingSaveRef.current.uidToUse).catch(err => {
          console.warn('Failed to save pending data on unmount:', err)
        })
      } else if (saveDataTimeoutRef.current) {
        clearTimeout(saveDataTimeoutRef.current)
      }
    }
  }, [executeSave])

  // Close notification dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (showNotifDropdown && !event.target.closest('.relative')) {
        setShowNotifDropdown(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [showNotifDropdown])

  useEffect(() => {
    setStudentDetailSubject(null)
    setSubjectPreviewCode(null)
  }, [viewMode])

  useEffect(() => {
    setStudentDetailSubject(null)
  }, [selectedStudentId])

  useEffect(() => {
    if (viewMode === 'student' && !selectedStudentId && students.length > 0) {
      setSelectedStudentId(students[0].id)
    }
  }, [viewMode, students, selectedStudentId])

  useEffect(() => {
    if (viewMode === 'student' && selectedStudentId) {
      const metrics = getStudentMetrics(selectedStudentId)
      const studentSubjects = getStudentSubjects(selectedStudentId)
      const highlightedSubject = studentSubjects[0]
      const generatedAlerts = [
        {
          id: `attendance-${selectedStudentId}`,
          title: 'Attendance Update',
          message: `You are currently at ${metrics.attendanceRate}% attendance. Keep it up!`,
          timestamp: new Date(),
          read: false,
        },
        {
          id: `grade-${selectedStudentId}`,
          title: 'Grade Highlight',
          message: metrics.averageGrade === '0'
            ? 'Grades will appear here once assessments are recorded.'
            : `Your overall average grade is ${metrics.averageGrade}%.`,
          timestamp: new Date(),
          read: false,
        },
        highlightedSubject
          ? {
              id: `subject-${highlightedSubject.code}`,
              title: `${highlightedSubject.name}`,
              message: `Target grade ${highlightedSubject.targetGrade || 90}% Â· Attendance ${
                getSubjectAttendanceSummary(selectedStudentId, highlightedSubject.code).rate
              }%`,
              timestamp: new Date(),
              read: false,
            }
          : null,
      ].filter(Boolean)
      setStudentAlerts(generatedAlerts)
    } else if (viewMode !== 'student') {
      setStudentAlerts([])
    }
  }, [viewMode, selectedStudentId, subjects, enrolls, records, grades])

  useEffect(() => {
    if (showProfileModal) {
      setProfileForm({ name: profName, pic: null })
      setProfilePreview(profPic)
    }
  }, [showProfileModal, profName, profPic])

  // Deep-link handling: read tab and subjectId from URL on load / change
  useEffect(() => {
    try {
      const params = new URLSearchParams(location.search)
      const tabParam = params.get('tab')
      const subjectIdParam = params.get('subjectId')

      if (tabParam === 'attendance' || tabParam === 'grades' || tabParam === 'students' || tabParam === 'subjects') {
        setActiveTab(tabParam)
      }

      if (subjectIdParam && subjects.length > 0) {
        const findSubjectByCode = (code) => {
          if (!code) return null
          let subject = subjects.find(s => s.code === code)
          if (subject) return subject
          subject = subjects.find(s => s.code?.toLowerCase() === code.toLowerCase())
          if (subject) return subject
          subject = subjects.find(s => s.code?.includes(code) || code.includes(s.code))
          return subject || null
        }
        const subject = findSubjectByCode(subjectIdParam)
        if (subject) {
          setSelectedSubject(subject)
        }
      }
    } catch {
      // ignore malformed URLs
    }
  }, [location.search, subjects])

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (restoreSubjectDropdownRef.current && !restoreSubjectDropdownRef.current.contains(event.target)) {
        setShowRestoreSubjectDropdown(false)
      }
      if (newStudentSubjectDropdownRef.current && !newStudentSubjectDropdownRef.current.contains(event.target)) {
        setShowNewStudentSubjectDropdown(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  // Clear error when Add Subject modal opens
  useEffect(() => {
    if (showAddSubjectModal) {
      setAddSubjectError('')
      setIsSavingSubject(false)
    }
  }, [showAddSubjectModal])

  // Clear error when user types in form fields (only if error exists)
  useEffect(() => {
    if (addSubjectError && (newSubject.code || newSubject.name || newSubject.credits)) {
      setAddSubjectError('')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [newSubject.code, newSubject.name, newSubject.credits])

  // Removed localStorage loadData - using Firestore loadData callback instead

  const executeLogout = async () => {
    // Save all current data to Firestore before logout to ensure data integrity
    if (profUid) {
      try {
        await saveData(subjects, students, enrolls, alerts, records, grades, profUid)
        console.log('All data saved successfully before logout')
      } catch (error) {
        console.error('Failed to save data before logout', error)
        // Still allow logout even if save fails (data will be saved on next change)
      }
    }
    sessionStorage.removeItem('currentUser')
    navigate('/login')
  }

  const handleLogoutClick = () => {
    setShowLogoutModal(true)
  }

  const handleCancelLogout = () => {
    setShowLogoutModal(false)
  }

  const getInitials = (name) => {
    if (!name || name === 'TBA') return 'PU'
    return name.split(/\s+/).filter(Boolean).map(w => w[0]).slice(0, 2).join('').toUpperCase()
  }

  const handleProfilePicSelection = (file) => {
    if (file) {
      setProfileForm(prev => ({ ...prev, pic: file }))
      const reader = new FileReader()
      reader.onload = (evt) => {
        setProfilePreview(evt.target.result)
      }
      reader.readAsDataURL(file)
    } else {
      setProfileForm(prev => ({ ...prev, pic: null }))
      setProfilePreview(profPic)
    }
  }

  const handleAddSubject = async (e) => {
    e.preventDefault()
    
    // Clear any previous errors
    setAddSubjectError('')
    
    // Validate fields
    if (!newSubject.code || !newSubject.name || !newSubject.credits) {
      setAddSubjectError('Please fill in all fields')
      return
    }

    // Check for duplicate subject code
    if (subjects.find(s => s.code === newSubject.code)) {
      setAddSubjectError('A subject with this code already exists. Please use a different code.')
      return
    }

    setIsSavingSubject(true)

    try {
      const updatedSubjects = [...subjects, { ...newSubject }]
      const updatedEnrolls = { ...enrolls, [newSubject.code]: [] }
      
      setSubjects(updatedSubjects)
      setNormalizedEnrolls(updatedEnrolls)
      
      // Add alert
      const newAlert = {
        id: Date.now(),
        type: 'general',
        title: 'Subject Added',
        message: `${newSubject.name} (${newSubject.code}) has been added successfully`,
        timestamp: new Date(),
        read: false,
      }
      const updatedAlerts = [newAlert, ...alerts]
      setAlerts(updatedAlerts)
      
      // Save to Firestore (await to ensure completion before closing modal)
      await saveData(updatedSubjects, students, updatedEnrolls, updatedAlerts, records, grades, profUid)
      
      // Reset form and error state
      setNewSubject({ code: '', name: '', credits: '' })
      setAddSubjectError('')
      setIsSavingSubject(false)
      
      // Automatically transition to Subject Management tab
      // This ensures the Professor sees the newly created subject immediately
      setActiveTab('subjects')
      setShowSubjectDetail(false)
      setSelectedSubject(null)
      
      // Automatically close modal after successful save
      // No manual action required - seamless transition back to dashboard
      setShowAddSubjectModal(false)
    } catch (error) {
      console.error('Failed to save subject to Firestore', error)
      setAddSubjectError('Failed to save subject. Please try again.')
      setIsSavingSubject(false)
      // Modal remains open so user can retry
    }
  }

  const toggleRestoreSubjectSelection = (subjectCode) => {
    setSelectedSubjectsForBulk(prev => {
      if (prev.includes(subjectCode)) {
        return prev.filter(code => code !== subjectCode)
      }
      return [...prev, subjectCode]
    })
  }

  const toggleNewStudentSubjectSelection = (subjectCode) => {
    setNewStudent(prev => {
      const current = prev.subjects || []
      if (current.includes(subjectCode)) {
        return { ...prev, subjects: current.filter(code => code !== subjectCode) }
      }
      return { ...prev, subjects: [...current, subjectCode] }
    })
  }

  const handleDeleteSubject = async (subjectCode, e) => {
    e.stopPropagation()
    const subject = subjects.find(s => s.code === subjectCode)
    if (!subject) return
    
    if (!confirm(`Are you sure you want to delete ${subject.name}? This action cannot be undone.`)) {
      return
    }

    const updatedSubjects = subjects.filter(s => s.code !== subjectCode)
    const updatedRemovedSubjects = [...removedSubjects, subject] // Add to removed subjects
    const updatedEnrolls = { ...enrolls }
    delete updatedEnrolls[subjectCode]
    
    setSubjects(updatedSubjects)
    setRemovedSubjects(updatedRemovedSubjects)
    setNormalizedEnrolls(updatedEnrolls)
    
    const newAlert = {
      id: Date.now(),
      type: 'general',
      title: 'Subject Deleted',
      message: `${subject.name} (${subject.code}) has been deleted`,
      timestamp: new Date(),
      read: false,
    }
    const updatedAlerts = [newAlert, ...alerts]
    setAlerts(updatedAlerts)
    
    // Save to Firestore (await to ensure completion)
    // Note: saveData doesn't accept removedSubjects parameter, so we need to update it
    // For now, we'll save it manually or update saveData signature
    const payload = {
      subjects: updatedSubjects,
      removedSubjects: updatedRemovedSubjects,
      students: students,
      enrolls: updatedEnrolls,
      alerts: updatedAlerts,
      records: records,
      grades: grades,
      ownerUid: profUid,
      updatedAt: new Date().toISOString(),
    }
    
    // Save directly using setWithBackup
    try {
      await setWithBackup(DASHBOARD_COLLECTION, profUid, payload, { forceWrite: true })
    } catch (error) {
      console.error('Failed to save removed subject', error)
    }
    
    if (selectedSubject && selectedSubject.code === subjectCode) {
      setShowSubjectDetail(false)
      setSelectedSubject(null)
    }
  }

  const handleSubjectClick = (subject) => {
    setSelectedSubject(subject)
    setShowSubjectDetail(true)
  }

  const handleBackToSubjects = () => {
    setShowSubjectDetail(false)
    setSelectedSubject(null)
    setCurrentSubject(null)
    if (activeTab !== 'subjects') {
      setActiveTab('subjects')
    }
  }

  const handleTakeAttendance = () => {
    if (selectedSubject) {
      setCurrentSubject(selectedSubject)
      setActiveTab('attendance')
      setShowSubjectDetail(false)
    }
  }

  const handleManageGrades = () => {
    if (selectedSubject) {
      setCurrentSubject(selectedSubject)
      setActiveTab('grades')
      setShowSubjectDetail(false)
    }
  }

  const toggleAttendance = (studentId, status) => {
    if (!currentSubject) return
    
    const date = attendanceDate
    const updatedRecords = { ...records }
    if (!updatedRecords[date]) updatedRecords[date] = {}
    if (!updatedRecords[date][currentSubject.code]) updatedRecords[date][currentSubject.code] = {}
    
    const currentStatus = updatedRecords[date][currentSubject.code][studentId]
    if (currentStatus === status) {
      delete updatedRecords[date][currentSubject.code][studentId]
    } else {
      updatedRecords[date][currentSubject.code][studentId] = status
    }
    
    // Update UI immediately (optimistic update) - NO AWAIT, instant response
    setRecords(updatedRecords)
    
    // Save to Firestore immediately (no debounce for attendance - critical data)
    saveData(subjects, students, enrolls, alerts, updatedRecords, grades, profUid, true).catch(err => 
      console.warn('Background save failed', err)
    )
      
    // Sync attendance to student dashboard in background (non-blocking)
    const student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentId))
    if (student && currentStatus !== status) {
      // Run sync in background - don't block UI
      Promise.resolve().then(async () => {
        try {
          // Verify the numerical Student ID + Email pairing for secure data linking
          const verification = await verifyStudentIdEmailPair(student.id, student.email)
          
          if (verification.verified && verification.uid) {
            await syncStudentAttendance(verification.uid, currentSubject.code, date, status, {
              subjectName: currentSubject.name,
              dateLabel: formattedDate,
            })
          } else {
            // Fallback to direct lookup
            const studentUid = await getStudentUidForSync(student.id, student.email)
            if (studentUid) {
              await syncStudentAttendance(studentUid, currentSubject.code, date, status, {
                subjectName: currentSubject.name,
                dateLabel: formattedDate,
              })
            }
          }
        } catch (error) {
          console.warn('Failed to sync attendance to student dashboard', error)
        }
      }).catch(err => {
        // Silently handle errors - don't interrupt user experience
        console.warn('Background sync error:', err)
      })
    }
  }

  const getAttendanceStatus = (studentId) => {
    if (!currentSubject) return null
    const date = attendanceDate
    return records[date]?.[currentSubject.code]?.[studentId] || null
  }

  const updateAttendanceSummary = () => {
    if (!currentSubject) return { present: 0, absent: 0, total: 0, rate: 0 }
    
    const enrolled = enrolls[currentSubject.code] || []
    const date = attendanceDate
    const attendance = records[date]?.[currentSubject.code] || {}
    
    let present = 0
    let absent = 0
    
    enrolled.forEach(id => {
      const status = attendance[id]
      if (status === 'present') present++
      else if (status === 'absent') absent++
    })
    
    const total = enrolled.length
    const rate = total > 0 ? Math.round((present / total) * 100) : 0
    
    return { present, absent, total, rate }
  }

  const handleSaveAttendance = async () => {
    if (!currentSubject) return
    
    const formattedDate = new Date(attendanceDate).toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
    
    // Sync all attendance records for this date and subject to student dashboards
    const enrolled = enrolls[currentSubject.code] || []
    const date = attendanceDate
    const dateRecords = records[date]?.[currentSubject.code] || {}
    
    // Sync attendance for all students in parallel using verified ID + Email pairing
    const syncPromises = enrolled.map(async (studentId) => {
      const status = dateRecords[studentId]
      if (status) {
        const student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentId))
        if (student) {
          try {
            // Verify the numerical Student ID + Email pairing for secure data linking
            const verification = await verifyStudentIdEmailPair(student.id, student.email)
            
            if (verification.verified && verification.uid) {
              await syncStudentAttendance(verification.uid, currentSubject.code, date, status, {
                subjectName: currentSubject.name,
                dateLabel: formattedDate,
              })
            } else {
              // Fallback to direct lookup
              const studentUid = await getStudentUidForSync(student.id, student.email)
              if (studentUid) {
                await syncStudentAttendance(studentUid, currentSubject.code, date, status, {
                  subjectName: currentSubject.name,
                  dateLabel: formattedDate,
                })
              }
            }
          } catch (error) {
            console.warn(`Failed to sync attendance for student ${studentId}`, error)
          }
        }
      }
    })
    
    // Wait for all syncs to complete
    await Promise.all(syncPromises)
    
    // Count attendance records
    const presentCount = Object.values(dateRecords).filter(s => s === 'present').length
    const absentCount = Object.values(dateRecords).filter(s => s === 'absent').length
    const totalCount = presentCount + absentCount
    
    // Create real-time notification for attendance save
    const newAlert = {
      id: Date.now(),
      type: 'attendance',
      title: 'Attendance Saved',
      message: `Attendance records for ${formattedDate} saved successfully. ${totalCount} student${totalCount === 1 ? '' : 's'} marked (${presentCount} present, ${absentCount} absent).`,
      timestamp: new Date(),
      read: false,
      target_courseId: currentSubject.code,
      subjectCode: currentSubject.code,
    }
    const updatedAlerts = [newAlert, ...alerts]
    setAlerts(updatedAlerts)
    
    // Save to Firestore immediately (critical operation)
    await saveData(subjects, students, enrolls, updatedAlerts, records, grades, profUid, true)
  }

  const handleInitQuickGrade = () => {
    if (!quickGradeTitle || !quickGradeMaxPoints) {
      addCustomAlert('warning', 'Missing Information', 'Please enter a title and max points for the assessment.', false)
      return
    }
    setShowQuickGradeGrid(true)
    const enrolled = enrolls[currentSubject?.code] || []
    const initialScores = {}
    enrolled.forEach(id => {
      initialScores[id] = ''
    })
    setQuickGradeScores(initialScores)
  }

  const handleFillAllGrades = () => {
    const score = prompt('Enter the score to apply to all students:')
    if (score !== null && !isNaN(score)) {
      const enrolled = enrolls[currentSubject?.code] || []
      const updatedScores = { ...quickGradeScores }
      enrolled.forEach(id => {
        updatedScores[id] = score
      })
      setQuickGradeScores(updatedScores)
    }
  }

  const handleSaveAllGrades = async () => {
    if (!currentSubject) return
    
    const enrolled = enrolls[currentSubject.code] || []
    if (enrolled.length === 0) {
      addCustomAlert('warning', 'No Students', 'No students enrolled in this subject.', false)
      return
    }
    
    const maxPoints = parseFloat(quickGradeMaxPoints)
    if (isNaN(maxPoints) || maxPoints <= 0) {
      addCustomAlert('error', 'Invalid Input', 'Please enter a valid max points value.', false)
      return
    }
    
    const assessment = {
      type: quickGradeType,
      title: quickGradeTitle,
      maxPoints: maxPoints,
      scores: {},
      dueDate: quickGradeDueDate || null, // Store due date if provided
    }
    
    let allScoresValid = true
    enrolled.forEach(studentId => {
      const score = parseFloat(quickGradeScores[studentId])
      if (!isNaN(score) && score <= maxPoints && score >= 0) {
        assessment.scores[studentId] = score
      } else if (quickGradeScores[studentId] !== '') {
        allScoresValid = false
      }
    })
    
    if (!allScoresValid) {
      addCustomAlert('error', 'Invalid Scores', 'Some entered scores are invalid. Please check the scores and try again.', false)
      return
    }
    
    const updatedGrades = { ...grades }
    if (!updatedGrades[currentSubject.code]) updatedGrades[currentSubject.code] = {}
    if (!updatedGrades[currentSubject.code][quickGradeType]) updatedGrades[currentSubject.code][quickGradeType] = []
    
    updatedGrades[currentSubject.code][quickGradeType].push(assessment)
    setGrades(updatedGrades)
    
    // Sync grades to each student's dashboard using verified ID + Email pairing
    for (const studentId of enrolled) {
      const student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentId))
      if (student && assessment.scores[studentId] !== undefined) {
        try {
          // Verify the numerical Student ID + Email pairing for secure data linking
          const verification = await verifyStudentIdEmailPair(student.id, student.email)
          
          if (verification.verified && verification.uid) {
            await syncStudentGrade(
              verification.uid,
              currentSubject.code,
              quickGradeType,
              quickGradeTitle,
              assessment.scores[studentId],
              maxPoints,
              { subjectName: currentSubject.name }
            )
          } else {
            // Fallback to direct lookup
            const studentUid = await getStudentUidForSync(student.id, student.email)
            if (studentUid) {
              await syncStudentGrade(
                studentUid,
                currentSubject.code,
                quickGradeType,
                quickGradeTitle,
                assessment.scores[studentId],
                maxPoints,
                { subjectName: currentSubject.name }
              )
            }
          }
        } catch (error) {
          console.warn(`Failed to sync grade for student ${studentId}`, error)
        }
      }
    }
    
    // Count students with grades
    const studentsWithGrades = Object.keys(assessment.scores).length
    
    const newAlert = {
      id: Date.now(),
      type: 'grade',
      title: 'Grade Posted',
      message: `Grade Posted: ${quickGradeTitle} grades for ${currentSubject.name} are now available to ${studentsWithGrades} student${studentsWithGrades === 1 ? '' : 's'}.`,
      timestamp: new Date(),
      read: false,
      target_courseId: currentSubject.code,
      subjectCode: currentSubject.code,
    }
    const updatedAlerts = [newAlert, ...alerts]
    setAlerts(updatedAlerts)
    
    // Save to Firestore immediately (critical operation)
    await saveData(subjects, students, enrolls, updatedAlerts, records, updatedGrades, profUid, true)
    
    // Reset form
    setQuickGradeTitle('')
    setQuickGradeMaxPoints('')
    setQuickGradeDueDate('')
    setQuickGradeScores({})
    setShowQuickGradeGrid(false)
    
    addCustomAlert('success', 'Grades Saved', `Grades saved successfully for ${quickGradeTitle}`, false)
  }

  const exportGradesCSV = () => {
    if (!currentSubject) {
      addCustomAlert('warning', 'No Subject Selected', 'Please select a subject to export grades.', false)
      return
    }

    const subjectGrades = grades[currentSubject.code]
    if (!subjectGrades || Object.keys(subjectGrades).length === 0) {
      addCustomAlert('info', 'No Grades', 'No grades recorded for this subject yet.', false)
      return
    }

    const rows = [['Assessment', 'Type', 'Student ID', 'Student Name', 'Score', 'Max Points']]

    Object.entries(subjectGrades).forEach(([type, assessments]) => {
      assessments.forEach(assessment => {
        const assessmentName = assessment.title || `${type} Assessment`
        const displayType = type.charAt(0).toUpperCase() + type.slice(1)
        Object.entries(assessment.scores || {}).forEach(([studentId, score]) => {
          const student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentId))
          rows.push([
            assessmentName,
            displayType,
            studentId,
            student ? student.name : 'Unknown Student',
            score,
            assessment.maxPoints,
          ])
        })
      })
    })

    if (rows.length === 1) {
      addCustomAlert('info', 'No Data', 'No grade entries to export yet.', false)
      return
    }

    const csvContent = rows
      .map(row => row.map(value => `"${String(value ?? '').replace(/"/g, '""')}"`).join(','))
      .join('\n')

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    const safeSubject = currentSubject.code.replace(/[^a-z0-9]/gi, '_')
    link.download = `grades_${safeSubject}.csv`
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)
  }

  const getCurrentDate = () => {
    const now = new Date()
    return now.toLocaleDateString(undefined, {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  }

  const getDateDisplay = () => {
    const today = new Date().toISOString().slice(0, 10)
    const yesterday = new Date()
    yesterday.setDate(yesterday.getDate() - 1)
    const yest = yesterday.toISOString().slice(0, 10)
    
    if (attendanceDate === today) return 'Selected: Today'
    if (attendanceDate === yest) return 'Selected: Yesterday'
    const date = new Date(attendanceDate)
    return `Selected: ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
  }

  const getStudentSubjects = (studentId) => {
    if (!studentId) return []
    return subjects.filter(subject => (enrolls[subject.code] || []).includes(studentId))
  }

  const getStudentMetrics = (studentId) => {
    const defaults = {
      examsTaken: 0,
      examsAvailable: 0,
      attendanceRate: 0,
      averageGrade: '0',
      totalAbsences: 0,
    }
    if (!studentId) return defaults

    const studentSubjects = getStudentSubjects(studentId)
    const subjectCodes = new Set(studentSubjects.map(subject => subject.code))

    let examsTaken = 0
    let examsAvailable = 0
    let totalScore = 0
    let totalMax = 0
    let totalSessions = 0
    let presentSessions = 0
    let absentSessions = 0

    studentSubjects.forEach(subject => {
      const subjectGrades = grades[subject.code] || {}
      Object.values(subjectGrades).forEach(assessments => {
        assessments.forEach(assessment => {
          examsAvailable++
          if (assessment.scores && assessment.scores[studentId] !== undefined) {
            examsTaken++
            totalScore += assessment.scores[studentId]
            totalMax += assessment.maxPoints
          }
        })
      })
    })

    Object.keys(records).forEach(date => {
      const subjectsMap = records[date] || {}
      Object.keys(subjectsMap).forEach(code => {
        if (!subjectCodes.has(code)) return
        const status = subjectsMap[code]?.[studentId]
        if (status) {
          totalSessions++
          if (status === 'present') presentSessions++
          if (status === 'absent') absentSessions++
        }
      })
    })

    const attendanceRate = totalSessions > 0 ? Math.round((presentSessions / totalSessions) * 100) : 0
    // Format percentage as integer (e.g., 1.0 â†’ 100, 0.85 â†’ 85)
    const averageGrade = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0

    return {
      examsTaken,
      examsAvailable,
      attendanceRate,
      averageGrade,
      totalAbsences: absentSessions,
    }
  }

  const getExamBreakdown = (studentId) => {
    if (!studentId) return {}
    
    const studentSubjects = getStudentSubjects(studentId)
    const breakdown = {}
    
    studentSubjects.forEach(subject => {
      const subjectGrades = grades[subject.code] || {}
      Object.entries(subjectGrades).forEach(([assessmentType, assessments]) => {
        const typeKey = assessmentType.charAt(0).toUpperCase() + assessmentType.slice(1) + ' Exam'
        if (!breakdown[typeKey]) {
          breakdown[typeKey] = { taken: 0, available: 0 }
        }
        
        assessments.forEach(assessment => {
          breakdown[typeKey].available++
          if (assessment.scores && assessment.scores[studentId] !== undefined) {
            breakdown[typeKey].taken++
          }
        })
      })
    })
    
    return breakdown
  }

  const getSubjectGradeSummary = (studentId, subjectCode) => {
    const subjectGrades = grades[subjectCode] || {}
    let completed = 0
    let total = 0
    let totalScore = 0
    let totalMax = 0

    Object.values(subjectGrades).forEach(assessments => {
      assessments.forEach(assessment => {
        total++
        if (assessment.scores && assessment.scores[studentId] !== undefined) {
          completed++
          totalScore += assessment.scores[studentId]
          totalMax += assessment.maxPoints
        }
      })
    })

    return {
      completed,
      total,
      average: totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 'N/A',
    }
  }

  const getSubjectAttendanceSummary = (studentId, subjectCode) => {
    let present = 0
    let total = 0
    let absent = 0

    Object.keys(records).forEach(date => {
      const status = records[date]?.[subjectCode]?.[studentId]
      if (status) {
        total++
        if (status === 'present') present++
        if (status === 'absent') absent++
      }
    })

    return {
      present,
      total,
      absent,
      rate: total > 0 ? Math.round((present / total) * 100) : 0,
    }
  }

  const getSubjectAssessmentsForStudent = (studentId, subjectCode) => {
    const subjectGrades = grades[subjectCode] || {}
    const rows = []

    Object.entries(subjectGrades).forEach(([type, assessments]) => {
      assessments.forEach((assessment, index) => {
        rows.push({
          title: assessment.title || `${type} ${index + 1}`,
          type,
          score: assessment.scores?.[studentId],
          maxPoints: assessment.maxPoints,
        })
      })
    })

    return rows
  }

  const getAttendanceHistoryForStudent = (studentId, subjectCode) => {
    const entries = []
    Object.keys(records)
      .sort()
      .forEach(date => {
        const status = records[date]?.[subjectCode]?.[studentId]
        if (status) {
          entries.push({ date, status })
        }
      })
    return entries.sort((a, b) => new Date(b.date) - new Date(a.date))
  }

  // Get absences breakdown by subject
  const getAbsencesBreakdown = (studentId) => {
    if (!studentId) return []
    const studentSubjects = getStudentSubjects(studentId)
    const breakdown = []
    
    studentSubjects.forEach(subject => {
      const attendanceSummary = getSubjectAttendanceSummary(studentId, subject.code)
      if (attendanceSummary.absent > 0) {
        breakdown.push({
          subject: subject.name,
          code: subject.code,
          absences: attendanceSummary.absent,
          total: attendanceSummary.total,
        })
      }
    })
    
    return breakdown.sort((a, b) => b.absences - a.absences)
  }

  // Get attendance breakdown by subject
  const getAttendanceBreakdown = (studentId) => {
    if (!studentId) return []
    const studentSubjects = getStudentSubjects(studentId)
    const breakdown = []
    
    studentSubjects.forEach(subject => {
      const attendanceSummary = getSubjectAttendanceSummary(studentId, subject.code)
      if (attendanceSummary.total > 0) {
        breakdown.push({
          subject: subject.name,
          code: subject.code,
          present: attendanceSummary.present,
          absent: attendanceSummary.absent,
          total: attendanceSummary.total,
          rate: attendanceSummary.rate,
        })
      }
    })
    
    return breakdown.sort((a, b) => b.rate - a.rate)
  }

  // Get grade breakdown by subject
  const getGradeBreakdown = (studentId) => {
    if (!studentId) return []
    const studentSubjects = getStudentSubjects(studentId)
    const breakdown = []
    
    studentSubjects.forEach(subject => {
      const gradeSummary = getSubjectGradeSummary(studentId, subject.code)
      if (gradeSummary.total > 0) {
        breakdown.push({
          subject: subject.name,
          code: subject.code,
          completed: gradeSummary.completed,
          total: gradeSummary.total,
          average: gradeSummary.average,
        })
      }
    })
    
    return breakdown.sort((a, b) => {
      const avgA = parseFloat(a.average) || 0
      const avgB = parseFloat(b.average) || 0
      return avgB - avgA
    })
  }

  const getAttendanceDots = (rate) => {
    const totalDots = 5
    const filled = Math.round((rate / 100) * totalDots)
    return Array.from({ length: totalDots }).map((_, idx) => (
      <span
        key={idx}
        className={`w-2 h-2 rounded-full ${idx < filled ? 'bg-emerald-500' : 'bg-slate-300'}`}
      />
    ))
  }

  const getSubjectAggregateStats = (subjectCode) => {
    const studentIds = enrolls[subjectCode] || []
    const gradeAverages = studentIds
      .map(id => {
        const summary = getSubjectGradeSummary(id, subjectCode)
        return summary.average === 'N/A' ? null : parseFloat(summary.average)
      })
      .filter(value => value !== null)

    const averageGrade =
      gradeAverages.length > 0
        ? Math.round(gradeAverages.reduce((sum, val) => sum + val, 0) / gradeAverages.length)
        : '0'

    let presentSessions = 0
    let totalSessions = 0
    Object.keys(records).forEach(date => {
      const subjectRecords = records[date]?.[subjectCode] || {}
      studentIds.forEach(id => {
        const status = subjectRecords[id]
        if (status) {
          totalSessions++
          if (status === 'present') presentSessions++
        }
      })
    })

    const attendanceRate = totalSessions > 0 ? Math.round((presentSessions / totalSessions) * 100) : 0

    return {
      totalStudents: studentIds.length,
      averageGrade,
      attendanceRate,
    }
  }

  // Get all removed subjects (subjects that were deleted from Subject Management)
  const getArchivedSubjects = () => {
    // Return subjects from removedSubjects array
    return removedSubjects || []
  }

  const renderStudentView = () => {
    const studentSubjects = selectedStudentId ? getStudentSubjects(selectedStudentId) : []
    const currentStudent = students.find(student => student.id === selectedStudentId)
    const metrics = getStudentMetrics(selectedStudentId)
    const detailSubject = studentDetailSubject
      ? subjects.find(subject => subject.code === studentDetailSubject)
      : null
    const detailAssessments =
      detailSubject && selectedStudentId
        ? getSubjectAssessmentsForStudent(selectedStudentId, detailSubject.code)
        : []
    const attendanceHistory =
      detailSubject && selectedStudentId
        ? getAttendanceHistoryForStudent(selectedStudentId, detailSubject.code)
        : []

    const previewSubject = subjectPreviewCode
      ? subjects.find(subject => subject.code === subjectPreviewCode)
      : null
    const previewStudents = previewSubject
      ? (enrolls[previewSubject.code] || []).map(id => students.find(student => student.id === id)).filter(Boolean)
      : []
    const previewStats = previewSubject ? getSubjectAggregateStats(previewSubject.code) : null

    return (
      <div className="fadeIn space-y-8">
        <div className={`glass rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 ${
          isDarkMode ? 'bg-[#1a1a1a]' : ''
        }`}>
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4 sm:mb-6">
            <div>
              <h3 className={`text-lg sm:text-xl font-bold ${
                isDarkMode ? 'text-white' : 'text-slate-800'
              }`}>Subjects</h3>
              <p className={`mt-1 ${
                isDarkMode ? 'text-slate-300' : 'text-slate-600'
              }`}>Browse all subjects and view enrollment details</p>
            </div>
            {previewSubject && (
              <button
                onClick={() => setSubjectPreviewCode(null)}
                className={`text-sm font-semibold transition-colors ${
                  isDarkMode 
                    ? 'text-red-400 hover:text-red-300' 
                    : 'text-red-500 hover:text-red-700'
                }`}
              >
                Close Preview
              </button>
            )}
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {subjects.map(subject => {
              const enrolledCount = enrolls[subject.code]?.length || 0
              const isActive = subjectPreviewCode === subject.code
              return (
                <button
                  key={`preview-${subject.code}`}
                  onClick={() => setSubjectPreviewCode(subject.code)}
                  className={`text-left glass card shadowLg p-4 sm:p-6 rounded-2xl transition-all w-full ${
                    isDarkMode
                      ? 'bg-[#2c2c2c] border border-slate-700'
                      : ''
                  } ${
                    isActive ? 'ring-2 ring-maroon-500' : 'hover:translate-y-[-2px]'
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div>
                      <h4 className={`text-lg font-bold ${
                        isDarkMode ? 'text-[#7A1315]' : 'text-slate-800'
                      }`}>{subject.name}</h4>
                      <p className={`text-sm mt-1 ${
                        isDarkMode ? 'text-white' : 'text-slate-500'
                      }`}>
                        {subject.code} â€¢ {subject.credits} Credits
                      </p>
                    </div>
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${
                      isDarkMode 
                        ? 'bg-[#7A1315]/30' 
                        : 'bg-red-100'
                    }`}>
                      <svg className={`w-5 h-5 ${
                        isDarkMode ? 'text-[#7A1315]' : 'text-[#7A1315]'
                      }`} fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" />
                      </svg>
                    </div>
                  </div>
                  <p className={`text-sm mt-4 ${
                    isDarkMode ? 'text-white' : 'text-slate-500'
                  }`}>
                    {enrolledCount} {enrolledCount === 1 ? 'student' : 'students'} enrolled
                  </p>
                  <p className={`text-xs mt-1 transition-colors ${
                    isDarkMode 
                        ? 'text-slate-400 hover:text-red-300' 
                      : 'text-slate-400 hover:text-[#7A1315]'
                  }`}>Click to view student records</p>
                </button>
              )
            })}
            {subjects.length === 0 && (
              <div className="col-span-full text-center text-slate-500 py-12">
                No subjects available yet.
              </div>
            )}
          </div>
        </div>

        {previewSubject && (
          <div className={`glass rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 space-y-4 sm:space-y-6 ${
            isDarkMode ? 'bg-[#1a1a1a]' : ''
          }`}>
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold ${
                  isDarkMode ? 'text-[#7A1315]' : 'textGrad'
                }`}>{previewSubject.name}</h3>
                <p className={`mt-1 ${
                  isDarkMode ? 'text-white' : 'text-slate-600'
                }`}>
                  {previewSubject.code} â€¢ {previewSubject.credits} Credits
                </p>
              </div>
              <span className={`text-sm ${
                isDarkMode ? 'text-white' : 'text-slate-500'
              }`}>
                {previewStudents.length} {previewStudents.length === 1 ? 'student' : 'students'} enrolled
              </span>
            </div>
            {previewStats && (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className={`p-4 rounded-2xl border ${
                  isDarkMode
                    ? 'border-slate-700 bg-[#2c2c2c]'
                    : 'border-slate-200 bg-white/80'
                }`}>
                  <p className={`text-xs uppercase tracking-wide ${
                    isDarkMode ? 'text-slate-400' : 'text-slate-500'
                  }`}>Total Students</p>
                  <p className={`text-3xl font-bold mt-1 ${
                    isDarkMode ? 'text-white' : 'text-slate-800'
                  }`}>{previewStats.totalStudents}</p>
                </div>
                <div className={`p-4 rounded-2xl border ${
                  isDarkMode
                    ? 'border-slate-700 bg-[#2c2c2c]'
                    : 'border-slate-200 bg-white/80'
                }`}>
                  <p className={`text-xs uppercase tracking-wide ${
                    isDarkMode ? 'text-slate-400' : 'text-slate-500'
                  }`}>Avg Grade</p>
                  <p className={`text-3xl font-bold mt-1 ${
                    isDarkMode ? 'text-white' : 'text-amber-600'
                  }`}>{previewStats.averageGrade}%</p>
                </div>
                <div className={`p-4 rounded-2xl border ${
                  isDarkMode
                    ? 'border-slate-700 bg-[#2c2c2c]'
                    : 'border-slate-200 bg-white/80'
                }`}>
                  <p className={`text-xs uppercase tracking-wide ${
                    isDarkMode ? 'text-slate-400' : 'text-slate-500'
                  }`}>Attendance Rate</p>
                  <p className={`text-3xl font-bold mt-1 ${
                    isDarkMode ? 'text-white' : 'text-emerald-600'
                  }`}>{previewStats.attendanceRate}%</p>
                </div>
              </div>
            )}
            <div className="space-y-3">
              <h4 className={`text-lg font-semibold ${
                isDarkMode ? 'text-white' : 'text-slate-800'
              }`}>Enrolled Students</h4>
              {previewStudents.length > 0 ? (
                <div className={`divide-y rounded-2xl border overflow-hidden ${
                  isDarkMode
                    ? 'divide-slate-700 border-slate-700'
                    : 'divide-slate-200 border-slate-200'
                }`}>
                  {previewStudents.map(student => (
                    <div key={student.id} className={`flex items-center justify-between px-4 py-3 ${
                      isDarkMode ? 'bg-[#2c2c2c]' : 'bg-white/80'
                    }`}>
                      <div>
                        <p className={`font-semibold ${
                          isDarkMode ? 'text-white' : 'text-slate-800'
                        }`}>{student.name}</p>
                        <p className={`text-xs ${
                          isDarkMode ? 'text-slate-400' : 'text-slate-500'
                        }`}>ID: {student.id}</p>
                      </div>
                      <button
                        onClick={() => {
                          setSelectedStudentId(student.id)
                          setStudentDetailSubject(previewSubject.code)
                          setSubjectPreviewCode(null)
                        }}
                        className={`text-sm font-semibold transition-colors ${
                          isDarkMode 
                              ? 'text-red-400 hover:text-red-300' 
                            : 'text-[#7A1315] hover:text-red-800'
                        }`}
                      >
                        View Record
                      </button>
                    </div>
                  ))}
                </div>
              ) : (
                <div className={`p-4 rounded-xl text-sm ${
                  isDarkMode 
                    ? 'bg-[#2c2c2c] text-slate-400' 
                    : 'bg-slate-50 text-slate-500'
                }`}>No students enrolled yet.</div>
              )}
            </div>
          </div>
        )}

        {selectedStudentId && (
          <>
            {detailSubject && (
              <div className={`glass rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 space-y-4 sm:space-y-6 ${
                isDarkMode ? 'bg-[#1a1a1a]' : ''
              }`}>
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                  <div>
                    <h3 className={`text-xl sm:text-2xl font-bold ${
                      isDarkMode ? 'text-[#7A1315]' : 'textGrad'
                    }`}>{detailSubject.name}</h3>
                    <p className={`mt-1 ${
                      isDarkMode ? 'text-white' : 'text-slate-600'
                    }`}>
                      {detailSubject.code} â€¢ {detailSubject.credits} Credits
                    </p>
                  </div>
                  <button
                    onClick={() => setStudentDetailSubject(null)}
                    className={`text-sm font-semibold transition-colors ${
                      isDarkMode 
                        ? 'text-red-400 hover:text-red-300' 
                        : 'text-red-500 hover:text-red-700'
                    }`}
                  >
                    Close Detail
                  </button>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                  <div>
                    <h4 className={`text-lg font-semibold mb-3 ${
                      isDarkMode ? 'text-white' : 'text-slate-800'
                    }`}>Assessment Scores</h4>
                    {detailAssessments.length > 0 ? (
                      <div className={`overflow-hidden rounded-xl border ${
                        isDarkMode ? 'border-slate-700' : 'border-slate-200'
                      }`}>
                        <table className="min-w-full text-sm">
                          <thead className={`uppercase tracking-wide ${
                            isDarkMode 
                              ? 'bg-[#7A1315] text-white' 
                              : 'bg-[#7A1315] text-white'
                          }`}>
                            <tr>
                              <th className="px-4 py-3 text-left">Assessment</th>
                              <th className="px-4 py-3 text-left">Type</th>
                              <th className="px-4 py-3 text-right">Score</th>
                            </tr>
                          </thead>
                          <tbody>
                            {detailAssessments.map((assessment, idx) => (
                              <tr key={`${assessment.title}-${idx}`} className={`border-t ${
                                isDarkMode 
                                  ? idx % 2 === 0 ? 'bg-[#2c2c2c]' : 'bg-[#1a1a1a]'
                                  : ''
                              }`}>
                                <td className={`px-4 py-3 font-medium ${
                                  isDarkMode ? 'text-white' : 'text-slate-700'
                                }`}>{assessment.title}</td>
                                <td className={`px-4 py-3 capitalize ${
                                  isDarkMode ? 'text-slate-300' : 'text-slate-500'
                                }`}>{assessment.type}</td>
                                <td className={`px-4 py-3 text-right ${
                                  isDarkMode ? 'text-white' : 'text-slate-700'
                                }`}>
                                  {assessment.score !== undefined ? `${assessment.score}/${assessment.maxPoints}` : 'â€”'}
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className={`p-4 rounded-xl text-sm ${
                        isDarkMode 
                          ? 'bg-[#2c2c2c] text-slate-400' 
                          : 'bg-slate-50 text-slate-500'
                      }`}>
                        No assessments recorded yet for this student.
                      </div>
                    )}
                  </div>
                  <div>
                    <h4 className={`text-lg font-semibold mb-3 ${
                      isDarkMode ? 'text-white' : 'text-slate-800'
                    }`}>Attendance History</h4>
                    {attendanceHistory.length > 0 ? (
                      <div className="space-y-3 max-h-72 overflow-y-auto">
                        {attendanceHistory.map(entry => (
                          <div
                            key={`${entry.date}-${entry.status}`}
                            className={`flex items-center justify-between rounded-xl px-4 py-3 ${
                              isDarkMode ? 'bg-[#2c2c2c]' : 'bg-slate-50'
                            }`}
                          >
                            <div>
                              <p className={`font-semibold ${
                                isDarkMode ? 'text-white' : 'text-slate-700'
                              }`}>
                                {new Date(entry.date).toLocaleDateString('en-US', {
                                  month: 'long',
                                  day: 'numeric',
                                })}
                              </p>
                              <p className={`text-xs ${
                                isDarkMode ? 'text-slate-400' : 'text-slate-500'
                              }`}>{entry.date}</p>
                            </div>
                            <span
                              className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                entry.status === 'present'
                                  ? isDarkMode
                                    ? 'bg-emerald-900/50 text-emerald-300'
                                    : 'bg-emerald-100 text-emerald-700'
                                  : isDarkMode
                                    ? 'bg-red-900/50 text-red-300'
                                    : 'bg-red-100 text-red-700'
                              }`}
                            >
                              {entry.status === 'present' ? 'Present' : 'Absent'}
                            </span>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className={`p-4 rounded-xl text-sm ${
                        isDarkMode 
                          ? 'bg-[#2c2c2c] text-slate-400' 
                          : 'bg-slate-50 text-slate-500'
                      }`}>
                        No attendance records yet for this subject.
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </>
        )}
      </div>
    )
  }

  const handleAddStudent = async () => {
    if (!newStudent.id || !newStudent.name) {
      addCustomAlert('warning', 'Missing Information', 'Please complete Student ID and Name fields.', false)
      return
    }
    
    // Validate Student ID is numerical (reject legacy S101, S102 format)
    if (!isValidNumericalStudentId(newStudent.id)) {
      addCustomAlert('error', 'Invalid Student ID', 'Student ID must be numerical only (e.g., 141715, 142177). Legacy IDs like S101, S102 are no longer supported.', false)
      return
    }

    // Additional check: reject any legacy format IDs
    if (/^S\d+$/i.test(newStudent.id)) {
      addCustomAlert('error', 'Invalid Student ID Format', 'Legacy student ID format (S101, S102, etc.) is no longer supported. Please use numerical IDs only (e.g., 141715, 142177).', false)
      return
    }
    
    // Auto-generate email if not provided
    let studentEmail = newStudent.email
    if (!studentEmail || !/.+@.+\..+/.test(studentEmail)) {
      studentEmail = generateStudentEmail(newStudent.name, normalizedId)
    }
    
    const normalizedId = normalizeStudentId(newStudent.id)
    // STRICT INTEGRITY CHECK: Use normalized Student ID as the sole unique key
    const existingById = students.find(s => normalizeStudentId(s.id) === normalizedId)
    
    // Declare variables for student and updated students list
    let studentToUse
    let updatedStudents
    
    // Duplication Prevention: Check for ID conflict with different name
    if (existingById) {
      // If student exists with same ID but different name, flag error
      if (existingById.name.trim().toLowerCase() !== newStudent.name.trim().toLowerCase()) {
        addCustomAlert('error', 'Data Integrity Error', `Student ID ${normalizedId} already exists with a different name:\n\nExisting: ${existingById.name}\nNew: ${newStudent.name}\n\nStudent ID must be unique. Please verify the Student ID or use the existing student record.`, false)
        return
      }
      // Same ID and same name (case-insensitive) - update existing record
      studentToUse = {
        ...existingById,
        id: normalizedId,
        name: newStudent.name || existingById.name,
        email: studentEmail || existingById.email
      }
      updatedStudents = students.map(s => normalizeStudentId(s.id) === normalizedId ? studentToUse : s)
      setStudents(updatedStudents)
    } else {
      // New student - add to list with empty archivedSubjects array
      studentToUse = { id: normalizedId, name: newStudent.name, email: studentEmail, archivedSubjects: [] }
      updatedStudents = [...students, studentToUse]
      setStudents(updatedStudents)
      // IMMEDIATE AVAILABILITY: State is updated, so student appears in all dropdowns immediately
    }

    // Enroll in selected subjects
    const updatedEnrolls = { ...enrolls }
    newStudent.subjects.forEach(subjectCode => {
      if (!updatedEnrolls[subjectCode]) {
        updatedEnrolls[subjectCode] = []
      }
      if (!updatedEnrolls[subjectCode].includes(studentToUse.id)) {
        updatedEnrolls[subjectCode] = [
          ...updatedEnrolls[subjectCode],
          studentToUse.id
        ]
      }
    })
    setNormalizedEnrolls(updatedEnrolls)

    // Phase 2: Multi-part write to normalized collections
    // A. Create/update user in users collection (via students collection)
    // B. Create enrollments in enrollments collection
    try {
      // Verify the numerical Student ID + Email pairing to get the correct Firebase Auth UID
      const verification = await verifyStudentIdEmailPair(studentToUse.id, studentToUse.email)
      let studentUid = verification.verified ? verification.uid : null
      
      if (!studentUid) {
        // Fallback to direct lookup
        const studentDoc = await getStudentByNumericalId(studentToUse.id)
        studentUid = studentDoc?.id
      }

        if (studentUid) {
        // A. Ensure student exists in users/students collection
        await setStudent(studentUid, {
          name: studentToUse.name,
          email: studentEmail,
          studentId: studentToUse.id,
          role: 'Student',
        })
        console.log(`âœ… Student profile created/updated in users collection: ${studentUid}`)

        // B. Create enrollments for each selected subject
        for (const subjectCode of newStudent.subjects) {
          const subject = subjects.find(s => s.code === subjectCode)
          if (!subject) continue

          // Get or create course in courses collection
          let course = await getCourseByCode(subjectCode)
          if (!course) {
            // Create course if it doesn't exist
            const courseId = await createCourse({
              code: subject.code,
              name: subject.name,
              credits: subject.credits || '0',
              professorId: profUid,
            })
            course = { id: courseId, ...subject }
            console.log(`âœ… Created course: ${subject.name} (${subjectCode})`)
          }

          // Check if enrollment already exists
          const existingEnrollment = await getEnrollmentByStudentAndCourse(studentUid, course.id)
          if (!existingEnrollment) {
            await createEnrollment(studentUid, course.id)
            console.log(`âœ… Created enrollment: Student ${studentToUse.id} â†’ Course ${subjectCode}`)
          }
        }

        // Legacy: Also sync to student dashboard (for backward compatibility)
          const enrolledSubjects = newStudent.subjects.map(code => {
            const subject = subjects.find(s => s.code === code)
            return subject || { code, name: code }
          })
          await syncStudentSubjects(studentUid, enrolledSubjects)
        console.log(`âœ… Legacy sync: Updated student dashboard for ${studentToUse.id}`)
        } else {
        console.warn(`âš ï¸ Could not find/create student UID for ${studentToUse.id}. Student may need to sign up first.`)
      }
    } catch (error) {
      console.error('âŒ Error in multi-part write (users + enrollments):', error)
      // Continue with legacy flow even if new system fails
    }

    const enrolledCount = newStudent.subjects.length
    const wasExisting = existingById
    const msg = wasExisting
      ? `${studentToUse.name} (${studentToUse.id}) has been updated and enrolled in ${enrolledCount} subject(s)`
      : `${studentToUse.name} (${studentToUse.id}) has been registered successfully${
          enrolledCount > 0 ? ' and enrolled in ' + enrolledCount + ' subject(s)' : ''
        }`
    
    const newAlert = {
      id: Date.now(),
      type: 'general',
      title: 'Student Added',
      message: msg,
      timestamp: new Date(),
      read: false,
      studentId: studentToUse.id,
      subjectCodes: [...newStudent.subjects],
      target_courseId: newStudent.subjects[0] || null,
    }
    const updatedAlerts = [newAlert, ...alerts]
    setAlerts(updatedAlerts)
    
    // Save to Firestore immediately (critical operation - real-time notification)
    await saveData(subjects, updatedStudents, updatedEnrolls, updatedAlerts, records, grades, profUid, true)

    setShowAddStudentModal(false)
    setNewStudent({ id: '', name: '', email: '', subjects: [] })
  }

  const handleAddStudentToSubject = async () => {
    if (!selectedSubjectForStudent) return

    let student = null
    let updatedStudentsList = students
    
    if (studentToAdd) {
      // Use existing student from dropdown selection
      student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentToAdd))
    } else {
      // Handle quick form input - check if student already exists
      const id = newStudentQuick.id.trim()
      const name = newStudentQuick.name.trim()
      const email = newStudentQuick.email.trim()
      
      if (!id || !name) {
        addCustomAlert('warning', 'Missing Information', 'Please select an existing student or enter Student ID and Name to create one.', false)
        return
      }
      
      // Validate Student ID is numerical (reject legacy S101, S102 format)
      if (!isValidNumericalStudentId(id)) {
        addCustomAlert('error', 'Invalid Student ID', 'Student ID must be numerical only (e.g., 141715, 142177). Legacy IDs like S101, S102 are no longer supported.', false)
        return
      }

      // Additional check: reject any legacy format IDs
      if (/^S\d+$/i.test(id)) {
        addCustomAlert('error', 'Invalid Student ID Format', 'Legacy student ID format (S101, S102, etc.) is no longer supported. Please use numerical IDs only (e.g., 141715, 142177).', false)
        return
      }
      
      // Auto-generate email if not provided
      let studentEmail = email
      if (!studentEmail || !/.+@.+\..+/.test(studentEmail)) {
        studentEmail = generateStudentEmail(name, id)
      }
      
    const normalizedId = normalizeStudentId(id)
    // STRICT INTEGRITY CHECK: Use normalized Student ID as the sole unique key
    const existingStudent = students.find(s => normalizeStudentId(s.id) === normalizedId)
      if (existingStudent) {
        // Duplication Prevention: Check for ID conflict with different name
        if (existingStudent.name.trim().toLowerCase() !== name.trim().toLowerCase()) {
          addCustomAlert('error', 'Data Integrity Error', `Student ID ${normalizedId} already exists with a different name:\n\nExisting: ${existingStudent.name}\nNew: ${name}\n\nStudent ID must be unique. Please verify the Student ID or use the existing student record.`, false)
          return
        }
        // Same ID and same name (case-insensitive) - use existing student
        student = { ...existingStudent, id: normalizedId }
      } else {
        // Create new student only if ID doesn't exist
        student = { id: normalizedId, name, email: studentEmail, archivedSubjects: [] }
        updatedStudentsList = [...students, student]
        setStudents(updatedStudentsList)
        // IMMEDIATE AVAILABILITY: State is updated, so student appears in all dropdowns immediately
      }
    }

    if (!student) return

    const updatedEnrolls = { ...enrolls }
    if (!updatedEnrolls[selectedSubjectForStudent]) {
      updatedEnrolls[selectedSubjectForStudent] = []
    }
    if (updatedEnrolls[selectedSubjectForStudent].map(normalizeStudentId).includes(normalizeStudentId(student.id))) {
      addCustomAlert('info', 'Already Enrolled', 'Student is already enrolled in this subject.', false)
      return
    }

    updatedEnrolls[selectedSubjectForStudent] = [
      ...updatedEnrolls[selectedSubjectForStudent],
      normalizeStudentId(student.id)
    ]
    setNormalizedEnrolls(updatedEnrolls)

    // ENROLLMENT VERIFICATION: Verify ID + Email pairing before enrollment
    const subject = subjects.find(s => s.code === selectedSubjectForStudent)
    if (student && subject) {
      try {
        // Verify the numerical Student ID + Email pairing to ensure correct data linking
        const verification = await verifyStudentIdEmailPair(student.id, student.email)
        
        if (verification.verified && verification.uid) {
          const currentDashboard = await getStudentDashboard(verification.uid)
          const currentSubjects = currentDashboard?.subjects || []
          const subjectExists = currentSubjects.find(s => s.code === selectedSubjectForStudent)
          if (!subjectExists) {
            const updatedSubjects = [...currentSubjects, subject]
            await syncStudentSubjects(verification.uid, updatedSubjects)
            console.log(`âœ… Enrollment verified and synced: Student ${student.id} (${student.email}) â†’ ${selectedSubjectForStudent}`)
          }
        } else {
          // Fallback to direct lookup
          const studentUid = await getStudentUidForSync(student.id, student.email)
          if (studentUid) {
            const currentDashboard = await getStudentDashboard(studentUid)
            const currentSubjects = currentDashboard?.subjects || []
            const subjectExists = currentSubjects.find(s => s.code === selectedSubjectForStudent)
            if (!subjectExists) {
              const updatedSubjects = [...currentSubjects, subject]
              await syncStudentSubjects(studentUid, updatedSubjects)
            }
          } else {
            console.warn(`âš ï¸ Could not verify student ${student.id} for subject enrollment sync. Data will be synced when student logs in.`)
          }
        }
      } catch (error) {
        console.warn('Failed to sync student subject enrollment', error)
      }
    }

    // Create or update a DAILY summary enrollment notification (all subjects combined)
    const todayKey = new Date().toISOString().slice(0, 10) // YYYY-MM-DD
    const updatedAlerts = [...alerts]
    const existingIndex = updatedAlerts.findIndex(a =>
      (a.type === 'subject' || a.type === 'enrollment') &&
      a.summaryDate == todayKey
    )

    if (existingIndex !== -1) {
      const existing = updatedAlerts[existingIndex]
      const prevCount = existing.enrolledCount || 1
      const newCount = prevCount + 1
      updatedAlerts[existingIndex] = {
        ...existing,
        enrolledCount: newCount,
        // Global summary â€“ do not list individual names or subjects
        message: `${newCount} student${newCount === 1 ? '' : 's'} have been enrolled today.`,
        timestamp: new Date(),
        read: false,
      }
    } else {
      const newAlert = {
        id: Date.now(),
        type: 'subject',
        title: 'Student Enrolled',
        message: '1 student has been enrolled today.',
        timestamp: new Date(),
        read: false,
        studentId: student.id,
        subjectCode: null,
        target_courseId: null,
        summaryDate: todayKey,
        enrolledCount: 1,
      }
      updatedAlerts.unshift(newAlert)
    }
    setAlerts(updatedAlerts)
    
    // Save to Firestore immediately (critical operation - real-time notification)
    await saveData(subjects, updatedStudentsList, updatedEnrolls, updatedAlerts, records, grades, profUid, true)

    setShowAddStudentToSubjectModal(false)
    setStudentToAdd('')
    setNewStudentQuick({ id: '', name: '', email: '' })
    setSelectedSubjectForStudent(null)
  }

  const handleArchiveStudent = async (studentId, subjectCode) => {
    const normalizedId = normalizeStudentId(studentId)
    const student = students.find(s => normalizeStudentId(s.id) === normalizedId)
    if (!student) return

    // OPTIMISTIC UPDATE: Update UI immediately before async operations
    // Mark student as archived for this subject
    const updatedStudents = students.map(s => {
      if (normalizeStudentId(s.id) === normalizedId) {
        const archivedSubjects = s.archivedSubjects || []
        if (!archivedSubjects.includes(subjectCode)) {
          return {
            ...s,
            archivedSubjects: [...archivedSubjects, subjectCode]
          }
        }
      }
      return s
    })

    // Remove from current enrollments - create new array reference for React
    const updatedEnrolls = { ...enrolls }
    if (updatedEnrolls[subjectCode]) {
      updatedEnrolls[subjectCode] = updatedEnrolls[subjectCode].filter(id => normalizeStudentId(id) !== normalizedId)
    }
    
    // Update state immediately - UI will update instantly
    setStudents(updatedStudents)
    setNormalizedEnrolls(updatedEnrolls)

    // Sync subject removal to student dashboard in background (non-blocking)
    // This runs after UI update so it doesn't delay the visual feedback
    Promise.resolve().then(async () => {
    try {
      const verification = await verifyStudentIdEmailPair(student.id, student.email)
      if (verification.verified && verification.uid) {
        const currentDashboard = await getStudentDashboard(verification.uid)
        const currentSubjects = (currentDashboard?.subjects || []).filter(s => s.code !== subjectCode)
        await syncStudentSubjects(verification.uid, currentSubjects)
      } else {
        const studentUid = await getStudentUidForSync(student.id, student.email)
        if (studentUid) {
          const currentDashboard = await getStudentDashboard(studentUid)
          const currentSubjects = (currentDashboard?.subjects || []).filter(s => s.code !== subjectCode)
          await syncStudentSubjects(studentUid, currentSubjects)
        }
      }
    } catch (error) {
      console.warn('Failed to sync student subject removal', error)
    }
    })

    const newAlert = {
      id: Date.now(),
      type: 'general',
      title: 'Student Archived',
      message: `${student.name} (${student.id}) has been archived from ${subjectCode}`,
      timestamp: new Date(),
      read: false,
      studentId: student.id,
      subjectCode,
      target_courseId: subjectCode,
    }
    const updatedAlerts = [newAlert, ...alerts]
    setAlerts(updatedAlerts)
    
    // DATABASE ACTION: Save archived status to Firestore in background (non-blocking)
    // This ensures persistence across page refreshes - UI will read from database on reload
    // Use immediate save flag to save without debounce
    Promise.resolve().then(async () => {
    try {
      // Verify that the student is actually removed from enrolls before saving
      const studentStillInEnrolls = updatedEnrolls[subjectCode]?.some(id => normalizeStudentId(id) === normalizedId)
      if (studentStillInEnrolls) {
        console.error(`âŒ ERROR: Student ${normalizedId} still in enrolls[${subjectCode}] before save!`)
        // Force remove again
        updatedEnrolls[subjectCode] = updatedEnrolls[subjectCode].filter(id => normalizeStudentId(id) !== normalizedId)
      }
      
      // CRITICAL: Ensure we're saving the exact updated data, not state
      const studentAfterUpdate = updatedStudents.find(s => normalizeStudentId(s.id) === normalizedId)
      const isInArchived = (studentAfterUpdate?.archivedSubjects || []).includes(subjectCode)
      const isInEnrolls = updatedEnrolls[subjectCode]?.some(id => normalizeStudentId(id) === normalizedId) || false
      
      if (!isInArchived) {
        console.error(`âŒ CRITICAL ERROR: Student ${normalizedId} not marked as archived before save!`)
        addCustomAlert('error', 'Archive Failed', 'Error: Failed to archive student. Please try again.', false)
        return
      }
      
      if (isInEnrolls) {
        console.error(`âŒ CRITICAL ERROR: Student ${normalizedId} still in enrolls before save!`)
        updatedEnrolls[subjectCode] = updatedEnrolls[subjectCode].filter(id => normalizeStudentId(id) !== normalizedId)
      }
      
        await saveData(subjects, updatedStudents, updatedEnrolls, updatedAlerts, records, grades, profUid, true)
      console.log(`âœ… Student ${student.id} archived from ${subjectCode} and saved to Firestore`, {
        studentId: normalizedId,
        subjectCode: subjectCode,
        archivedSubjects: studentAfterUpdate?.archivedSubjects || [],
        enrollsForSubject: updatedEnrolls[subjectCode] || [],
        enrollsCount: updatedEnrolls[subjectCode]?.length || 0,
        studentInEnrolls: updatedEnrolls[subjectCode]?.some(id => normalizeStudentId(id) === normalizedId) || false,
        verification: {
          isArchived: isInArchived,
          notInEnrolls: !isInEnrolls
        }
      })
    } catch (error) {
      console.error('Failed to save archived student to Firestore:', error)
      addCustomAlert('error', 'Save Failed', 'Failed to save archive action. Please try again.', false)
        // Note: We don't revert UI changes on error - the optimistic update stays
    }
    })
  }

  const handleRestoreStudent = async (studentId, subjectCode) => {
    const normalizedId = normalizeStudentId(studentId)
    const student = students.find(s => normalizeStudentId(s.id) === normalizedId)
    if (!student) return

    // Remove from archived subjects
    const updatedStudents = students.map(s => {
      if (normalizeStudentId(s.id) === normalizedId) {
        const archivedSubjects = (s.archivedSubjects || []).filter(code => code !== subjectCode)
        return {
          ...s,
          archivedSubjects
        }
      }
      return s
    })
    setStudents(updatedStudents)

    // Add back to current enrollments
    const updatedEnrolls = { ...enrolls }
    if (!updatedEnrolls[subjectCode]) {
      updatedEnrolls[subjectCode] = []
    }
    if (!updatedEnrolls[subjectCode].some(id => normalizeStudentId(id) === normalizedId)) {
      updatedEnrolls[subjectCode] = [
        ...updatedEnrolls[subjectCode],
        normalizedId
      ]
      setNormalizedEnrolls(updatedEnrolls)
    }

    // Sync subject enrollment to student dashboard
    const subject = subjects.find(s => s.code === subjectCode)
    if (student && subject) {
      try {
        const verification = await verifyStudentIdEmailPair(student.id, student.email)
        if (verification.verified && verification.uid) {
          const currentDashboard = await getStudentDashboard(verification.uid)
          const currentSubjects = currentDashboard?.subjects || []
          const subjectExists = currentSubjects.find(s => s.code === subjectCode)
          if (!subjectExists) {
            const updatedSubjects = [...currentSubjects, subject]
            await syncStudentSubjects(verification.uid, updatedSubjects)
          }
        } else {
          const studentUid = await getStudentUidForSync(student.id, student.email)
          if (studentUid) {
            const currentDashboard = await getStudentDashboard(studentUid)
            const currentSubjects = currentDashboard?.subjects || []
            const subjectExists = currentSubjects.find(s => s.code === subjectCode)
            if (!subjectExists) {
              const updatedSubjects = [...currentSubjects, subject]
              await syncStudentSubjects(studentUid, updatedSubjects)
            }
          }
        }
      } catch (error) {
        console.warn('Failed to sync student subject restoration', error)
      }
    }

    const newAlert = {
      id: Date.now(),
      type: 'general',
      title: 'Student Restored',
      message: `${student.name} (${student.id}) has been restored to ${subject?.name || subjectCode}`,
      timestamp: new Date(),
      read: false,
    }
    const updatedAlerts = [newAlert, ...alerts]
    setAlerts(updatedAlerts)
    
    await saveData(subjects, updatedStudents, updatedEnrolls, updatedAlerts, records, grades, profUid)
  }

  const handleRemoveStudentFromSubject = async (studentId, subjectCode) => {
    // This function now archives instead of permanently removing
    await handleArchiveStudent(studentId, subjectCode)
  }

  // Parse CSV or Excel file and extract student data
  const parseCSV = (file) => {
    const fileName = file.name.toLowerCase()
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls')
    
    if (isExcel) {
      // Parse Excel file
      const reader = new FileReader()
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result)
          const workbook = XLSX.read(data, { type: 'array' })
          
          // Get first sheet
          const firstSheetName = workbook.SheetNames[0]
          const worksheet = workbook.Sheets[firstSheetName]
          
          // Convert to JSON
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' })
          
          // Find header row - more flexible detection
          let headerRowIndex = -1
          let idColumnIndex = 0
          let nameColumnIndex = 1
          let emailColumnIndex = 2
          
          // Try to find header row
          for (let i = 0; i < Math.min(5, jsonData.length); i++) {
            const row = jsonData[i]
            if (Array.isArray(row)) {
              const rowLower = row.map(cell => String(cell).toLowerCase().trim())
              
              // Look for ID column
              const idCol = rowLower.findIndex(cell => 
                cell === 'id' || cell === 'student id' || cell === 'student_id' || 
                cell === 'studentid' || cell.includes('id')
              )
              
              // Look for Name column
              const nameCol = rowLower.findIndex(cell => 
                cell === 'name' || cell === 'student name' || cell === 'student_name' || 
                cell === 'studentname' || cell.includes('name')
              )
              
              // Look for Email column (optional) - more flexible detection
              const emailCol = rowLower.findIndex(cell => 
                cell === 'email' || cell === 'e-mail' || cell === 'student email' || 
                cell === 'student_email' || cell.includes('email') || 
                cell.includes('@') || cell.includes('umindanao')
              )
              
              if (idCol >= 0 && nameCol >= 0) {
                headerRowIndex = i
                idColumnIndex = idCol
                nameColumnIndex = nameCol
                // Use email column if found, otherwise try column 2, or use -1 if not available
                emailColumnIndex = emailCol >= 0 ? emailCol : (row.length > 2 ? 2 : -1)
                
                // If email column not found by name, try to find a column that looks like an email
                if (emailColumnIndex < 0 || emailColumnIndex >= row.length) {
                  for (let colIdx = 0; colIdx < row.length; colIdx++) {
                    const cellValue = String(row[colIdx] || '').toLowerCase()
                    if (cellValue.includes('@') || cellValue.includes('email') || cellValue.includes('umindanao')) {
                      emailColumnIndex = colIdx
                      console.log(`ðŸ“§ Email column detected by content in column ${colIdx}: "${row[colIdx]}"`)
                      break
                    }
                  }
                }
                
                console.log('âœ… Found header row:', { 
                  row: i, 
                  idColumn: idColumnIndex, 
                  nameColumn: nameColumnIndex, 
                  emailColumn: emailColumnIndex,
                  rowLength: row.length,
                  allColumns: row.map((v, idx) => ({ index: idx, value: String(v) }))
                })
                break
              }
            }
          }
          
          // If no header found, assume first row is data (columns 0, 1, 2)
          const startRow = headerRowIndex >= 0 ? headerRowIndex + 1 : 0
          
          const parsed = []
          for (let i = startRow; i < jsonData.length; i++) {
            const row = jsonData[i]
            if (!Array.isArray(row)) continue
            
            // Get values from detected columns
            const id = String(row[idColumnIndex] || '').trim()
            const name = String(row[nameColumnIndex] || '').trim()
            // Only get email if email column index is valid
            // Preserve email exactly as it appears, including .tc@umindanao.edu.ph
            let email = ''
            if (emailColumnIndex >= 0 && row.length > emailColumnIndex) {
              email = String(row[emailColumnIndex] || '').trim()
              // Remove any quotes that might be present
              if ((email.startsWith('"') && email.endsWith('"')) || 
                  (email.startsWith("'") && email.endsWith("'"))) {
                email = email.slice(1, -1).trim()
              }
            } else {
              // Fallback: Try to find email in any column that contains @
              for (let colIdx = 0; colIdx < row.length; colIdx++) {
                const potentialEmail = String(row[colIdx] || '').trim()
                if (potentialEmail.includes('@') && (potentialEmail.includes('.tc@umindanao.edu.ph') || potentialEmail.includes('umindanao'))) {
                  email = potentialEmail
                  // Remove quotes if present
                  if ((email.startsWith('"') && email.endsWith('"')) || 
                      (email.startsWith("'") && email.endsWith("'"))) {
                    email = email.slice(1, -1).trim()
                  }
                  console.log(`ðŸ“§ Found email in column ${colIdx} (not detected as email column): ${email}`)
                  break
                }
              }
            }
            
            // Validate email format if provided (should contain @)
            if (email && !email.includes('@')) {
              console.warn(`âš ï¸ Invalid email format for ${name} (${id}): "${email}" - treating as empty`)
              email = ''
            }
            
            // Skip empty rows
            if (!id && !name) continue
            
            // Validate that we have at least ID and Name
            if (id && name) {
              parsed.push({ id, name, email })
            } else {
              console.warn(`Skipping row ${i + 1}: Missing ID or Name`, { id, name, email })
            }
          }
          
          console.log('ðŸ“Š Excel parsing complete:', {
            totalRows: jsonData.length,
            headerRowIndex,
            startRow,
            parsedCount: parsed.length,
            firstFewParsed: parsed.slice(0, 3),
            idColumn: idColumnIndex,
            nameColumn: nameColumnIndex,
            emailColumn: emailColumnIndex
          })
          
          if (parsed.length === 0) {
            const errorMsg = headerRowIndex >= 0 
              ? 'No student data found after the header row. Please ensure your Excel file has data rows with ID and Name columns.'
              : 'Could not find ID and Name columns in your Excel file. Please ensure your file has columns labeled "ID" (or "Student ID") and "Name" (or "Student Name").'
            addCustomAlert('warning', 'No Data Found', errorMsg, false)
            console.warn('âŒ Excel parsing result: No data found', { 
              jsonData: jsonData.slice(0, 5), // Show first 5 rows for debugging
              headerRowIndex,
              totalRows: jsonData.length,
              firstRow: jsonData[0],
              secondRow: jsonData[1]
            })
          } else {
            console.log(`âœ… Excel parsed successfully: ${parsed.length} students found`, {
              students: parsed,
              headerRow: headerRowIndex >= 0 ? headerRowIndex : 'none (using first row as data)',
              columns: { id: idColumnIndex, name: nameColumnIndex, email: emailColumnIndex }
            })
          }
          
          console.log('âœ… Excel parsing complete - setting preview:', {
            parsedCount: parsed.length,
            firstFewParsed: parsed.slice(0, 3)
          })
          
          setCsvPreview(parsed)
          console.log('âœ… csvPreview state updated with Excel data:', parsed.length, 'students')
          
          if (parsed.length > 0) {
            addCustomAlert('success', 'File Parsed', `Successfully parsed ${parsed.length} student(s) from Excel file.`, false)
          }
        } catch (error) {
          console.error('âŒ Excel parsing error:', error)
          console.error('Error details:', {
            errorName: error.name,
            errorMessage: error.message,
            errorStack: error.stack,
            fileName: file.name
          })
          addCustomAlert('error', 'File Error', `Failed to parse Excel file: ${error.message}. Please check the console (F12) for more details.`, false)
          setCsvPreview([])
        }
      }
      reader.onerror = (error) => {
        console.error('âŒ Excel file read error:', error)
        addCustomAlert('error', 'File Error', 'Failed to read Excel file. Please try again.', false)
        setCsvPreview([])
      }
      reader.readAsArrayBuffer(file)
    } else {
      // Parse CSV file
      const reader = new FileReader()
      reader.onload = (e) => {
        try {
          const text = e.target.result
          const lines = text.split(/\r?\n/).filter(line => line.trim())
          
          if (lines.length === 0) {
            addCustomAlert('warning', 'Empty File', 'The CSV file appears to be empty.', false)
            setCsvPreview([])
            return
          }
          
          // Detect delimiter (comma, semicolon, or tab)
          const firstLine = lines[0]
          let delimiter = ','
          if (firstLine.includes(';') && firstLine.split(';').length > firstLine.split(',').length) {
            delimiter = ';'
          } else if (firstLine.includes('\t')) {
            delimiter = '\t'
          }
          
          // Parse first line to detect column positions
          // Improved CSV parsing that handles quoted fields and emails correctly
          const parseLine = (line) => {
            const values = []
            let currentValue = ''
            let insideQuotes = false
            let quoteChar = null
            
            for (let i = 0; i < line.length; i++) {
              const char = line[i]
              const nextChar = line[i + 1]
              
              // Handle quote start/end
              if ((char === '"' || char === "'") && !insideQuotes) {
                insideQuotes = true
                quoteChar = char
                continue // Don't include quote in value
              } else if (char === quoteChar && insideQuotes) {
                // Check if it's an escaped quote (double quote)
                if (nextChar === quoteChar) {
                  currentValue += char
                  i++ // Skip next quote
                  continue
                } else {
                  // End of quoted field
                  insideQuotes = false
                  quoteChar = null
                  continue // Don't include quote in value
                }
              }
              
              // Handle delimiter
              if (char === delimiter && !insideQuotes) {
                values.push(currentValue.trim())
                currentValue = ''
                continue
              }
              
              // Add character to current value
              currentValue += char
            }
            
            // Add the last value
            if (currentValue.length > 0 || values.length > 0) {
              values.push(currentValue.trim())
            }
            
            return values
          }
          
          // Detect header row and column positions
          let startIndex = 0
          let idColumnIndex = 0
          let nameColumnIndex = 1
          let emailColumnIndex = 2
          
          const firstLineValues = parseLine(firstLine)
          const firstLineLower = firstLineValues.map(v => v.toLowerCase().trim())
          
          // Check if first line is a header
          const hasIdHeader = firstLineLower.some(v => 
            v === 'id' || v === 'student id' || v === 'student_id' || v === 'studentid' || v.includes('id')
          )
          const hasNameHeader = firstLineLower.some(v => 
            v === 'name' || v === 'student name' || v === 'student_name' || v === 'studentname' || v.includes('name')
          )
          
          if (hasIdHeader && hasNameHeader) {
            startIndex = 1
            // Find actual column positions
            idColumnIndex = firstLineLower.findIndex(v => 
              v === 'id' || v === 'student id' || v === 'student_id' || v === 'studentid' || v.includes('id')
            )
            nameColumnIndex = firstLineLower.findIndex(v => 
              v === 'name' || v === 'student name' || v === 'student_name' || v === 'studentname' || v.includes('name')
            )
            const emailCol = firstLineLower.findIndex(v => 
              v === 'email' || v === 'e-mail' || v === 'student email' || v === 'student_email' || 
              v.includes('email') || v.includes('@') || v.includes('umindanao')
            )
            emailColumnIndex = emailCol >= 0 ? emailCol : (firstLineValues.length > 2 ? 2 : -1)
            
            // If email column not found by name, try to find a column that looks like an email
            if (emailColumnIndex < 0 || emailColumnIndex >= firstLineValues.length) {
              for (let colIdx = 0; colIdx < firstLineValues.length; colIdx++) {
                const headerValue = firstLineValues[colIdx].toLowerCase()
                if (headerValue.includes('@') || headerValue.includes('email') || headerValue.includes('umindanao')) {
                  emailColumnIndex = colIdx
                  console.log(`ðŸ“§ Email column detected by content in column ${colIdx}: "${firstLineValues[colIdx]}"`)
                  break
                }
              }
            }
            
            console.log('âœ… CSV header detected:', {
              idColumn: idColumnIndex,
              nameColumn: nameColumnIndex,
              emailColumn: emailColumnIndex,
              headerRow: firstLineValues,
              allColumns: firstLineValues.map((v, idx) => ({ index: idx, value: v }))
            })
          }
          
          const parsed = []
          for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim()
            if (!line) continue
            
            // Parse the line
            const values = parseLine(line)
            
            // Debug: Log the parsed values for first few rows
            if (i < startIndex + 3) {
              console.log(`ðŸ” Parsing row ${i + 1}:`, {
                rawLine: line.substring(0, 100),
                parsedValues: values,
                valuesCount: values.length,
                idColumn: idColumnIndex,
                nameColumn: nameColumnIndex,
                emailColumn: emailColumnIndex
              })
            }
            
            if (values.length >= 2) {
              // Get values from detected column positions
              const id = values[idColumnIndex]?.trim() || ''
              const name = values[nameColumnIndex]?.trim() || ''
              // Only get email if email column index is valid
              // Preserve email exactly as it appears, including .tc@umindanao.edu.ph
              let email = ''
              if (emailColumnIndex >= 0 && values.length > emailColumnIndex) {
                email = (values[emailColumnIndex] || '').trim()
                // Remove any remaining quotes that might have been missed
                if ((email.startsWith('"') && email.endsWith('"')) || 
                    (email.startsWith("'") && email.endsWith("'"))) {
                  email = email.slice(1, -1).trim()
                }
              } else {
                // Try to find email in any column that contains @
                for (let colIdx = 0; colIdx < values.length; colIdx++) {
                  const potentialEmail = (values[colIdx] || '').trim()
                  if (potentialEmail.includes('@') && potentialEmail.includes('.tc@umindanao.edu.ph')) {
                    email = potentialEmail
                    // Remove quotes if present
                    if ((email.startsWith('"') && email.endsWith('"')) || 
                        (email.startsWith("'") && email.endsWith("'"))) {
                      email = email.slice(1, -1).trim()
                    }
                    console.log(`ðŸ“§ Found email in column ${colIdx} (not detected as email column): ${email}`)
                    break
                  }
                }
              }
              
              // Validate email format if provided (should contain @)
              if (email && !email.includes('@')) {
                console.warn(`âš ï¸ Invalid email format for ${name} (${id}): "${email}" - treating as empty`)
                email = ''
              }
              
              if (id && name) {
                parsed.push({ id, name, email })
                console.log(`âœ… Parsed student: ${name} (${id}) - Email: ${email || 'N/A'}`)
              }
            } else {
              console.warn(`âš ï¸ Row ${i + 1} has insufficient columns (${values.length}):`, values)
            }
          }
          
          if (parsed.length === 0) {
            addCustomAlert('warning', 'No Data Found', 'The CSV file appears to be empty or in an unexpected format. Please ensure it has columns: ID, Name, Email', false)
            console.warn('âŒ CSV parsing result: No data found', { 
              lines: lines.slice(0, 5), 
              delimiter, 
              startIndex,
              firstLine: lines[0],
              columnPositions: { id: idColumnIndex, name: nameColumnIndex, email: emailColumnIndex }
            })
          } else {
            console.log(`âœ… CSV parsed successfully: ${parsed.length} students found`, {
              students: parsed,
              columnPositions: { id: idColumnIndex, name: nameColumnIndex, email: emailColumnIndex },
              emailsFound: parsed.filter(s => s.email).length,
              emailsMissing: parsed.filter(s => !s.email).length
            })
          }
          
          console.log('âœ… CSV parsing complete:', {
            parsedCount: parsed.length,
            firstFewParsed: parsed.slice(0, 3),
            detectedDelimiter: delimiter
          })
          
          setCsvPreview(parsed)
          console.log('âœ… csvPreview state updated:', parsed.length, 'students')
          
          if (parsed.length > 0) {
            addCustomAlert('success', 'File Parsed', `Successfully parsed ${parsed.length} student(s) from CSV file.`, false)
          }
        } catch (error) {
          console.error('âŒ CSV parsing error:', error)
          addCustomAlert('error', 'File Error', `Failed to parse CSV file: ${error.message}`, false)
          setCsvPreview([])
        }
      }
      reader.onerror = (error) => {
        console.error('âŒ File read error:', error)
        addCustomAlert('error', 'File Error', 'Failed to read CSV file. Please try again.', false)
        setCsvPreview([])
      }
      reader.readAsText(file, 'UTF-8')
    }
  }

  // Handle CSV import and enroll students in selected subject
  const handleImportCSV = async () => {
    console.log('ðŸš€ Import started:', { 
      csvFile: csvFile?.name, 
      subject: studentSubjectFilter, 
      previewCount: csvPreview.length,
      previewData: csvPreview.slice(0, 3), // Show first 3 for debugging
      subjectsAvailable: subjects.length
    })
    
    if (!csvFile) {
      console.error('âŒ Import failed: No file selected')
      addCustomAlert('error', 'Missing File', 'Please upload a CSV or Excel file.', false)
      return
    }
    
    if (!studentSubjectFilter) {
      console.error('âŒ Import failed: No subject selected')
      addCustomAlert('error', 'Missing Subject', 'Please select a subject to enroll students.', false)
      return
    }
    
    if (csvPreview.length === 0) {
      console.error('âŒ Import failed: No preview data', { csvFile: csvFile.name, csvPreview })
      addCustomAlert('error', 'No Data', 'The file appears to be empty or could not be parsed. Please check the file format and try uploading again.', false)
      return
    }

    setIsImporting(true)
    isImportingRef.current = true // Prevent real-time listener from overwriting
    lastImportTimeRef.current = Date.now() // Track import time
    const subject = subjects.find(s => s.code === studentSubjectFilter)
      if (!subject) {
        addCustomAlert('error', 'Invalid Subject', 'Selected subject not found.', false)
        setIsImporting(false)
        isImportingRef.current = false
        return
      }

    let successCount = 0
    let errorCount = 0
    const errors = []

    // CRITICAL: Collect all updates first, then apply at once
    // This ensures React state updates work correctly and UI reflects changes immediately
    // Use functional state updates to get the latest state
    let updatedStudentsList = [...students] // Start with current students
    const updatedEnrolls = JSON.parse(JSON.stringify(enrolls)) // Deep copy to ensure new reference
    Object.keys(updatedEnrolls).forEach(subjectCode => {
      const ids = Array.isArray(updatedEnrolls[subjectCode]) ? updatedEnrolls[subjectCode] : []
      updatedEnrolls[subjectCode] = ids.map(normalizeStudentId).filter(Boolean)
    })
    if (!updatedEnrolls[studentSubjectFilter]) {
      updatedEnrolls[studentSubjectFilter] = []
    }
    
    console.log('Before import:', {
      currentStudentsCount: students.length,
      currentEnrolledInSubject: enrolls[studentSubjectFilter]?.length || 0,
      csvPreviewCount: csvPreview.length
    })

    // Process each student from CSV and collect updates
    // CRITICAL: Process ALL students from CSV, both existing and new
    console.log('ðŸ“‹ Processing CSV students:', {
      totalInCsv: csvPreview.length,
      csvStudents: csvPreview.map(s => ({ id: s.id, name: s.name, email: s.email || 'N/A' }))
    })
    
    for (const csvStudent of csvPreview) {
      try {
        const id = (csvStudent.id || '').trim()
        const name = (csvStudent.name || '').trim()
        const email = (csvStudent.email || '').trim() // Safe handling of undefined email

        // Skip if missing required fields
        if (!id || !name) {
          console.warn(`âš ï¸ Skipping invalid row: ID=${id}, Name=${name}`)
          errors.push(`Row missing ID or Name: ${name || id || 'Unknown'}`)
          errorCount++
          continue
        }

        // Validate Student ID is numerical
        if (!isValidNumericalStudentId(id)) {
          errors.push(`${name} (${id}): Invalid Student ID format`)
          errorCount++
          continue
        }

        const normalizedId = normalizeStudentId(id)

        // Auto-generate email if not provided or invalid
        let studentEmail = email
        if (!studentEmail || !/.+@.+\..+/.test(studentEmail)) {
          studentEmail = generateStudentEmail(name, normalizedId)
          console.log(`ðŸ“§ Generated email for ${name} (${normalizedId}): ${studentEmail}`)
        } else {
          console.log(`ðŸ“§ Using provided email for ${name} (${normalizedId}): ${studentEmail}`)
        }

        // Check if student already exists in our updated list
        let student = updatedStudentsList.find(s => normalizeStudentId(s.id) === normalizedId)
        const isNewStudent = !student

        if (student) {
          console.log(`ðŸ‘¤ Found existing student: ${student.name} (${normalizedId})`)
          // Check for name mismatch
          if (student.name.trim().toLowerCase() !== name.trim().toLowerCase()) {
            errors.push(`${name} (${normalizedId}): ID exists with different name: ${student.name}`)
            errorCount++
            continue
          }
          // Update email if provided and different
          if (email && student.email !== email) {
            student = { ...student, email: studentEmail }
            updatedStudentsList = updatedStudentsList.map(s => normalizeStudentId(s.id) === normalizedId ? student : s)
            console.log(`ðŸ“§ Updated email for existing student ${student.name}: ${studentEmail}`)
          }
        } else {
          // Create new student - add to our updated list
          // CRITICAL: Ensure archivedSubjects is empty array for new students
          // This prevents them from being filtered out on refresh
          student = { 
            id: normalizedId, 
            name, 
            email: studentEmail, 
            archivedSubjects: [] // CRITICAL: Empty array ensures student is not archived
          }
          updatedStudentsList.push(student)
          console.log(`âœ¨ Created NEW student: ${student.name} (${normalizedId}) - Email: ${studentEmail}`, {
            archivedSubjects: student.archivedSubjects,
            willNotBeFiltered: true
          })
        }
        
        // CRITICAL: If student is being enrolled, ensure they are NOT archived for this subject
        // This prevents the student from being filtered out on refresh
        // This is important because a student might have been archived before, but now we're re-enrolling them
        const currentArchivedSubjects = Array.isArray(student.archivedSubjects) ? student.archivedSubjects : []
        if (currentArchivedSubjects.includes(studentSubjectFilter)) {
          console.log(`ðŸ”„ Unarchiving student ${student.name} (${normalizedId}) from ${studentSubjectFilter} - they are being re-enrolled`)
          student.archivedSubjects = currentArchivedSubjects.filter(subjectCode => subjectCode !== studentSubjectFilter)
          // Update the student in the list
          updatedStudentsList = updatedStudentsList.map(s => 
            normalizeStudentId(s.id) === normalizedId ? student : s
          )
          console.log(`âœ… Student ${student.name} unarchived from ${studentSubjectFilter}`, {
            previousArchived: currentArchivedSubjects,
            newArchived: student.archivedSubjects
          })
        }

        // CRITICAL: Ensure enrollment array exists
        if (!updatedEnrolls[studentSubjectFilter]) {
          updatedEnrolls[studentSubjectFilter] = []
        }

        // Enroll in selected subject (if not already enrolled)
        const enrollmentArray = updatedEnrolls[studentSubjectFilter] || []
        if (!enrollmentArray.includes(normalizedId)) {
          // Create new array reference to trigger React re-render
          updatedEnrolls[studentSubjectFilter] = [...enrollmentArray, normalizedId]
          successCount++
          console.log(`  âœ“ ${isNewStudent ? 'Created and enrolled' : 'Enrolled'} ${student.name} (${normalizedId}) in ${studentSubjectFilter}`)
        } else {
          // Already enrolled - count as success
          successCount++
          console.log(`  - ${student.name} (${normalizedId}) already enrolled in ${studentSubjectFilter}`)
        }
      } catch (error) {
        const errorMsg = `${csvStudent.name || 'Unknown'} (${csvStudent.id || 'Unknown'}): ${error.message}`
        errors.push(errorMsg)
        errorCount++
        console.error(`âŒ Error processing student:`, errorMsg, error)
      }
    }
    
    console.log('ðŸ“Š Import processing complete:', {
      totalProcessed: csvPreview.length,
      successCount,
      errorCount,
      newStudentsCreated: updatedStudentsList.length - students.length,
      totalStudents: updatedStudentsList.length,
      enrolledInSubject: updatedEnrolls[studentSubjectFilter]?.length || 0,
      errors: errors.slice(0, 5) // Show first 5 errors
    })

    // Apply all state updates at once - this ensures UI updates immediately
    // Use functional updates to ensure we're working with the latest state
    setStudents(prevStudents => {
      console.log('Setting students:', { 
        prevCount: prevStudents.length, 
        newCount: updatedStudentsList.length,
        newStudents: updatedStudentsList.filter(s => !prevStudents.find(p => normalizeStudentId(p.id) === normalizeStudentId(s.id)))
      })
      return updatedStudentsList
    })
    
    setNormalizedEnrolls(prevEnrolls => {
      // Create completely new object with new array references
      // First, preserve all existing enrollments
      const newEnrolls = {}
      Object.keys(prevEnrolls).forEach(key => {
        newEnrolls[key] = [...prevEnrolls[key]]
      })
      // Then, update with our new enrollments (this will add new subjects or update existing ones)
      Object.keys(updatedEnrolls).forEach(key => {
        newEnrolls[key] = [...updatedEnrolls[key]] // New array reference
      })
      console.log('âœ… Setting enrolls:', { 
        subject: studentSubjectFilter,
        prevEnrolled: prevEnrolls[studentSubjectFilter]?.length || 0,
        newEnrolled: newEnrolls[studentSubjectFilter]?.length || 0,
        newEnrollsForSubject: newEnrolls[studentSubjectFilter],
        allSubjects: Object.keys(newEnrolls),
        updatedEnrollsKeys: Object.keys(updatedEnrolls),
        studentIds: newEnrolls[studentSubjectFilter]
      })
      return newEnrolls
    })

    // Force React to process state updates and trigger re-render
    // Use requestAnimationFrame to ensure DOM updates happen immediately
    await new Promise(resolve => {
      requestAnimationFrame(() => {
        setTimeout(resolve, 100)
      })
    })
    
    console.log('âœ… State updated - students should now be visible in UI', {
      studentsCount: updatedStudentsList.length,
      enrolledCount: updatedEnrolls[studentSubjectFilter].length,
      enrolledIds: updatedEnrolls[studentSubjectFilter]
    })
    
    // Force a re-render by updating the enrolls state again with a new reference
    // This ensures React detects the change and updates the UI
    setNormalizedEnrolls(prevEnrolls => {
      // Check if the state already matches what we expect
      const currentEnrolled = prevEnrolls[studentSubjectFilter] || []
      const expectedEnrolled = updatedEnrolls[studentSubjectFilter] || []
      
      if (currentEnrolled.length !== expectedEnrolled.length) {
        console.log('ðŸ”„ Forcing enrolls update - state mismatch detected', {
          current: currentEnrolled.length,
          expected: expectedEnrolled.length,
          currentIds: currentEnrolled,
          expectedIds: expectedEnrolled
        })
        // Create new object with correct enrollments
        const fresh = { ...prevEnrolls }
        fresh[studentSubjectFilter] = [...expectedEnrolled]
        return fresh
      }
      // State already matches, but return new reference to force re-render
      const fresh = { ...prevEnrolls }
      Object.keys(fresh).forEach(key => {
        fresh[key] = [...fresh[key]]
      })
      return fresh
    })

    // CRITICAL: Normalize enrollments one final time before saving
    // This ensures all student IDs are properly formatted and duplicates are removed
    // Define outside try block so it's accessible in all scopes
    const finalNormalizedEnrolls = normalizeEnrollsMap(updatedEnrolls)

    // Save all changes to Firestore immediately
    try {
      
      console.log('ðŸ’¾ Saving to Firestore...', {
        students: updatedStudentsList.length,
        enrolls: Object.keys(finalNormalizedEnrolls).length,
        enrollsForSubject: finalNormalizedEnrolls[studentSubjectFilter]?.length || 0,
        enrolledIds: finalNormalizedEnrolls[studentSubjectFilter],
        enrollsObject: finalNormalizedEnrolls,
        normalized: true
      })
      
      // CRITICAL: Update state with normalized data BEFORE saving to ensure UI updates immediately
      setNormalizedEnrolls(prevEnrolls => {
        const fresh = { ...prevEnrolls }
        // Update all enrollments with normalized data
        Object.keys(finalNormalizedEnrolls).forEach(key => {
          fresh[key] = [...finalNormalizedEnrolls[key]]
        })
        console.log('ðŸ”„ Pre-save state update with normalized enrolls:', {
          subject: studentSubjectFilter,
          enrolled: fresh[studentSubjectFilter]?.length || 0,
          ids: fresh[studentSubjectFilter] || [],
          allSubjects: Object.keys(fresh)
        })
        return fresh
      })
      
      setStudents(prevStudents => {
        // Always update to ensure new students are included
        const fresh = [...updatedStudentsList]
        console.log('ðŸ”„ Pre-save students update:', {
          prev: prevStudents.length,
          new: fresh.length
        })
        return fresh
      })
      
      // Force immediate UI update
      setRefreshTrigger(prev => prev + 1)
      
      // CRITICAL: Verify all students exist before saving
      const enrollmentStudentIds = new Set()
      Object.values(finalNormalizedEnrolls || {}).forEach(enrolledIds => {
        enrolledIds.forEach(id => enrollmentStudentIds.add(normalizeStudentId(id)))
      })
      const studentIds = new Set(updatedStudentsList.map(s => normalizeStudentId(s.id)))
      const missingStudents = Array.from(enrollmentStudentIds).filter(id => !studentIds.has(id))
      
      if (missingStudents.length > 0) {
        console.error('âŒ CRITICAL: Cannot save - enrollments reference students that don\'t exist:', {
          missingStudentIds: missingStudents,
          totalEnrollments: enrollmentStudentIds.size,
          totalStudents: studentIds.size
        })
        addCustomAlert('error', 'Data Error', `Cannot save: ${missingStudents.length} enrolled students not found in students list. Please try importing again.`, false)
        setIsImporting(false)
        isImportingRef.current = false
        return
      }
      
      // CRITICAL: Verify no enrolled students are archived for their subjects
      // This prevents them from being filtered out on refresh
      const archivedIssues = []
      Object.keys(finalNormalizedEnrolls || {}).forEach(subjectCode => {
        const enrolledIds = finalNormalizedEnrolls[subjectCode] || []
        enrolledIds.forEach(enrolledId => {
          const student = updatedStudentsList.find(s => normalizeStudentId(s.id) === normalizeStudentId(enrolledId))
          if (student) {
            const archivedSubjects = Array.isArray(student.archivedSubjects) ? student.archivedSubjects : []
            if (archivedSubjects.includes(subjectCode)) {
              archivedIssues.push({
                studentId: student.id,
                studentName: student.name,
                subjectCode: subjectCode
              })
            }
          }
        })
      })
      
      if (archivedIssues.length > 0) {
        console.error('âŒ CRITICAL: Found enrolled students that are archived for their subjects:', archivedIssues)
        console.log('ðŸ”„ Fixing archived issues by unarchiving students...')
        // Fix the archived issues
        archivedIssues.forEach(issue => {
          const student = updatedStudentsList.find(s => normalizeStudentId(s.id) === normalizeStudentId(issue.studentId))
          if (student) {
            student.archivedSubjects = (student.archivedSubjects || []).filter(subjectCode => subjectCode !== issue.subjectCode)
            console.log(`âœ… Unarchived ${student.name} from ${issue.subjectCode}`)
          }
        })
        // Update the list
        updatedStudentsList = updatedStudentsList.map(s => {
          const issue = archivedIssues.find(i => normalizeStudentId(i.studentId) === normalizeStudentId(s.id))
          if (issue) {
            const student = updatedStudentsList.find(st => normalizeStudentId(st.id) === normalizeStudentId(s.id))
            return student || s
          }
          return s
        })
        console.log('âœ… All archived issues fixed')
      }
      
      // Now save to Firestore
      console.log('ðŸ’¾ Saving to Firestore with complete data:', {
        students: updatedStudentsList.length,
        newStudents: updatedStudentsList.length - students.length,
        existingStudents: students.length,
        enrolls: Object.keys(finalNormalizedEnrolls).length,
        enrollsForSubject: finalNormalizedEnrolls[studentSubjectFilter]?.length || 0,
        enrolledIds: finalNormalizedEnrolls[studentSubjectFilter],
        enrolledStudentNames: finalNormalizedEnrolls[studentSubjectFilter]?.map(id => {
          const student = updatedStudentsList.find(s => normalizeStudentId(s.id) === id)
          return student ? student.name : 'Unknown'
        }) || [],
        dataIntegrity: 'âœ… All enrolled students exist in students array',
        willPersist: true
      })
      
      // Create notification for successful import
      const newAlert = {
        id: Date.now(),
        type: 'subject',
        title: 'Students Imported',
        message: `Successfully imported ${successCount} student${successCount === 1 ? '' : 's'} to ${subject.name}.`,
        timestamp: new Date(),
        read: false,
        target_courseId: studentSubjectFilter,
        subjectCode: studentSubjectFilter,
      }
      const updatedAlerts = [newAlert, ...alerts]
      setAlerts(updatedAlerts)
      
      // CRITICAL: Save with immediate flag to ensure data is written right away
      const saveResult = await saveData(subjects, updatedStudentsList, finalNormalizedEnrolls, updatedAlerts, records, grades, profUid, true)
      
      if (!saveResult) {
        console.error('âŒ CRITICAL: Save operation returned false - data may not have been saved!')
        addCustomAlert('error', 'Save Failed', 'Failed to save students to Firestore. Data may not persist after refresh. Please try again.', false)
      } else {
        console.log('âœ… Save operation completed successfully')
      }
      
      console.log(`âœ… Imported ${successCount} students to ${subject.name}`, {
        subject: studentSubjectFilter,
        studentsAdded: successCount,
        newStudentsCreated: updatedStudentsList.length - students.length,
        totalStudents: updatedStudentsList.length,
        enrolledInSubject: finalNormalizedEnrolls[studentSubjectFilter].length,
        enrolledStudentIds: finalNormalizedEnrolls[studentSubjectFilter],
        savedEnrolls: finalNormalizedEnrolls
      })
      
      // Immediately after save, force state update again to ensure UI reflects the saved data
      setNormalizedEnrolls(prevEnrolls => {
        const fresh = { ...prevEnrolls }
        // Ensure all subjects have new array references
        Object.keys(fresh).forEach(key => {
          fresh[key] = [...(fresh[key] || [])]
        })
        // Force update the subject with imported students (use normalized version)
        fresh[studentSubjectFilter] = [...finalNormalizedEnrolls[studentSubjectFilter]]
        console.log('ðŸ”„ Post-save state update:', {
          subject: studentSubjectFilter,
          enrolled: fresh[studentSubjectFilter].length,
          ids: fresh[studentSubjectFilter]
        })
        return fresh
      })
      
      setStudents(prevStudents => {
        // Always update to ensure consistency
        const fresh = [...updatedStudentsList]
        if (prevStudents.length !== fresh.length) {
          console.log('ðŸ”„ Post-save students update:', {
            prev: prevStudents.length,
            new: fresh.length
          })
        }
        return fresh
      })
      
      // Force multiple UI refreshes
      setRefreshTrigger(prev => prev + 1)
      setTimeout(() => setRefreshTrigger(prev => prev + 1), 100)
      setTimeout(() => setRefreshTrigger(prev => prev + 1), 300)
      
      // Wait for Firestore to process the write and propagate
      // This prevents the real-time listener from immediately overwriting our changes
      console.log('â³ Waiting 2 seconds for Firestore to propagate...')
      await new Promise(resolve => setTimeout(resolve, 2000))
      console.log('âœ… Import complete - real-time listener re-enabled after 2s delay')
      
      // Verify data was saved correctly by reading back from Firestore
      // Wait a bit more for Firestore to fully propagate
      await new Promise(resolve => setTimeout(resolve, 1000))
      
      try {
        const savedData = await getWithBackup(DASHBOARD_COLLECTION, profUid)
        if (savedData && savedData.enrolls) {
          // Normalize the saved enrolls to ensure consistency
          const normalizedSavedEnrolls = normalizeEnrollsMap(savedData.enrolls)
          const savedEnrolls = normalizedSavedEnrolls[studentSubjectFilter] || []
          const savedStudents = savedData.students || []
          
          // CRITICAL: Verify all enrolled students exist in saved students
          const savedStudentIds = new Set(savedStudents.map(s => normalizeStudentId(s.id)))
          const missingEnrolledStudents = savedEnrolls.filter(id => !savedStudentIds.has(normalizeStudentId(id)))
          
          console.log('ðŸ” Verification - Data read back from Firestore:', {
            subject: studentSubjectFilter,
            savedEnrollsCount: savedEnrolls.length,
            expectedCount: finalNormalizedEnrolls[studentSubjectFilter].length,
            savedEnrolls: savedEnrolls,
            expectedEnrolls: finalNormalizedEnrolls[studentSubjectFilter],
            savedStudentsCount: savedStudents.length,
            expectedStudentsCount: updatedStudentsList.length,
            match: JSON.stringify(savedEnrolls.sort()) === JSON.stringify(finalNormalizedEnrolls[studentSubjectFilter].sort()),
            missingEnrolledStudents: missingEnrolledStudents.length > 0 ? missingEnrolledStudents : 'None'
          })
          
          if (missingEnrolledStudents.length > 0) {
            console.error('âŒ CRITICAL: Saved enrollments reference students that don\'t exist in saved students:', {
              missingStudentIds: missingEnrolledStudents,
              savedEnrolls: savedEnrolls,
              savedStudentIds: Array.from(savedStudentIds)
            })
            // This shouldn't happen, but if it does, we need to fix it
          }
          
          // CRITICAL: Always update state with what's actually in Firestore
          // This ensures UI matches the database and persists on reload
          console.log('ðŸ”„ Updating state with verified Firestore data')
        setNormalizedEnrolls(prev => {
            const fresh = {}
            // Start fresh with all subjects from saved data (use normalized version)
            Object.keys(normalizedSavedEnrolls || {}).forEach(key => {
              fresh[key] = [...(normalizedSavedEnrolls[key] || [])]
            })
            // Also preserve any existing subjects not in saved data (safety)
            Object.keys(prev).forEach(key => {
              if (!fresh[key]) {
                fresh[key] = [...prev[key]]
              }
            })
            // Ensure the imported subject has the correct data
            fresh[studentSubjectFilter] = [...savedEnrolls]
            console.log('âœ… State updated with Firestore data:', {
              subject: studentSubjectFilter,
              enrolled: fresh[studentSubjectFilter].length,
              ids: fresh[studentSubjectFilter],
              allSubjects: Object.keys(fresh),
              allEnrollments: Object.keys(fresh).map(k => ({ subject: k, count: fresh[k].length }))
            })
            return fresh
          })
          
          setStudents(prev => {
            // CRITICAL: Always update with saved students to ensure new students are included
            const prevIds = prev.map(s => normalizeStudentId(s.id)).sort().join(',')
            const savedIds = savedStudents.map(s => normalizeStudentId(s.id)).sort().join(',')
            if (savedStudents.length !== prev.length || prevIds !== savedIds) {
              console.log('ðŸ”„ Updating students with Firestore data:', {
                prev: prev.length,
                saved: savedStudents.length,
                prevIds: prev.map(s => normalizeStudentId(s.id)),
                savedIds: savedStudents.map(s => normalizeStudentId(s.id)),
                newStudents: savedStudents.filter(s => !prev.find(p => normalizeStudentId(p.id) === normalizeStudentId(s.id)))
              })
              return savedStudents
            }
            // Even if IDs match, return saved students to ensure we have latest data
            return savedStudents
          })
          
          // Force UI refresh multiple times to ensure it updates
          setRefreshTrigger(prev => prev + 1)
          setTimeout(() => setRefreshTrigger(prev => prev + 1), 200)
          setTimeout(() => setRefreshTrigger(prev => prev + 1), 500)
          setTimeout(() => setRefreshTrigger(prev => prev + 1), 1000)
          console.log('âœ… State synchronized with Firestore - UI should now show students')
          
          // CRITICAL: Final persistence check - verify data will persist on reload
          console.log('ðŸ” Final persistence check:', {
            studentsSaved: savedStudents.length,
            enrollmentsSaved: savedEnrolls.length,
            subject: studentSubjectFilter,
            willPersist: savedStudents.length > 0 && savedEnrolls.length > 0,
            message: savedStudents.length > 0 && savedEnrolls.length > 0 
              ? 'âœ… Data is saved and will persist on reload' 
              : 'âš ï¸ Warning: Some data may not persist',
            savedStudentIds: savedStudents.map(s => normalizeStudentId(s.id)),
            savedEnrollmentIds: savedEnrolls
          })
        } else {
          console.warn('âš ï¸ No enrolls data found in saved Firestore data')
          // Even if no data found, ensure state is updated
          setRefreshTrigger(prev => prev + 1)
          
          // CRITICAL: If no data found, this is a problem - try to re-save
          console.error('âŒ CRITICAL: Saved data verification failed - no enrolls found')
          console.log('ðŸ”„ Attempting to re-save data to ensure persistence...')
          try {
            await saveData(subjects, updatedStudentsList, finalNormalizedEnrolls, alerts, records, grades, profUid, true)
            console.log('âœ… Re-save completed - data should now persist')
          } catch (resaveError) {
            console.error('âŒ Re-save failed:', resaveError)
          }
        }
      } catch (verifyError) {
        console.warn('Could not verify saved data:', verifyError)
        // Even if verification fails, force a refresh
        setRefreshTrigger(prev => prev + 1)
      }
      
      // Verify state after save and force update if needed
      // Use functional updates to read current state, not closure values
      setTimeout(() => {
        setNormalizedEnrolls(prevEnrolls => {
          const currentEnrolled = prevEnrolls[studentSubjectFilter] || []
          const expectedEnrolled = finalNormalizedEnrolls[studentSubjectFilter] || []
          
          console.log('ðŸ” Verifying state after save:', {
            currentEnrolled: currentEnrolled.length,
            expectedEnrolled: expectedEnrolled.length,
            currentIds: currentEnrolled,
            expectedIds: expectedEnrolled
          })
          
          // Force update if state doesn't match expected
          if (currentEnrolled.length !== expectedEnrolled.length || 
              JSON.stringify(currentEnrolled.sort()) !== JSON.stringify(expectedEnrolled.sort())) {
            console.warn('âš ï¸ State mismatch detected - forcing update...', {
              current: currentEnrolled.length,
              expected: expectedEnrolled.length,
              currentIds: currentEnrolled,
              expectedIds: expectedEnrolled
            })
            const fresh = { ...prevEnrolls }
            fresh[studentSubjectFilter] = [...expectedEnrolled]
            return fresh
          }
          return prevEnrolls
        })
        
        setStudents(prevStudents => {
          if (prevStudents.length !== updatedStudentsList.length) {
            console.warn('âš ï¸ Students count mismatch - forcing update...', {
              current: prevStudents.length,
              expected: updatedStudentsList.length
            })
            return updatedStudentsList
          }
          return prevStudents
        })
      }, 500)
    } catch (error) {
      console.error('Failed to save imported students:', error)
      addCustomAlert('error', 'Save Error', 'Students were imported but failed to save to Firestore. Please try saving again.', false)
    } finally {
      // Re-enable real-time listener after import completes
      isImportingRef.current = false
      console.log('âœ… Import flag cleared - students should now be visible in UI')
    }

    // Sync students to Firestore in background (non-blocking)
    const syncPromises = updatedStudentsList
      .filter(student => finalNormalizedEnrolls[studentSubjectFilter]?.includes(normalizeStudentId(student.id)))
      .map(async (student) => {
        try {
          const verification = await verifyStudentIdEmailPair(student.id, student.email)
          if (verification.verified && verification.uid) {
            const currentDashboard = await getStudentDashboard(verification.uid)
            const currentSubjects = currentDashboard?.subjects || []
            const subjectExists = currentSubjects.find(s => s.code === studentSubjectFilter)
            if (!subjectExists) {
              const updatedSubjects = [...currentSubjects, subject]
              await syncStudentSubjects(verification.uid, updatedSubjects)
            }
          } else {
            const studentUid = await getStudentUidForSync(student.id, student.email)
            if (studentUid) {
              const currentDashboard = await getStudentDashboard(studentUid)
              const currentSubjects = currentDashboard?.subjects || []
              const subjectExists = currentSubjects.find(s => s.code === studentSubjectFilter)
              if (!subjectExists) {
                const updatedSubjects = [...currentSubjects, subject]
                await syncStudentSubjects(studentUid, updatedSubjects)
              }
            }
          }
        } catch (syncError) {
          console.warn(`Failed to sync student ${student.id} to Firestore:`, syncError)
        }
      })

    // Wait for all syncs to complete (but don't block UI)
    Promise.all(syncPromises).catch(err => {
      console.warn('Some student syncs failed:', err)
    })

    setIsImporting(false)
    // Note: isImportingRef.current is already set to false in the finally block above
    
    // Force a UI refresh by updating the refresh trigger
    setRefreshTrigger(prev => prev + 1)
    console.log('ðŸ”„ UI refresh triggered')

    // Force multiple final state updates to ensure UI reflects the changes
    // This is a safety mechanism in case the previous updates didn't trigger a re-render
    const forceUpdateCount = 3
    for (let i = 0; i < forceUpdateCount; i++) {
      setTimeout(() => {
        setNormalizedEnrolls(prevEnrolls => {
          const currentEnrolled = prevEnrolls[studentSubjectFilter] || []
          const expectedEnrolled = finalNormalizedEnrolls[studentSubjectFilter] || []
          
          console.log(`ðŸ”„ Final force update ${i + 1}/${forceUpdateCount}:`, {
            current: currentEnrolled.length,
            expected: expectedEnrolled.length,
            currentIds: currentEnrolled,
            expectedIds: expectedEnrolled,
            match: JSON.stringify(currentEnrolled.sort()) === JSON.stringify(expectedEnrolled.sort())
          })
          
          // Always create new object reference to force re-render
          const fresh = { ...prevEnrolls }
          Object.keys(fresh).forEach(key => {
            fresh[key] = [...(fresh[key] || [])]
          })
          // Ensure the subject has the correct enrollments (use normalized version)
          fresh[studentSubjectFilter] = [...expectedEnrolled]
          return fresh
        })
        
        setStudents(prevStudents => {
          // Always return new array reference
          const fresh = [...updatedStudentsList]
          if (prevStudents.length !== fresh.length) {
            console.log(`ðŸ”„ Final force update ${i + 1}/${forceUpdateCount} - students:`, {
              current: prevStudents.length,
              expected: fresh.length
            })
          }
          return fresh
        })
      }, (i + 1) * 500) // Stagger updates: 500ms, 1000ms, 1500ms
    }

    // Show results
    if (successCount > 0) {
      addCustomAlert('success', 'Import Complete', 
        `Successfully imported ${successCount} student(s) to ${subject.name}.${errorCount > 0 ? ` ${errorCount} error(s) occurred.` : ''}`, 
        false
      )
      console.log(`âœ… Import complete: ${successCount} students imported to ${subject.name}`, {
        subject: studentSubjectFilter,
        studentsAdded: successCount,
        totalStudents: updatedStudentsList.length,
        enrolledInSubject: updatedEnrolls[studentSubjectFilter].length,
        enrolledStudentIds: updatedEnrolls[studentSubjectFilter],
        errors: errorCount,
        studentsList: students.length,
        enrollsForSubject: enrolls[studentSubjectFilter]?.length || 0
      })
      
      // Force a UI refresh by logging current state
      setTimeout(() => {
        console.log('ðŸ” Current UI state check:', {
          studentsInState: students.length,
          enrollsInState: enrolls[studentSubjectFilter]?.length || 0,
          enrollsArray: enrolls[studentSubjectFilter] || []
        })
      }, 500)
    } else {
      addCustomAlert('error', 'Import Failed', 
        `No students were imported. ${errorCount > 0 ? `${errorCount} error(s) occurred.` : 'Please check the file format.'}`, 
        false
      )
    }
    
    if (errorCount > 0 && errors.length > 0) {
      console.warn('Import errors:', errors)
      // Show first few errors in console for debugging
      errors.slice(0, 5).forEach(err => console.warn('  -', err))
      if (errors.length > 5) {
        console.warn(`  ... and ${errors.length - 5} more errors`)
      }
    }

    // Close modal and reset after a short delay to show success message
    setTimeout(() => {
      setShowAddStudentModal(false)
      setCsvFile(null)
      setCsvPreview([])
      setStudentSubjectFilter('')
      // Reset file input
      const fileInput = document.getElementById('csvFileInput')
      if (fileInput) fileInput.value = ''
    }, successCount > 0 ? 1500 : 0)
  }

  const handleProfileSave = async (e) => {
    e.preventDefault()
    
    // Validation: Check if user is authenticated
    if (!profUid) {
      addCustomAlert('error', 'Authentication Error', 'Unable to determine your account. Please sign in again.', false)
      return
    }

    // Validation: Name field
    const updatedName = profileForm.name?.trim() || ''
    if (!updatedName) {
      addCustomAlert('warning', 'Missing Name', 'Please enter your name.', false)
      return
    }
    if (updatedName.length < 2) {
      addCustomAlert('warning', 'Invalid Name', 'Name must be at least 2 characters long.', false)
      return
    }
    if (updatedName.length > 100) {
      addCustomAlert('warning', 'Invalid Name', 'Name must be less than 100 characters.', false)
      return
    }

    // Validation: Profile picture (if provided)
    let photoData = profPic
    if (profileForm.pic) {
      const file = profileForm.pic
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        addCustomAlert('error', 'Invalid File Type', 'Please select a valid image file.', false)
        return
      }
      
      // Validate file size (max 5MB)
      const maxSize = 5 * 1024 * 1024 // 5MB in bytes
      if (file.size > maxSize) {
        addCustomAlert('error', 'File Too Large', 'Image file size must be less than 5MB. Please choose a smaller image.', false)
        return
      }
      
      try {
        photoData = await fileToDataUrl(file)
      } catch (error) {
        console.error('Failed to process image file', error)
        addCustomAlert('error', 'Image Processing Error', 'Unable to process the selected image. Please try a different file.', false)
        return
      }
    }

    try {
      // Save to Firestore
      const updatedProfile = {
        ...(profProfile || {}),
        name: updatedName,
        email: profEmail || profProfile?.email || '',
        department: profProfile?.department || '',
        photoURL: photoData || null,
      }

      // Save to Firestore (await to ensure completion)
      await setProfessor(profUid, updatedProfile)

      // Update local state immediately (optimistic update)
      setProfName(updatedName)
      setProfPic(photoData)
      setProfProfile(updatedProfile)
      setProfilePreview(photoData)
      updateSessionUser({ name: updatedName })

      // Show success message and close modal quickly (within 1 second total)
      setProfileSaveSuccess(true)

      // Auto-close modal after 300ms (ensures total process completes within 1 second)
      setTimeout(() => {
        setShowProfileModal(false)
        setProfileSaveSuccess(false)
        // Reset form for next time
        setProfileForm({ name: '', pic: null })
      }, 300)
    } catch (error) {
      console.error('Failed to save professor profile', error)
      addCustomAlert('error', 'Save Failed', 'Unable to save profile changes right now. Please try again.', false)
    }
  }

  const fileToDataUrl = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = (evt) => resolve(evt.target.result)
      reader.onerror = reject
      reader.readAsDataURL(file)
    })
  }

  // ============================================================================
  // NOTIFICATION SYSTEM - Academic Focus
  // ============================================================================
  
  /**
   * Categorizes notifications into academic (high priority) and administrative (low priority)
   */
  const categorizeNotifications = useCallback((notificationList) => {
    const academic = []
    const administrative = []
    
    notificationList.forEach(alert => {
      const title = alert.title || ''
      const message = alert.message || ''
    const type = alert.type || ''
      
      // Check if it's an administrative notification
      const isAdministrative = 
        title.includes('Student Archived') ||
        title.includes('Successfully restored') ||
        title.includes('Archive') ||
        title.includes('Restore') ||
        message.includes('archived') ||
        message.includes('restored')
      
      if (isAdministrative) {
        administrative.push(alert)
      } else {
        // Academic notifications (everything else)
        academic.push(alert)
      }
    })
    
    return { academic, administrative }
  }, [])
  
  /**
   * Groups administrative notifications into a summary
   */
  const groupAdministrativeNotifications = useCallback((adminNotifications) => {
    if (adminNotifications.length === 0) return null
    
    const archived = adminNotifications.filter(n => 
      n.title.includes('Student Archived') || n.message.includes('archived')
    ).length
    
    const restored = adminNotifications.filter(n => 
      n.title.includes('Successfully restored') || n.message.includes('restored')
    ).length
    
    const total = adminNotifications.length
    const latestTimestamp = adminNotifications.reduce((latest, n) => {
      let timestamp = n.timestamp
      // Normalize timestamp - handle Firestore Timestamp, ISO strings, numbers, Date objects
      if (timestamp && typeof timestamp === 'object' && timestamp.toDate) {
        timestamp = timestamp.toDate()
      } else if (typeof timestamp === 'string') {
        timestamp = new Date(timestamp)
      } else if (typeof timestamp === 'number') {
        timestamp = timestamp > 1e12 ? new Date(timestamp) : new Date(timestamp * 1000)
      } else if (!(timestamp instanceof Date)) {
        timestamp = new Date()
      }
      const timestampMs = timestamp instanceof Date ? timestamp.getTime() : new Date().getTime()
      // Only use valid timestamps (not 0 or negative)
      return timestampMs > latest && !isNaN(timestampMs) && timestampMs > 0 ? timestampMs : latest
    }, 0)
    
    // Ensure we have a valid timestamp (use current time if all were invalid)
    const validTimestamp = latestTimestamp > 0 ? new Date(latestTimestamp) : new Date()
    
    return {
      id: 'admin-summary',
      type: 'administrative',
      title: 'Administrative Update',
      message: `${archived > 0 ? `${archived} student(s) archived` : ''}${archived > 0 && restored > 0 ? ', ' : ''}${restored > 0 ? `${restored} student(s) restored` : ''}`,
      timestamp: validTimestamp,
      read: adminNotifications.every(n => n.read),
      count: total,
      originalNotifications: adminNotifications
    }
  }, [])
  
  /**
   * Extracts actionable information from notification for better display
   */
  const parseNotificationData = useCallback((alert) => {
    const title = alert.title || ''
    const message = alert.message || ''
    const type = alert.type || ''
    
    // Extract student name, course code, assignment name from message
    const studentMatch = message.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s*\((\d+)\)/)
    const messageCourseMatch = message.match(/([A-Z]{2,}\d{3}|[A-Z]+\s+\d+)/)
    const assignmentMatch = message.match(/submitted\s+([^f]+?)\s+for/i) || 
                           message.match(/\[([^\]]+)\]/)
    const courseCode = alert.subjectCode || messageCourseMatch?.[1] || null
    
    const isEnrollmentRelated = alert.type === 'subject' || alert.type === 'enrollment' || title.includes('Enrolled')
    
    return {
      studentName: studentMatch ? studentMatch[1] : null,
      studentId: studentMatch ? studentMatch[2] : null,
      courseCode: alert.target_courseId || alert.subjectCode || courseCode,
      assignmentName: assignmentMatch ? assignmentMatch[1] : null,
      isGradeRelated: type === 'grade' || title.includes('Grade') || message.includes('submitted') || message.includes('grading'),
      isAttendanceRelated: type === 'attendance' || title.includes('Attendance') || message.includes('absent'),
      isEnrollmentRelated,
      isContentRelated: title.includes('Material') || title.includes('Content') || message.includes('posted'),
      isDiscussionRelated: message.includes('discussion') || message.includes('replies'),
    }
  }, [])
  
  /**
   * Gets notification icon based on category
   */
  const getNotificationIcon = useCallback((alert, parsedData) => {
    if (parsedData.isGradeRelated) {
      return (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      )
    }
    
    if (parsedData.isAttendanceRelated) {
      return (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      )
    }
    
    if (parsedData.isEnrollmentRelated) {
      return (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422A12.083 12.083 0 0112 21.5a12.083 12.083 0 01-6.16-10.922L12 14z" />
        </svg>
      )
    }
    
    if (parsedData.isContentRelated) {
      return (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
      )
    }
    
    if (parsedData.isDiscussionRelated) {
      return (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      )
    }
    
    // Administrative or default
    return (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    )
  }, [])
  
  /**
   * Gets notification icon color classes with red/maroon theme
   */
  const getNotificationIconColor = useCallback((parsedData, isAdministrative) => {
    if (isAdministrative) {
      return 'text-slate-600 bg-slate-100 border-2 border-slate-200'
    }
    
    if (parsedData.isGradeRelated) {
      return 'text-red-700 bg-red-100 border-2 border-red-300'
    }
    
    if (parsedData.isAttendanceRelated) {
      return 'text-red-600 bg-red-50 border-2 border-red-200'
    }
    
    if (parsedData.isContentRelated) {
      return 'text-rose-700 bg-rose-100 border-2 border-rose-300'
    }
    
    if (parsedData.isDiscussionRelated) {
      return 'text-red-800 bg-red-100 border-2 border-red-400'
    }
    
    return 'text-[#7A1315] bg-red-50 border-2 border-red-200'
  }, [])
  
  /**
   * Gets notification border color class with red/maroon theme
   */
  const getNotificationBorderColor = useCallback((parsedData, isAdministrative, isRead) => {
    if (isAdministrative) {
      return isRead ? 'border-l-4 border-slate-300' : 'border-l-4 border-slate-400'
    }
    
    if (parsedData.isGradeRelated) {
      return isRead ? 'border-l-4 border-red-300' : 'border-l-4 border-red-600'
    }
    
    if (parsedData.isAttendanceRelated) {
      return isRead ? 'border-l-4 border-red-200' : 'border-l-4 border-red-500'
    }
    
    if (parsedData.isContentRelated) {
      return isRead ? 'border-l-4 border-rose-300' : 'border-l-4 border-rose-600'
    }
    
    if (parsedData.isDiscussionRelated) {
      return isRead ? 'border-l-4 border-red-400' : 'border-l-4 border-[#7A1315]'
    }
    
    return isRead ? 'border-l-4 border-red-200' : 'border-l-4 border-[#7A1315]'
  }, [])
  
  /**
   * Gets notification background color class with red/maroon theme
   */
  const getNotificationBgColor = useCallback((parsedData, isAdministrative, isRead) => {
    if (isAdministrative) {
      return isRead ? 'bg-slate-50/30' : 'bg-slate-50/60'
    }
    
    if (parsedData.isGradeRelated) {
      return isRead ? 'bg-red-50/30' : 'bg-red-50/60'
    }
    
    if (parsedData.isAttendanceRelated) {
      return isRead ? 'bg-red-50/20' : 'bg-red-50/50'
    }
    
    if (parsedData.isContentRelated) {
      return isRead ? 'bg-rose-50/30' : 'bg-rose-50/60'
    }
    
    if (parsedData.isDiscussionRelated) {
      return isRead ? 'bg-red-50/30' : 'bg-red-50/60'
    }
    
    return isRead ? 'bg-red-50/20' : 'bg-red-50/50'
  }, [])
  
  /**
   * Gets action button color classes with red/maroon theme
   */
  const getActionButtonColor = useCallback((parsedData) => {
    if (parsedData.isGradeRelated) {
      return 'text-red-700 hover:text-red-800 hover:bg-red-50'
    }
    
    if (parsedData.isAttendanceRelated) {
      return 'text-red-600 hover:text-red-700 hover:bg-red-50'
    }
    
    if (parsedData.isContentRelated) {
      return 'text-rose-700 hover:text-rose-800 hover:bg-rose-50'
    }
    
    if (parsedData.isDiscussionRelated) {
      return 'text-[#7A1315] hover:text-red-900 hover:bg-red-50'
    }
    
    return 'text-[#7A1315] hover:text-red-800 hover:bg-red-50'
  }, [])
  
  /**
   * Gets title color class with red/maroon theme
   */
  const getTitleColor = useCallback((parsedData, isAdministrative) => {
    if (isAdministrative) {
      return 'text-slate-700'
    }
    
    if (parsedData.isGradeRelated) {
      return 'text-red-700'
    }
    
    if (parsedData.isAttendanceRelated) {
      return 'text-red-600'
    }
    
    if (parsedData.isContentRelated) {
      return 'text-rose-700'
    }
    
    if (parsedData.isDiscussionRelated) {
      return 'text-[#7A1315]'
    }
    
    return 'text-[#7A1315]'
  }, [])
  
  /**
   * Gets action button text and handler for professor notifications
   */
  const getNotificationAction = useCallback((alert, parsedData) => {
    return null
  }, [])
  
  /**
   * Formats notification title for professor (action-oriented)
   */
  const formatNotificationTitle = useCallback((alert, parsedData) => {
    if (parsedData.isGradeRelated) {
      if (alert.message.includes('submitted') || alert.message.includes('submission')) {
        return 'New Submission Received'
      }
      if (alert.message.includes('ungraded') || alert.message.includes('Grading Reminder') || alert.message.includes('deadline')) {
        return 'Grading Reminder'
      }
      return 'New Grade Posted'
    }
    
    if (parsedData.isAttendanceRelated) {
      return 'Attendance Alert'
    }
    
    if (parsedData.isEnrollmentRelated) {
      return 'Student Enrolled'
    }
    
    if (parsedData.isContentRelated) {
      return 'Material Released'
    }
    
    if (parsedData.isDiscussionRelated) {
      return 'Discussion Response'
    }
    
    return alert.title
  }, [])
  
  /**
   * Formats notification body text for professor (includes student name, course code, assignment)
   */
  const formatNotificationBody = useCallback((alert, parsedData) => {
    if (parsedData.isGradeRelated && parsedData.studentName && parsedData.assignmentName && parsedData.courseCode) {
      return `${parsedData.studentName} submitted ${parsedData.assignmentName} for ${parsedData.courseCode}`
    }
    
    if (parsedData.isGradeRelated && parsedData.courseCode && alert.message.includes('ungraded')) {
      const ungradedMatch = alert.message.match(/(\d+)\s+ungraded/)
      const ungradedCount = ungradedMatch ? ungradedMatch[1] : 'multiple'
      return `${ungradedCount} ungraded submissions in ${parsedData.courseCode}`
    }
    
    if (parsedData.isAttendanceRelated && parsedData.studentName && parsedData.courseCode) {
      const absentMatch = alert.message.match(/(\d+)\s+times?/)
      const absentCount = absentMatch ? absentMatch[1] : 'multiple'
      return `${parsedData.studentName} has missed ${absentCount} classes in ${parsedData.courseCode}`
    }
    
    if (parsedData.isEnrollmentRelated && alert.message) {
      return alert.message
    }
    
    if (parsedData.isContentRelated && parsedData.courseCode) {
      const moduleMatch = alert.message.match(/\[([^\]]+)\]/)
      const moduleName = moduleMatch ? moduleMatch[1] : 'new materials'
      return `${moduleName} materials have been released for ${parsedData.courseCode}`
    }
    
    if (parsedData.isDiscussionRelated && parsedData.studentName && parsedData.courseCode) {
      return `${parsedData.studentName} replied to your post in ${parsedData.courseCode}`
    }
    
    return alert.message
  }, [])
  
  /**
   * Checks if notification is high priority/urgent (for yellow border highlight)
   */
  const isUrgentNotification = useCallback((alert, parsedData) => {
    // Grading reminders with deadlines passed are urgent
    if (parsedData.isGradeRelated && (alert.message.includes('deadline') || alert.message.includes('overdue'))) {
      return true
    }
    
    // Attendance threshold alerts are urgent
    if (parsedData.isAttendanceRelated) {
      return true
    }
    
    // Check if due date is in the past or very soon
    if (parsedData.isGradeRelated && alert.message.includes('due')) {
      const dateMatch = alert.message.match(/(\d{4}-\d{2}-\d{2})/)
      if (dateMatch) {
        const dueDate = new Date(dateMatch[1])
        const now = new Date()
        const daysUntilDue = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24))
        return daysUntilDue <= 1 // Urgent if due today or overdue
      }
    }
    
    return false
  }, [])
  
  /**
   * Formats timestamp as "X minutes ago" or similar
   */
  const formatTimestamp = useCallback((timestamp) => {
    if (!timestamp) return 'Just now'
    
    let time
    // Handle Firestore Timestamp objects
    if (timestamp && typeof timestamp === 'object' && timestamp.toDate) {
      time = timestamp.toDate()
    }
    // Handle Date objects
    else if (timestamp instanceof Date) {
      time = timestamp
    }
    // Handle numbers (milliseconds or seconds)
    else if (typeof timestamp === 'number') {
      // Check if it's 0 or negative (invalid)
      if (timestamp <= 0) {
        return 'Just now'
      }
      time = timestamp > 1e12 ? new Date(timestamp) : new Date(timestamp * 1000)
    }
    // Handle ISO strings
    else if (typeof timestamp === 'string') {
      const parsed = Date.parse(timestamp)
      if (!Number.isNaN(parsed) && parsed > 0) {
        time = new Date(parsed)
      }
    }
    
    // Validate the date
    if (!time || Number.isNaN(time.getTime()) || time.getTime() <= 0) {
      // Invalid timestamp - return "Just now"
      return 'Just now'
    }
    
    // Check if date is too old (before 1970) or in the future (more than 1 year)
    const now = new Date()
    const oneYearFromNow = new Date(now.getFullYear() + 1, now.getMonth(), now.getDate())
    if (time.getTime() < 0 || time > oneYearFromNow) {
      return 'Just now'
    }
    
    // Calculate time difference
    const diffMs = now - time
    const diffMins = Math.floor(diffMs / 60000)
    const diffHours = Math.floor(diffMs / 3600000)
    const diffDays = Math.floor(diffMs / 86400000)
    const diffWeeks = Math.floor(diffDays / 7)
    const diffMonths = Math.floor(diffDays / 30)

    if (diffMins < 1) return 'Just now'
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`
    if (diffWeeks < 5) return `${diffWeeks} week${diffWeeks !== 1 ? 's' : ''} ago`
    if (diffMonths < 12) return `${diffMonths} month${diffMonths !== 1 ? 's' : ''} ago`

    return time.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
  }, [])

  const activeNotifications = viewMode === 'student' ? studentAlerts : alerts
  // UNIFORM: Always show professor notification count regardless of view mode
  // This ensures the notification badge count stays consistent when switching between Professor/Student Record views
  const unreadAlertsCount = alerts.filter(a => !a.read).length

  return (
    <div className={isDarkMode ? 'bg-[#020617] min-h-screen' : 'bg-white min-h-screen'}>
      {/* Header */}
      <header className={`sticky top-0 z-40 bg-white/95 backdrop-blur-md ${
        isDarkMode ? 'bg-[#020617]/95' : ''
      } shadow-sm`}>
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 sm:gap-0 py-4 sm:py-6">
            <div className="flex items-start space-x-3 sm:space-x-4 flex-shrink-0 min-w-0">
              <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center shadowLg overflow-hidden flex-shrink-0">
                <img src="/assets/logos/um logo.png" alt="UM Logo" className="w-full h-full object-contain" />
              </div>
              <div className="min-w-0 flex-1">
                <h1 className="text-lg sm:text-xl lg:text-3xl font-bold textGrad truncate">Student iTrack</h1>
                <p className="text-xs sm:text-sm text-slate-600 font-medium truncate">Smart Academic Monitoring System</p>
              </div>
            </div>
            <div className="flex items-center space-x-2 sm:space-x-4 lg:space-x-6 flex-wrap sm:flex-nowrap w-full sm:w-auto justify-end">
              <label htmlFor="view-mode-select" className="sr-only">View Mode</label>
              <select
                id="view-mode-select"
                name="view-mode-select"
                value={viewMode}
                onChange={(e) => setViewMode(e.target.value)}
                className="record-toggle-select focus:ring-2 focus:ring-maroon-500"
              >
                <option value="professor">Professor Record</option>
                <option value="student">Student Record</option>
              </select>
              
              {/* Notifications */}
              <div className="relative">
                <button
                  onClick={() => setShowNotifDropdown(!showNotifDropdown)}
                  className={`icon-button relative transition-all duration-200 ${
                    isDarkMode
                      ? showNotifDropdown 
                          ? 'bg-red-900/50 text-red-300' 
                        : 'hover:bg-slate-700'
                      : showNotifDropdown 
                        ? 'bg-red-100 text-red-700' 
                        : 'hover:bg-slate-100'
                  }`}
                >
                  <svg className={`w-5 h-5 ${
                    isDarkMode ? 'text-white' : 'text-slate-700'
                  }`} fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
                  </svg>
                  {unreadAlertsCount > 0 && (
                    <span className={`absolute -top-1 -right-1 w-6 h-6 text-xs font-bold rounded-full flex items-center justify-center shadow-lg border-2 animate-pulse ${
                      isDarkMode
                          ? 'bg-[#7A1315] text-white border-red-400'
                        : 'bg-gradient-to-br from-red-500 to-red-600 text-white border-white'
                    }`}>
                      {unreadAlertsCount > 9 ? '9+' : unreadAlertsCount}
                    </span>
                  )}
                </button>
                
                {showNotifDropdown && (() => {
                  const { academic, administrative } = categorizeNotifications(alerts)
                  const adminSummary = groupAdministrativeNotifications(administrative)
                  const displayNotifications = [...academic]
                  if (adminSummary) {
                    displayNotifications.push(adminSummary)
                  }
                  
                  return (
                    <div className={`absolute right-0 mt-2 w-[calc(100vw-2rem)] sm:w-[420px] max-w-[420px] rounded-2xl shadow-2xl border-2 z-50 overflow-hidden ${
                      isDarkMode 
                        ? 'bg-[#1a1a1a] border-slate-700' 
                        : 'bg-white border-slate-200'
                    }`}>
                      {/* Enhanced Header with Red/Maroon Gradient */}
                      <div className={`p-5 border-b-2 ${
                        isDarkMode 
                          ? 'bg-gradient-to-br from-red-600 via-[#7A1315] to-red-800 border-slate-700' 
                          : 'border-slate-200 bg-gradient-to-br from-red-600 via-[#7A1315] to-red-800'
                      }`}>
                        <div className="flex items-center justify-between">
                          <div>
                            <h3 className="font-bold text-white text-xl flex items-center gap-2">
                              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
                              </svg>
                              Notifications
                            </h3>
                            <p className="text-xs text-red-100 mt-1 font-medium">Academic Activity & Updates</p>
                    </div>
                          {unreadAlertsCount > 0 && (
                            <div className={`backdrop-blur-sm px-3 py-1 rounded-full border ${
                              isDarkMode 
                                  ? 'bg-[#7A1315]/90 border-red-400' 
                                : 'bg-white/20 border-white/30'
                            }`}>
                                <span className="font-bold text-sm text-white">{unreadAlertsCount}</span>
                            </div>
                          )}
                        </div>
                      </div>
                      
                      {/* Notifications List */}
                      <div className={`max-h-[500px] overflow-y-auto ${
                        isDarkMode 
                          ? 'bg-[#1a1a1a]' 
                          : 'bg-gradient-to-b from-slate-50 to-white'
                      }`}>
                        {displayNotifications.length === 0 ? (
                          <div className="p-12 text-center">
                            <div className={`w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center ${
                              isDarkMode
                                ? 'bg-gradient-to-br from-red-900/30 to-rose-900/30'
                                : 'bg-gradient-to-br from-red-100 to-rose-100'
                            }`}>
                              <svg className="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                              </svg>
                            </div>
                            <p className={`text-sm font-medium ${
                              isDarkMode ? 'text-slate-300' : 'text-slate-500'
                            }`}>No new notifications</p>
                            <p className={`text-xs mt-1 ${
                              isDarkMode ? 'text-slate-400' : 'text-slate-400'
                            }`}>You're all caught up!</p>
                          </div>
                        ) : (
                          displayNotifications.map(alert => {
                            const isAdmin = alert.type === 'administrative'
                            const parsedData = isAdmin ? {} : parseNotificationData(alert)
                            const action = isAdmin ? null : getNotificationAction(alert, parsedData)
                            const formattedTitle = isAdmin ? alert.title : formatNotificationTitle(alert, parsedData)
                            const formattedBody = isAdmin ? alert.message : formatNotificationBody(alert, parsedData)
                            const isUrgent = !isAdmin && isUrgentNotification(alert, parsedData)
                            const timestamp = formatTimestamp(alert.timestamp)
                            
                            return (
                          <div
                            key={alert.id}
                                className={`relative m-3 rounded-xl shadow-md border-2 transition-all duration-200 cursor-pointer group ${
                                  isDarkMode
                                    ? 'bg-[#2c2c2c]'
                                    : 'bg-white'
                                } ${
                                   isUrgent ? 'border-[#7A1315]' : isDarkMode ? 'border-slate-700' : 'border-slate-200'
                                } ${!alert.read ? 'shadow-lg' : 'hover:shadow-lg'} ${isAdmin ? 'opacity-80' : ''}`}
                            onClick={() => {
                              const updatedAlerts = alerts.map(a =>
                                a.id === alert.id ? { ...a, read: true } : a
                              )
                                  if (isAdmin && alert.originalNotifications) {
                                    alert.originalNotifications.forEach(orig => {
                                      const index = updatedAlerts.findIndex(a => a.id === orig.id)
                                      if (index !== -1) {
                                        updatedAlerts[index].read = true
                                      }
                                    })
                                  }
                              setAlerts(updatedAlerts)
                              saveData(subjects, students, enrolls, updatedAlerts, records, grades, profUid).catch(err => 
                                console.warn('Background save failed', err)
                              )
                            }}
                          >
                                {/* Card Content - Compact, Self-Contained */}
                                <div className="p-4">
                                  {/* Header - Bold title with per-notification delete button */}
                                  <div className="flex items-start justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <h4 className={`text-sm font-bold leading-tight ${
                                        isDarkMode
                                            ? isUrgent ? 'text-red-400' : isAdmin ? 'text-white' : 'text-white'
                                          : isAdmin ? 'text-slate-700' : 'text-[#7A1315]'
                                      }`}>
                                        {formattedTitle}
                                      </h4>
                                      {!alert.read && (
                                        <div className={`flex-shrink-0 w-2 h-2 rounded-full ${
                                            isDarkMode ? 'bg-red-400' : 'bg-[#7A1315]'
                                        }`}></div>
                                      )}
                                    </div>
                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation()
                                        let updatedAlerts
                                        
                                        // Handle administrative summary notifications - delete all original notifications
                                        if (isAdmin && alert.originalNotifications && alert.originalNotifications.length > 0) {
                                          // Delete all the original notifications that make up this summary
                                          const originalIds = new Set(alert.originalNotifications.map(n => n.id))
                                          updatedAlerts = alerts.filter(a => !originalIds.has(a.id))
                                          console.log(`Deleted ${originalIds.size} administrative notifications`)
                                        } else if (alert.id === 'admin-summary') {
                                          // Fallback: if it's an admin summary but no originalNotifications, delete all administrative ones
                                          updatedAlerts = alerts.filter(a => {
                                            const title = a.title || ''
                                            const message = a.message || ''
                                            return !(title.includes('Student Archived') || 
                                                    title.includes('Successfully restored') ||
                                                    title.includes('Archive') ||
                                                    title.includes('Restore') ||
                                                    message.includes('archived') ||
                                                    message.includes('restored'))
                                          })
                                          console.log('Deleted all administrative notifications')
                                        } else {
                                          // Regular notification - just filter by ID
                                          updatedAlerts = alerts.filter(a => a.id !== alert.id)
                                        }
                                        
                                        setAlerts(updatedAlerts)
                                        // Save to Firestore immediately (critical operation)
                                        saveData(subjects, students, enrolls, updatedAlerts, records, grades, profUid, true).catch(err =>
                                          console.warn('Background save failed', err)
                                        )
                                      }}
                                      className={`ml-2 rounded-full p-1 text-xs font-bold ${
                                        isDarkMode
                                          ? 'text-slate-300 hover:text-white hover:bg-slate-700'
                                          : 'text-slate-500 hover:text-red-700 hover:bg-red-50'
                                      }`}
                                      aria-label="Delete notification"
                                    >
                                      âœ•
                                    </button>
                                  </div>
                              
                                  {/* Body - Brief, Single-Sentence Statement */}
                                  <p className={`text-xs leading-relaxed mb-3 ${
                                    isDarkMode ? 'text-white' : 'text-slate-700'
                                  }`}>
                                    {formattedBody}
                                  </p>
                                  
                                  {/* Footer - Timestamp and Single Maroon Action Button */}
                                  <div className={`flex items-center justify-between pt-2 border-t ${
                                    isDarkMode ? 'border-slate-700' : 'border-slate-100'
                                  }`}>
                                    <p className={`text-xs font-medium ${
                                      isDarkMode ? 'text-slate-400' : 'text-slate-500'
                                    }`}>
                                      {timestamp}
                                    </p>
                                    {action && (
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation()
                                          const updatedAlerts = alerts.map(a =>
                                            a.id === alert.id ? { ...a, read: true } : a
                                          )
                                          setAlerts(updatedAlerts)
                                          saveData(subjects, students, enrolls, updatedAlerts, records, grades, profUid).catch(err =>
                                            console.warn('Background save failed', err)
                                          )
                                          action.action()
                                        }}
                                        className="bg-[#7A1315] hover:bg-red-800 text-white text-xs font-semibold px-4 py-1.5 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                                      >
                                        {action.text}
                                      </button>
                                    )}
                              </div>
                            </div>
                          </div>
                            )
                          })
                      )}
                    </div>
                      
                      {/* Enhanced Footer */}
                      {displayNotifications.length > 0 && (
                        <div className={`p-4 border-t-2 ${
                          isDarkMode 
                            ? 'border-slate-700 bg-[#1a1a1a]' 
                            : 'border-slate-200 bg-gradient-to-r from-slate-50 to-red-50'
                        }`}>
                      <button
                        onClick={async () => {
                          const updatedAlerts = alerts.map(a => ({ ...a, read: true }))
                          setAlerts(updatedAlerts)
                          saveData(subjects, students, enrolls, updatedAlerts, records, grades, profUid).catch(err =>
                            console.warn('Background save failed', err)
                          )
                        }}
                        className="w-full text-center text-sm font-bold text-white hover:text-white bg-[#7A1315] hover:bg-red-800 px-4 py-2.5 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                      >
                        Clear All Notifications
                      </button>
                  </div>
                )}
                    </div>
                  )
                })()}
              </div>

              <button
                type="button"
                onClick={() => setShowProfileModal(true)}
                className="flex items-center space-x-3 rounded-2xl border border-slate-200 px-3 py-2 hover:bg-white transition-all focus:outline-none focus:ring-2 focus:ring-maroon-500"
              >
                <div className="w-10 h-10 bg-gradient-to-r from-red-800 to-red-600 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                  {profPic ? (
                    <img src={profPic} alt="Profile" className="w-10 h-10 rounded-full object-cover" />
                  ) : (
                    getInitials(profName)
                  )}
                </div>
                <div className="text-left">
                  <p className="text-xs uppercase tracking-wide text-slate-400">Profile</p>
                  <p className="text-sm font-semibold text-slate-700">{profName}</p>
                </div>
                <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M6 9l6 6 6-6" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
              </button>
              
              <button
                onClick={handleLogoutClick}
                className="logout-btn text-white px-6 py-3 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center space-x-2 shadow-lg bg-maroon-600 hover:bg-maroon-700"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 012 2v2h-2V4H4v16h10v-2h2v2a2 2 0 01-2 2H4a2 2 0 01-2-2V4a2 2 0 012-2h10z" />
                </svg>
                <span>Logout</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* Logout Confirmation Modal */}
      {showLogoutModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
          <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-sm w-full mx-4 p-6 border border-slate-200 dark:border-slate-700">
            <h2 className="text-lg font-semibold text-slate-900 dark:text-white mb-2 text-center">
              Confirm Logout
            </h2>
            <p className="text-sm text-slate-600 dark:text-slate-300 mb-6 text-center">
              Are you sure you want to logout?
            </p>
            <div className="flex items-center justify-center gap-3">
              <button
                type="button"
                onClick={handleCancelLogout}
                className="px-4 py-2 rounded-xl text-sm font-semibold border border-maroon-600 text-maroon-700 bg-white hover:bg-red-50 dark:bg-slate-900 dark:text-red-200 dark:border-red-400 dark:hover:bg-slate-800"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={executeLogout}
                className="px-4 py-2 rounded-xl text-sm font-semibold text-white bg-maroon-600 hover:bg-maroon-700 shadow-md"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-10 w-full overflow-x-hidden">
        {viewMode === 'professor' ? (
          <div className="fadeIn">
            {/* Navigation Tabs */}
            <div className="glass rounded-2xl shadow-xl mb-4 sm:mb-6 lg:mb-8 overflow-hidden">
              <nav className="flex overflow-x-auto whitespace-nowrap px-2 sm:px-4 lg:px-8 scrollbar-hide">
                <button
                  onClick={() => { setActiveTab('subjects'); setShowSubjectDetail(false) }}
                  className={`tab-btn relative py-3 sm:py-4 lg:py-6 px-3 sm:px-4 lg:px-6 font-semibold transition-all flex-shrink-0 ${
                    activeTab === 'subjects' 
                      ? 'border-b-[3px] border-maroon-500 text-maroon-600 bg-red-50/50' 
                      : 'border-b-[3px] border-transparent text-slate-600 hover:text-slate-800 hover:bg-slate-50/50'
                  }`}
                >
                  <div className="flex items-center space-x-1 sm:space-x-2">
                    <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                    </svg>
                    <span className="text-sm sm:text-base">Subjects</span>
                  </div>
                </button>
                <button
                  onClick={() => setActiveTab('attendance')}
                  className={`tab-btn relative py-3 sm:py-4 lg:py-6 px-3 sm:px-4 lg:px-6 border-b-3 font-semibold transition-all flex-shrink-0 ${
                    activeTab === 'attendance' 
                      ? 'border-maroon-500 text-maroon-600 bg-red-50/50' 
                      : 'border-transparent text-slate-600 hover:text-slate-800 hover:bg-slate-50/50'
                  }`}
                >
                  <div className="flex items-center space-x-1 sm:space-x-2">
                    <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span className="text-sm sm:text-base">Attendance</span>
                  </div>
                </button>
                <button
                  onClick={() => setActiveTab('grades')}
                  className={`tab-btn relative py-3 sm:py-4 lg:py-6 px-3 sm:px-4 lg:px-6 border-b-3 font-semibold transition-all flex-shrink-0 ${
                    activeTab === 'grades' 
                      ? 'border-maroon-500 text-maroon-600 bg-red-50/50' 
                      : 'border-transparent text-slate-600 hover:text-slate-800 hover:bg-slate-50/50'
                  }`}
                >
                  <div className="flex items-center space-x-1 sm:space-x-2">
                    <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                    <span className="text-sm sm:text-base">Grades</span>
                  </div>
                </button>
                <button
                  onClick={() => setActiveTab('students')}
                  className={`tab-btn relative py-3 sm:py-4 lg:py-6 px-3 sm:px-4 lg:px-6 border-b-3 font-semibold transition-all flex-shrink-0 ${
                    activeTab === 'students' 
                      ? 'border-maroon-500 text-maroon-600 bg-red-50/50' 
                      : 'border-transparent text-slate-600 hover:text-slate-800 hover:bg-slate-50/50'
                  }`}
                >
                  <div className="flex items-center space-x-1 sm:space-x-2">
                    <div className="relative w-4 h-4 sm:w-5 sm:h-5">
                    <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 24 24">
                        {/* Person icon */}
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor" />
                    </svg>
                      {/* Plus sign indicator - positioned in bottom right */}
                      <div className="absolute -bottom-0.5 -right-0.5 w-2 h-2 sm:w-3 sm:h-3 bg-current rounded-full flex items-center justify-center shadow-sm">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={4}>
                          <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                      </div>
                    </div>
                    <span className="text-sm sm:text-base">Students</span>
                  </div>
                </button>
              </nav>
            </div>

          {/* Subjects Tab */}
          {activeTab === 'subjects' && !showSubjectDetail && (
            <div className="glass rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 sm:gap-0 mb-4 sm:mb-6 lg:mb-8">
                <div className="min-w-0 flex-1">
                  <h2 className="text-xl sm:text-2xl font-bold text-slate-800">Subject Management</h2>
                  <p className="text-sm sm:text-base text-slate-600 mt-1">Click on any subject to view enrolled students and manage enrollment</p>
                </div>
                <button
                  onClick={() => setShowAddSubjectModal(true)}
                  className="btn text-white px-4 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold shadowLg hover:shadow-xl transition-all duration-300 flex items-center space-x-2 w-full sm:w-auto justify-center"
                >
                  <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 4v16m8-8H4" />
                  </svg>
                  <span className="text-sm sm:text-base">Add Subject</span>
                </button>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                {subjects.map((subject) => {
                  const enrolledCount = enrolls[subject.code] ? enrolls[subject.code].length : 0
                  return (
                    <div
                      key={`active-${subject.code}`}
                      onClick={() => handleSubjectClick(subject)}
                      className="relative glass card shadowLg p-4 sm:p-6 rounded-2xl flex flex-col items-start space-y-3 sm:space-y-4 clickable cursor-pointer w-full"
                    >
                      <div className="flex items-start justify-between w-full">
                        <div className="flex items-center space-x-4">
                          <div className="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                            <svg className="w-7 h-7 text-maroon-600" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                            </svg>
                          </div>
                          <div className="flex flex-col">
                            <div className="text-sm font-bold text-slate-800">{subject.name}</div>
                            <div className="text-xs text-slate-400">{subject.code} â€¢ {subject.credits} Credits</div>
                            <div className="text-xs text-slate-400">{enrolledCount} enrolled</div>
                          </div>
                        </div>
                        <button
                          onClick={(e) => handleDeleteSubject(subject.code, e)}
                          className="absolute top-3 right-3 text-red-500 hover:text-red-700 font-semibold px-2 py-1 rounded bg-white/80 border border-slate-200"
                        >
                          âœ•
                        </button>
                      </div>
                      <div className="mt-3 text-xs text-slate-500">Click to view enrolled students and manage</div>
                    </div>
                  )
                })}
                {subjects.length === 0 && (
                  <div className="col-span-full text-center text-slate-500 py-8">
                    No subjects yet. Click "Add Subject" to create one.
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Archived Subjects Section */}
          {activeTab === 'subjects' && !showSubjectDetail && (() => {
            const archivedSubjects = getArchivedSubjects()
            if (archivedSubjects.length === 0) return null
            
            return (
              <div className={`glass rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 mt-4 sm:mt-6 lg:mt-8 ${
                isDarkMode ? 'bg-[#1a1a1a]' : ''
              }`}>
                <div className="flex items-center justify-between mb-4 sm:mb-6">
                  <div>
                    <p className={`text-xs sm:text-sm uppercase tracking-wide ${
                      isDarkMode ? 'text-slate-300' : 'text-slate-500'
                    }`}>ARCHIVED SUBJECTS</p>
                    <h3 className={`text-xl sm:text-2xl font-bold ${
                      isDarkMode ? 'text-white' : 'text-slate-900'
                    }`}>Removed Subjects</h3>
                    <p className={`text-xs sm:text-sm mt-1 ${
                      isDarkMode ? 'text-slate-400' : 'text-slate-600'
                    }`}>Subjects removed from Subject Management</p>
                  </div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                  {archivedSubjects.map(subject => {
                    return (
                      <div
                        key={`archived-${subject.code}`}
                        className={`glass card shadowLg p-4 sm:p-6 rounded-2xl w-full ${
                          isDarkMode
                            ? 'bg-[#2c2c2c] border border-slate-700'
                            : ''
                        }`}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex items-center space-x-4">
                            <div className={`w-14 h-14 rounded-xl flex items-center justify-center ${
                              isDarkMode
                                ? 'bg-red-900/30'
                                : 'bg-red-100'
                            }`}>
                              <svg className={`w-7 h-7 ${
                                isDarkMode ? 'text-red-400' : 'text-red-600'
                              }`} fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                              </svg>
                            </div>
                            <div className="flex flex-col">
                              <div className={`text-sm font-bold ${
                                isDarkMode ? 'text-slate-200' : 'text-slate-800'
                              }`}>{subject.name}</div>
                              <div className={`text-xs ${
                                isDarkMode ? 'text-slate-400' : 'text-slate-400'
                              }`}>{subject.code} â€¢ {subject.credits} Credits</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )
                  })}
                </div>
              </div>
            )
          })()}

          {/* Subject Detail View */}
          {activeTab === 'subjects' && showSubjectDetail && selectedSubject && (
            <div className="glass rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 sm:gap-0 mb-4 sm:mb-6 lg:mb-8">
                <div className="flex items-center space-x-3 sm:space-x-4 min-w-0 flex-1">
                  <button
                    onClick={handleBackToSubjects}
                    className="w-10 h-10 sm:w-12 sm:h-12 bg-slate-100 hover:bg-slate-200 rounded-xl flex items-center justify-center transition-all flex-shrink-0"
                  >
                    <svg className="w-5 h-5 sm:w-6 sm:h-6 text-slate-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M19 12H5m7-7l-7 7 7 7" />
                    </svg>
                  </button>
                  <div className="min-w-0">
                    <h2 className="text-xl sm:text-2xl lg:text-3xl font-bold textGrad truncate">{selectedSubject.name}</h2>
                    <p className="text-sm sm:text-base text-slate-600 mt-1 truncate">{selectedSubject.code} â€¢ {selectedSubject.credits} Credits</p>
                  </div>
                </div>
                <div className="flex items-center space-x-2 sm:space-x-4 flex-wrap sm:flex-nowrap w-full sm:w-auto">
                  <button
                    onClick={handleTakeAttendance}
                    className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold shadow-lg transition-all flex items-center space-x-2 text-sm sm:text-base flex-1 sm:flex-initial justify-center"
                  >
                    <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Take Attendance</span>
                  </button>
                  <button
                    onClick={handleManageGrades}
                    className="bg-amber-500 hover:bg-amber-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold shadow-lg transition-all flex items-center space-x-2 text-sm sm:text-base flex-1 sm:flex-initial justify-center"
                  >
                    <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                    <span>Manage Grades</span>
                  </button>
                </div>
              </div>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {enrolls[selectedSubject.code] && enrolls[selectedSubject.code].length > 0 ? (
                  enrolls[selectedSubject.code].map(studentId => {
                    const student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentId))
                    return student ? (
                      <div key={studentId} className="bg-white p-4 rounded-xl border border-slate-200">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-gradient-to-r from-red-800 to-red-600 rounded-full flex items-center justify-center">
                            <span className="text-white font-semibold text-sm">
                              {student.name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase()}
                            </span>
                          </div>
                          <div>
                            <p className="font-semibold text-slate-800">{student.name}</p>
                            <p className="text-xs text-slate-500">ID: {student.id}</p>
                          </div>
                        </div>
                      </div>
                    ) : null
                  })
                ) : (
                  <div className="col-span-3 text-center text-slate-500 py-8">
                    No students enrolled in this subject yet.
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Attendance Tab */}
          {activeTab === 'attendance' && !currentSubject && (
            <div className="glass rounded-2xl shadow-xl p-8">
              <div className="text-center py-12">
                <p className="text-slate-600 text-lg mb-4">No subject selected</p>
                <p className="text-slate-500">Click on a subject and then click "Take Attendance" to manage attendance</p>
              </div>
            </div>
          )}
          {activeTab === 'attendance' && currentSubject && (
            <div className="glass rounded-2xl shadow-xl p-8">
              <div className="flex items-center justify-between mb-8">
                <div className="flex items-center space-x-4">
                  <button
                    onClick={handleBackToSubjects}
                    className="w-12 h-12 bg-slate-100 hover:bg-slate-200 rounded-xl flex items-center justify-center transition-all"
                  >
                    <svg className="w-6 h-6 text-slate-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M19 12H5m7-7l-7 7 7 7" />
                    </svg>
                  </button>
                  <div>
                    <h2 className="text-3xl font-bold textGrad">{currentSubject.name}</h2>
                    <p className="text-slate-600 mt-1">{currentSubject.code} â€¢ {currentSubject.credits} Credits</p>
                  </div>
                </div>
                <div className="flex items-center space-x-4">
                  {/* Live Date & Time Display */}
                  <div className="timeBox rounded-xl px-6 py-4 shadow-lg">
                    <div className="text-center">
                      <div className="flex items-center justify-center space-x-2 mb-2">
                        <div className="w-1.5 h-1.5 indicator rounded-full"></div>
                        <div className="text-xs font-medium text-slate-500 uppercase tracking-wide">Live Time</div>
                      </div>
                      <div className="dateText mb-1">{getCurrentDate()}</div>
                      <div className="timeText">{currentTime}</div>
                      <div className="text-xs text-slate-400 mt-1 font-medium">
                        <span>{Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC+8'}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Date Selection */}
                  <div className="flex flex-col space-y-2">
                    <label htmlFor="attendance-date" className="text-xs font-medium text-slate-600">Attendance Date</label>
                    <input
                      id="attendance-date"
                      name="attendance-date"
                      type="date"
                      value={attendanceDate}
                      onChange={(e) => setAttendanceDate(e.target.value)}
                      className="form-input-field focus:ring-2 focus:ring-maroon-500"
                    />
                    <div className="text-xs text-slate-500 text-center">
                      <span>{getDateDisplay()}</span>
                    </div>
                  </div>
                  
                  {/* Save Button */}
                  <div className="flex flex-col items-center space-y-2">
                    <div className="flex items-center space-x-2 text-xs text-slate-500">
                      <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                      <span>Auto-saving</span>
                    </div>
                    <button
                      onClick={handleSaveAttendance}
                      className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center space-x-2"
                    >
                      <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5 13l4 4L19 7" />
                      </svg>
                      <span>Save Attendance</span>
                    </button>
                  </div>
                </div>
              </div>
              
              {/* Attendance Summary */}
              {(() => {
                const summary = updateAttendanceSummary()
                return (
                  <div className="mb-4 sm:mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-emerald-600 font-medium text-sm">Present</p>
                          <p className="text-2xl font-bold text-emerald-800">{summary.present}</p>
                        </div>
                        <div className="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                          <svg className="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                      </div>
                    </div>
                    
                    <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-red-600 font-medium text-sm">Absent</p>
                          <p className="text-2xl font-bold text-red-800">{summary.absent}</p>
                        </div>
                        <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                          <svg className="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                      </div>
                    </div>
                    
                    <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-blue-600 font-medium text-sm">Total Students</p>
                          <p className="text-2xl font-bold text-blue-800">{summary.total}</p>
                        </div>
                        <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                          <svg className="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                          </svg>
                        </div>
                      </div>
                    </div>
                    
                    <div className="bg-amber-50 border border-amber-200 rounded-xl p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-amber-600 font-medium text-sm">Attendance Rate</p>
                          <p className="text-2xl font-bold text-amber-800">{summary.rate}%</p>
                        </div>
                        <div className="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                          <svg className="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                )
              })()}
              
              {/* Attendance List */}
              <div className="space-y-4">
                {currentSubject && enrolls[currentSubject.code] && enrolls[currentSubject.code].length > 0 ? (
                  enrolls[currentSubject.code].map(studentId => {
                    const student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentId))
                    if (!student) return null
                    const status = getAttendanceStatus(studentId)
                    return (
                      <div
                        key={studentId}
                        className="flex justify-between items-center bg-white border border-slate-200 rounded-xl p-4 transition-all hover:shadow-md"
                      >
                        <div className="flex-grow">
                          <p className="font-semibold text-slate-800">{student.name}</p>
                          <p className="text-sm text-slate-500">{student.id}</p>
                        </div>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => toggleAttendance(studentId, 'present')}
                            className={`w-24 px-4 py-2 rounded-xl text-sm font-medium transition-all ${
                              status === 'present'
                                ? 'bg-emerald-100 text-emerald-700'
                                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                            }`}
                          >
                            Present
                          </button>
                          <button
                            onClick={() => toggleAttendance(studentId, 'absent')}
                            className={`w-24 px-4 py-2 rounded-xl text-sm font-medium transition-all ${
                              status === 'absent'
                                ? 'bg-red-100 text-red-700'
                                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                            }`}
                          >
                            Absent
                          </button>
                        </div>
                      </div>
                    )
                  })
                ) : (
                  <div className="text-center text-slate-500 py-8">
                    No students enrolled in this subject.
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Grades Tab */}
          {activeTab === 'grades' && !currentSubject && (
            <div className="glass rounded-2xl shadow-xl p-8">
              <div className="text-center py-12">
                <p className="text-slate-600 text-lg mb-4">No subject selected</p>
                <p className="text-slate-500">Click on a subject and then click "Manage Grades" to enter grades</p>
              </div>
            </div>
          )}
          {activeTab === 'grades' && currentSubject && (
            <div className="glass rounded-2xl shadow-xl p-8">
              <div className="flex items-center justify-between mb-8">
                <div className="flex items-center space-x-4">
                  <button
                    onClick={handleBackToSubjects}
                    className="w-12 h-12 bg-slate-100 hover:bg-slate-200 rounded-xl flex items-center justify-center transition-all"
                  >
                    <svg className="w-6 h-6 text-slate-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M19 12H5m7-7l-7 7 7 7" />
                    </svg>
                  </button>
                  <div>
                    <h2 className="text-3xl font-bold textGrad">{currentSubject.name}</h2>
                    <p className="text-slate-600 mt-1">{currentSubject.code} â€¢ {currentSubject.credits} Credits</p>
                  </div>
                </div>
                <div className="ml-auto relative">
                  <button
                    onClick={exportGradesCSV}
                    className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center space-x-2"
                  >
                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z" />
                    </svg>
                    <span>Export CSV (Excel)</span>
                  </button>
                </div>
              </div>

              {/* Quick Grade Entry Section */}
              <div className="mb-8">
                <div className={`rounded-2xl p-6 mb-6 ${
                  isDarkMode 
                    ? 'bg-[#2c2c2c]' 
                      : 'bg-white'
                } shadow-md`}>
                  <h3 className={`text-lg font-bold mb-4 ${
                    isDarkMode ? 'text-white' : 'text-maroon-800'
                  }`}>Quick Grade Entry</h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                      <label htmlFor="quick-grade-type" className="sr-only">Grade Type</label>
                      <select
                        id="quick-grade-type"
                        name="quick-grade-type"
                        value={quickGradeType}
                        onChange={(e) => setQuickGradeType(e.target.value)}
                        className="form-select-field-red focus:ring-2 focus:ring-maroon-500"
                      >
                        <option value="quiz">ðŸ“ Quiz</option>
                        <option value="exam">ðŸ“‹ Exam</option>
                        <option value="laboratory">ðŸ”¬ Laboratory</option>
                        <option value="assignment">ðŸ“š Assignment</option>
                        <option value="research">ðŸ” Research</option>
                        <option value="project">ðŸ’¼ Project</option>
                      </select>
                    </div>
                    <div>
                      <label htmlFor="quick-grade-title" className="sr-only">Grade Title</label>
                      <input
                        id="quick-grade-title"
                        name="quick-grade-title"
                        type="text"
                        value={quickGradeTitle}
                        onChange={(e) => setQuickGradeTitle(e.target.value)}
                        placeholder="QUIZ1"
                        className="form-input-field-red focus:ring-2 focus:ring-maroon-500"
                      />
                    </div>
                    <div>
                      <label htmlFor="quick-grade-max-points" className="sr-only">Max Points</label>
                      <input
                        id="quick-grade-max-points"
                        name="quick-grade-max-points"
                        type="number"
                        value={quickGradeMaxPoints}
                        onChange={(e) => setQuickGradeMaxPoints(e.target.value)}
                        placeholder="20"
                        min="1"
                        max="1000"
                        className="form-input-field-red focus:ring-2 focus:ring-maroon-500"
                      />
                    </div>
                    <button
                      onClick={handleInitQuickGrade}
                      className="btn text-white px-6 py-3 rounded-xl font-semibold shadowLg transition-all"
                    >
                      Start Entry
                    </button>
                  </div>
                </div>
                
                {/* Quick Grade Input Grid */}
                {showQuickGradeGrid && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h4 className={`text-lg font-semibold ${
                        isDarkMode ? 'text-white' : 'text-slate-800'
                      }`}>Enter Grades</h4>
                      <div className="flex space-x-3">
                        <button
                          onClick={handleFillAllGrades}
                          className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                            isDarkMode
                              ? 'bg-red-900/50 hover:bg-red-900/70 text-red-200'
                              : 'bg-red-100 hover:bg-red-200 text-red-700'
                          }`}
                        >
                          Fill All Same Score
                        </button>
                        <button
                          onClick={handleSaveAllGrades}
                          className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-xl font-semibold shadowLg transition-all"
                        >
                          Save All Grades
                        </button>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className={`min-w-full border rounded-xl overflow-hidden ${
                        isDarkMode ? 'border-slate-700' : 'border-slate-200'
                      }`}>
                        <thead className={isDarkMode ? 'bg-[#7A1315]' : 'bg-slate-50'}>
                          <tr>
                            <th className={`px-3 py-2 text-left text-xs font-semibold border-b ${
                              isDarkMode 
                                ? 'text-white border-slate-600' 
                                : 'text-slate-600 border-slate-200'
                            }`}>Student ID</th>
                            <th className={`px-3 py-2 text-left text-xs font-semibold border-b ${
                              isDarkMode 
                                ? 'text-white border-slate-600' 
                                : 'text-slate-600 border-slate-200'
                            }`}>Student Name</th>
                            <th className={`px-3 py-2 text-left text-xs font-semibold border-b ${
                              isDarkMode 
                                ? 'text-white border-slate-600' 
                                : 'text-slate-600 border-slate-200'
                            }`}>Score</th>
                          </tr>
                        </thead>
                        <tbody>
                          {currentSubject && enrolls[currentSubject.code] && enrolls[currentSubject.code].map((studentId, index) => {
                            const student = students.find(s => normalizeStudentId(s.id) === normalizeStudentId(studentId))
                            if (!student) return null
                            return (
                              <tr key={studentId} className={isDarkMode && index % 2 === 0 ? 'bg-[#2c2c2c]' : isDarkMode ? 'bg-[#1a1a1a]' : ''}>
                                <td className={`px-3 py-2 text-sm border-b ${
                                  isDarkMode 
                                    ? 'text-white border-slate-700' 
                                    : 'text-slate-700 border-slate-200'
                                }`}>{student.id}</td>
                                <td className={`px-3 py-2 text-sm border-b ${
                                  isDarkMode 
                                    ? 'text-white border-slate-700' 
                                    : 'text-slate-700 border-slate-200'
                                }`}>{student.name}</td>
                                <td className={`px-3 py-2 border-b ${
                                  isDarkMode ? 'border-slate-700' : 'border-slate-200'
                                }`}>
                                  <label htmlFor={`grade-score-${studentId}`} className="sr-only">Score for {student.name}</label>
                                  <input
                                    id={`grade-score-${studentId}`}
                                    name={`grade-score-${studentId}`}
                                    type="number"
                                    value={quickGradeScores[studentId] || ''}
                                    onChange={(e) => setQuickGradeScores(prev => ({ ...prev, [studentId]: e.target.value }))}
                                    placeholder="Score"
                                    className={`w-32 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-maroon-500 ${
                                      isDarkMode
                                        ? 'bg-[#2c2c2c] border-slate-600 text-white'
                                        : 'bg-white border-slate-300'
                                    }`}
                                  />
                                </td>
                              </tr>
                            )
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Students Tab */}
          {activeTab === 'students' && (
            <div className="glass rounded-2xl shadow-xl p-8">
              <div className="flex justify-between items-center mb-8">
                <div>
                  <h2 className={`text-2xl font-bold ${
                    isDarkMode ? 'text-white' : 'text-slate-800'
                  }`}>Student Management</h2>
                  <p className={`mt-1 ${
                    isDarkMode ? 'text-slate-300' : 'text-slate-600'
                  }`}>Manage student profiles and information</p>
                </div>
                <div className="flex items-center space-x-4">
                  <label htmlFor="student-subject-filter" className="sr-only">Filter by Subject</label>
                  <select
                    id="student-subject-filter"
                    name="student-subject-filter"
                    value={studentSubjectFilter}
                    onChange={(e) => setStudentSubjectFilter(e.target.value)}
                    className={`subject-filter-select focus:ring-2 focus:ring-maroon-500 ${
                      isDarkMode 
                        ? 'bg-[#2c2c2c] text-white border-slate-600' 
                        : 'bg-white text-slate-800 border-slate-300'
                    }`}
                  >
                    <option value="">All Subjects</option>
                    {subjects.map(subject => (
                      <option key={subject.code} value={subject.code}>
                        {subject.code} â€” {subject.name}
                      </option>
                    ))}
                  </select>
                  <button
                    onClick={() => {
                      setNewStudent({ id: '', name: '', email: '', subjects: [] })
                      setAddStudentModalTab('import')
                      setCsvFile(null)
                      setCsvPreview([])
                      setShowAddStudentModal(true)
                    }}
                    className="btn text-white px-6 py-3 rounded-xl font-semibold shadowLg hover:shadow-xl transition-all duration-300 flex items-center space-x-2"
                  >
                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 4v16m8-8H4" />
                    </svg>
                    <span>Add Student</span>
                  </button>
                </div>
              </div>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                {subjects
                  .filter(subject => !studentSubjectFilter || subject.code === studentSubjectFilter)
                  .map(subject => {
                    const rawEnrollments = enrolls[subject.code] || []
                    const normalizedEnrollments = rawEnrollments.map(normalizeStudentId).filter(Boolean)
                    
                    // Debug logging to help diagnose enrollment issues
                    if (normalizedEnrollments.length > 0) {
                      console.log(`ðŸ“Š Subject ${subject.code} (${subject.name}):`, {
                        enrolledStudentIds: normalizedEnrollments,
                        totalStudentsInSystem: students.length,
                        foundStudents: normalizedEnrollments.map(id => {
                          const student = studentsById[id]
                          return student ? { id, name: student.name, found: true } : { id, found: false }
                        })
                      })
                    }
                    
                    // Filter out any archived students to ensure data consistency
                    // First try to find students using the memoized map, then fallback to array search
                    const currentStudentObjects = normalizedEnrollments
                      .map(id => {
                        // Try memoized map first (faster)
                        let student = studentsById[id]
                        
                        // Fallback: if not found in map, search in students array
                        // This handles cases where the map might be stale or new students were just added
                        if (!student) {
                          student = students.find(s => normalizeStudentId(s.id) === id)
                        }
                        
                        if (!student) {
                          console.warn(`âš ï¸ Student ID ${id} is enrolled in ${subject.code} but not found in students array`, {
                            enrollmentId: id,
                            subjectCode: subject.code,
                            totalStudents: students.length,
                            studentIds: students.map(s => normalizeStudentId(s.id)),
                            enrollments: normalizedEnrollments,
                            studentsByIdKeys: Object.keys(studentsById)
                          })
                          // CRITICAL: Don't return null - this would filter out the enrollment
                          // Instead, create a placeholder so the enrollment is preserved
                          // This ensures data isn't lost if there's a timing issue
                          return null // Will be filtered out, but enrollment is kept
                        }
                        return student
                      })
                      .filter(Boolean) // Remove nulls (missing students)
                      .filter(student => {
                        // Explicitly exclude students archived from this subject
                        const isArchived = (student.archivedSubjects || []).includes(subject.code)
                        if (isArchived) {
                          console.log(`ðŸ“¦ Student ${student.name} (${student.id}) is archived from ${subject.code}`)
                        }
                        return !isArchived
                      })
                    
                    // Only show current students (archived students are not displayed)
                    const studentObjectsToShow = currentStudentObjects
                    
                    // Debug logging to help diagnose display issues
                    if (normalizedEnrollments.length > 0) {
                      const missingStudents = normalizedEnrollments.filter(id => {
                        return !studentsById[id] && !students.find(s => normalizeStudentId(s.id) === id)
                      })
                      
                      if (missingStudents.length > 0) {
                        console.warn(`âš ï¸ Subject ${subject.code} has ${missingStudents.length} enrolled students not found in students array:`, {
                          missingStudentIds: missingStudents,
                          totalEnrollments: normalizedEnrollments.length,
                          displayedStudents: studentObjectsToShow.length,
                          studentsInSystem: students.length,
                          studentsByIdKeys: Object.keys(studentsById)
                        })
                      } else if (studentObjectsToShow.length !== normalizedEnrollments.length) {
                        console.warn(`âš ï¸ Subject ${subject.code} enrollment count mismatch:`, {
                          enrollments: normalizedEnrollments.length,
                          displayed: studentObjectsToShow.length,
                          difference: normalizedEnrollments.length - studentObjectsToShow.length
                        })
                      } else {
                        console.log(`âœ… Subject ${subject.code}: All ${normalizedEnrollments.length} enrolled students found and displayed`)
                      }
                    }
                    
                    return (
                      <div 
                        key={`${subject.code}-${studentObjectsToShow.length}-${studentObjectsToShow.map(s => s.id).join(',')}-${refreshTrigger}`} 
                        className="glass card shadowLg p-6 rounded-2xl flex flex-col space-y-4"
                      >
                        <div className="flex items-start justify-between">
                          <div>
                            <h3 className="text-xl font-bold text-slate-800">{subject.name}</h3>
                            <p className="text-sm font-medium text-slate-500 mt-1">
                              {subject.code} â€¢ {subject.credits} Credits
                            </p>
                          </div>
                          <div className="flex items-center">
                            <div className="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                              <svg className="w-5 h-5 text-maroon-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                              </svg>
                            </div>
                          </div>
                        </div>
                        <div className="mt-2">
                          <div className="flex justify-between items-center mb-2">
                            <h4 className="font-semibold text-slate-700">
                              Current Students ({studentObjectsToShow.length})
                            </h4>
                            <button
                              onClick={() => {
                                setSelectedSubjectForStudent(subject.code)
                                setStudentToAdd('')
                                setNewStudentQuick({ id: '', name: '', email: '' })
                                setShowAddStudentToSubjectModal(true)
                              }}
                              className="text-sm text-green-600 hover:text-green-800 font-semibold"
                            >
                              Add Student
                            </button>
                          </div>
                          <div className="space-y-2 max-h-48 overflow-y-auto">
                            {studentObjectsToShow.length > 0 ? (
                              studentObjectsToShow.map(student => (
                                <div
                                  key={student.id}
                                  className="flex items-center justify-between bg-slate-50 p-3 rounded-lg"
                                >
                                  <div>
                                    <span className="text-sm text-slate-700">
                                      {student.name}
                                    </span>
                                    <div className="text-xs text-slate-500">
                                      ID: {student.id}
                                    </div>
                                  </div>
                                  <div className="flex items-center">
                                    <button
                                      onClick={() => {
                                        if (window.confirm('Are you sure you want to delete? This will archive the student from this course.')) {
                                          handleArchiveStudent(student.id, subject.code)
                                        }
                                      }}
                                      className="text-red-500 hover:text-red-700 font-semibold px-2 py-1 rounded bg-white/80 border border-slate-200"
                                      title="Archive Student"
                                    >
                                      âœ•
                                    </button>
                                  </div>
                                </div>
                              ))
                            ) : (
                              <div className="text-sm text-slate-500 p-3 bg-slate-50 rounded-lg">
                                No enrolled students.
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )
                  })}
                {subjects.filter(subject => !studentSubjectFilter || subject.code === studentSubjectFilter).length === 0 && (
                  <div className="col-span-3 text-center text-slate-500 py-8">
                    No subjects found.
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      ) : (
        renderStudentView()
      )}
      </main>

      {/* Add Subject Modal */}
      {showAddSubjectModal && (
        <div className="fixed inset-0 modal items-center justify-center z-50 p-4 flex" onClick={() => setShowAddSubjectModal(false)}>
          <div className="glass rounded-2xl p-8 w-full max-w-md shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="text-center mb-6">
              <div className="w-16 h-16 primary rounded-2xl flex items-center justify-center mx-auto mb-4">
                <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                </svg>
              </div>
              <h3 className="text-2xl font-bold text-slate-800 mb-2">Add New Subject</h3>
              <p className="text-slate-600">Create a new academic subject</p>
            </div>
            <form onSubmit={handleAddSubject} className="space-y-5">
              <div>
                <label htmlFor="subject-code" className="sr-only">Subject Code</label>
                <input
                  id="subject-code"
                  name="subject-code"
                  type="text"
                  value={newSubject.code}
                  onChange={(e) => setNewSubject(prev => ({ ...prev, code: e.target.value }))}
                  placeholder="Subject Code"
                  className="form-input-field focus:ring-2 focus:ring-maroon-500"
                  required
                  disabled={isSavingSubject}
                />
              </div>
              <div>
                <label htmlFor="subject-name" className="sr-only">Subject Name</label>
                <input
                  id="subject-name"
                  name="subject-name"
                  type="text"
                  value={newSubject.name}
                  onChange={(e) => setNewSubject(prev => ({ ...prev, name: e.target.value }))}
                  placeholder="Subject Name"
                  className="form-input-field focus:ring-2 focus:ring-maroon-500"
                  required
                  disabled={isSavingSubject}
                />
              </div>
              <div>
                <label htmlFor="subject-credits" className="sr-only">Credits</label>
                <input
                  id="subject-credits"
                  name="subject-credits"
                  type="text"
                  value={newSubject.credits}
                  onChange={(e) => setNewSubject(prev => ({ ...prev, credits: e.target.value }))}
                  placeholder="Credits"
                  className="form-input-field focus:ring-2 focus:ring-maroon-500"
                  required
                  disabled={isSavingSubject}
                />
              </div>
              
              {/* Error Message - Displayed above buttons */}
              {addSubjectError && (
                <div className="bg-red-50 border border-red-200 rounded-xl p-4 flex items-start space-x-3 animate-fade-in">
                  <svg className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                  </svg>
                  <p className="text-red-800 font-medium text-sm flex-1">{addSubjectError}</p>
                </div>
              )}
              
              <div className="flex justify-end space-x-4 mt-8">
                <button
                  type="button"
                  onClick={() => {
                    setShowAddSubjectModal(false)
                    setAddSubjectError('')
                    setIsSavingSubject(false)
                  }}
                  className="px-6 py-3 text-slate-600 hover:text-slate-800 font-medium rounded-xl hover:bg-slate-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled={isSavingSubject}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="btn text-white px-6 py-3 rounded-xl font-semibold shadowLg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled={isSavingSubject}
                >
                  {isSavingSubject ? 'Saving...' : 'Add Subject'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Responsive Profile Modal */}
      {showProfileModal && (
        <div 
          className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"
          onClick={() => {
            setShowProfileModal(false)
            setProfileSaveSuccess(false)
            setProfileSection('account')
          }}
        >
          <div
            className={`w-full max-w-6xl max-h-[90vh] overflow-hidden rounded-2xl shadow-2xl flex flex-col lg:flex-row ${
              isDarkMode ? 'bg-[#1a1a1a]' : 'bg-white'
            }`}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Identity Block - Sidebar (Desktop) / Top (Mobile) */}
            <div className={`lg:w-80 flex-shrink-0 ${
              isDarkMode 
                ? 'bg-[#7A1315]' 
                : 'bg-gradient-to-b from-[#7A1315] to-red-800'
            } flex flex-col`}>
              {/* Profile Picture Container */}
              <div className="p-8 flex flex-col items-center border-b border-red-900/30">
                <div className="relative mb-4 group">
                  <div className="w-28 h-28 rounded-full border-4 border-white shadow-xl bg-gradient-to-br from-red-600 to-[#7A1315] flex items-center justify-center overflow-hidden">
                    {profilePreview || profPic ? (
                      <img 
                        src={profilePreview || profPic} 
                        alt="Profile" 
                        className="w-full h-full object-cover" 
                      />
                    ) : (
                      <span className="text-white text-3xl font-semibold tracking-wide">
                      {getInitials(profileForm.name || profName)}
                    </span>
                  )}
                </div>
                  {/* Change Photo Button */}
                  <label className="absolute inset-0 rounded-full bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer flex items-center justify-center">
                    <span className="text-white text-xs font-medium">Change Photo</span>
                    <input
                      type="file"
                      accept="image/*"
                      onChange={(e) => handleProfilePicSelection(e.target.files[0])}
                      className="absolute inset-0 opacity-0 cursor-pointer"
                      disabled={profileSaveSuccess}
                    />
                  </label>
              </div>
                
                {/* User Name - Bold */}
                <h3 className={`text-white font-bold text-2xl text-center mb-2 ${
                  isDarkMode ? 'text-white' : 'text-white'
                }`}>
                  {profileForm.name || profName}
                </h3>
                
                {/* User Role & Identifier */}
                <p className="text-red-100 text-sm font-medium mb-1">Professor</p>
                <p className="text-red-200 text-xs">{profEmail || 'Institutional Email'}</p>
            </div>

              {/* Settings Navigation - Mobile: Horizontal, Desktop: Vertical */}
              <nav className="flex-1 py-4 overflow-y-auto">
                <button
                  onClick={() => setProfileSection('account')}
                  className={`w-full lg:w-full px-6 py-4 text-left text-white font-medium transition-all flex items-center space-x-3 ${
                    profileSection === 'account' 
                        ? 'bg-red-900/50 border-l-4 border-red-400' 
                      : 'hover:bg-red-900/30'
                  }`}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  <span>Account Settings</span>
                </button>
                
                <button
                  onClick={() => setProfileSection('appearance')}
                  className={`w-full lg:w-full px-6 py-4 text-left text-white font-medium transition-all flex items-center space-x-3 ${
                    profileSection === 'appearance' 
                        ? 'bg-red-900/50 border-l-4 border-red-400' 
                      : 'hover:bg-red-900/30'
                  }`}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                  <span>Appearance</span>
                </button>
              </nav>

              {/* Close Button */}
              <div className="p-4 border-t border-red-900/30">
                <button
                  onClick={() => {
                    setShowProfileModal(false)
                    setProfileSaveSuccess(false)
                    setProfileSection('account')
                  }}
                  className="w-full px-4 py-2 bg-red-900/50 hover:bg-red-900/70 text-white font-medium rounded-lg transition-all"
                >
                  Close Profile
                </button>
              </div>
            </div>

            {/* Main Content Area */}
            <div className={`flex-1 overflow-y-auto ${
              isDarkMode ? 'bg-[#1a1a1a]' : 'bg-white'
            }`}>
              <div className="max-w-4xl mx-auto p-6 lg:p-8">
                {/* Account Settings Section */}
                {profileSection === 'account' && (
                  <div className="space-y-6">
              <div>
                      <h2 className={`text-3xl font-bold mb-2 ${
                        isDarkMode ? 'text-white' : 'text-slate-800'
                      }`}>
                        Account Settings
                      </h2>
                      <p className={isDarkMode ? 'text-slate-300' : 'text-slate-600'}>
                        Manage your personal information and security
                      </p>
                    </div>

                    <div className={`rounded-2xl shadow-lg border p-6 ${
                      isDarkMode 
                        ? 'bg-[#1a1a1a] border-slate-700' 
                        : 'bg-white border-slate-200'
                    }`}>
                      <h3 className={`text-xl font-bold mb-4 ${
                        isDarkMode ? 'text-white' : 'text-slate-800'
                      }`}>
                        Personal Information
                      </h3>
                      <form onSubmit={handleProfileSave} className="space-y-5">
                        <div>
                          <label htmlFor="profile-name" className={`block text-sm font-semibold mb-2 ${
                            isDarkMode ? 'text-white' : 'text-slate-700'
                          }`}>
                            Name
                          </label>
                <input
                  id="profile-name"
                  name="profile-name"
                  type="text"
                  value={profileForm.name}
                  onChange={(e) => setProfileForm(prev => ({ ...prev, name: e.target.value }))}
                            className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-[#7A1315] ${
                              isDarkMode 
                                ? 'bg-[#2c2c2c] border-[#7A1315] text-white' 
                                : 'bg-white border-slate-300 text-slate-800'
                            }`}
                  required
                  disabled={profileSaveSuccess}
                />
              </div>
                        
              <div>
                          <label htmlFor="profile-email" className={`block text-sm font-semibold mb-2 ${
                            isDarkMode ? 'text-white' : 'text-slate-700'
                          }`}>
                            University Email
                          </label>
                          <input
                            id="profile-email"
                            name="profile-email"
                            type="email"
                            value={profEmail || ''}
                            disabled
                            className={`w-full px-4 py-3 border rounded-lg ${
                              isDarkMode 
                                ? 'bg-[#1a1a1a] border-slate-600 text-slate-400' 
                                : 'bg-slate-50 border-slate-300 text-slate-600'
                            }`}
                          />
                          <small className={`text-xs mt-1 block ${
                            isDarkMode ? 'text-slate-400' : 'text-slate-500'
                          }`}>
                            Your institutional email address
                          </small>
                        </div>
                        
                        <div>
                          <label htmlFor="profile-picture" className={`block text-sm font-semibold mb-2 ${
                            isDarkMode ? 'text-slate-200' : 'text-slate-700'
                          }`}>
                            Profile Picture
                          </label>
                <input
                  id="profile-picture"
                  name="profile-picture"
                  type="file"
                  accept="image/*"
                  onChange={(e) => handleProfilePicSelection(e.target.files[0])}
                            className="file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[#7A1315] file:text-white hover:file:bg-red-800"
                  disabled={profileSaveSuccess}
                />
                          <small className={`block text-xs mt-1 ${
                            isDarkMode ? 'text-slate-400' : 'text-slate-500'
                          }`}>
                            Choose a square image for best results
                          </small>
              </div>
              
                        {/* Success Message */}
                        {profileSaveSuccess && (
                          <div className={`rounded-xl p-4 flex items-center space-x-3 border ${
                            isDarkMode 
                              ? 'bg-emerald-900/30 border-emerald-700' 
                              : 'bg-emerald-50 border-emerald-200'
                          }`}>
                            <svg className={`w-5 h-5 flex-shrink-0 ${
                              isDarkMode ? 'text-emerald-400' : 'text-emerald-600'
                            }`} fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                </svg>
                            <p className={`font-medium ${
                              isDarkMode ? 'text-emerald-300' : 'text-emerald-800'
                            }`}>
                              Profile updated successfully!
                            </p>
              </div>
                        )}
              
                        <div className="flex justify-end space-x-3 pt-4">
                <button
                  type="button"
                  onClick={() => {
                    setShowProfileModal(false)
                    setProfileSaveSuccess(false)
                              setProfileSection('account')
                            }}
                            className={`px-5 py-2 rounded-xl font-semibold ${
                              isDarkMode 
                                ? 'bg-slate-700 text-slate-200 hover:bg-slate-600' 
                                : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                            }`}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                            className="px-6 py-2 rounded-xl bg-[#7A1315] text-white font-semibold hover:bg-red-800 shadow-lg disabled:opacity-50"
                  disabled={profileSaveSuccess}
                >
                  Save Changes
                </button>
              </div>
            </form>
                    </div>
                  </div>
                )}

                {/* Appearance Section - Dark/Light Mode Toggle */}
                {profileSection === 'appearance' && (
                  <div className="space-y-6">
                    <div>
                      <h2 className={`text-3xl font-bold mb-2 ${
                        isDarkMode ? 'text-white' : 'text-slate-800'
                      }`}>
                        Appearance
                      </h2>
                      <p className={isDarkMode ? 'text-slate-300' : 'text-slate-600'}>
                        Customize your interface theme and display preferences
                      </p>
                    </div>

                    <div className={`rounded-2xl shadow-lg border p-6 ${
                      isDarkMode 
                        ? 'bg-[#1a1a1a] border-slate-700' 
                        : 'bg-white border-slate-200'
                    }`}>
                      <h3 className={`text-xl font-bold mb-4 ${
                        isDarkMode ? 'text-white' : 'text-slate-800'
                      }`}>
                        Interface Theme
                      </h3>
                      <div className="space-y-4">
                        <div className={`flex items-center justify-between p-4 rounded-xl border ${
                          isDarkMode 
                            ? 'bg-[#2c2c2c] border-slate-700' 
                            : 'bg-slate-50 border-slate-200'
                        }`}>
                          <div className="flex items-center space-x-4">
                            {isDarkMode ? (
                               <svg className="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                              </svg>
                            ) : (
                               <svg className="w-8 h-8 text-[#7A1315]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                              </svg>
                            )}
                            <div>
                              <p className={`font-semibold ${
                                isDarkMode ? 'text-white' : 'text-slate-800'
                              }`}>
                                {isDarkMode ? 'Dark Mode' : 'Light Mode'}
                              </p>
                              <p className={`text-sm ${
                                isDarkMode ? 'text-slate-400' : 'text-slate-600'
                              }`}>
                                {isDarkMode 
                                  ? 'Dark theme for reduced eye strain' 
                                  : 'Light theme for better visibility'}
                              </p>
                            </div>
                          </div>
                          <button
                            type="button"
                            onClick={toggleTheme}
                            className={`relative inline-flex h-8 w-16 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#7A1315] focus:ring-offset-2 ${
                              isDarkMode ? 'bg-[#7A1315]' : 'bg-slate-300'
                            }`}
                            aria-label="Toggle dark mode"
                          >
                            <span
                              className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${
                                isDarkMode ? 'translate-x-9' : 'translate-x-1'
                              }`}
                            />
                          </button>
                        </div>
                        <p className={`text-sm ${
                          isDarkMode ? 'text-slate-400' : 'text-slate-600'
                        }`}>
                          The theme applies system-wide to all screens, maintaining consistent readability and navigation across the application.
                        </p>
                      </div>

                      {/* Real-Time Updates Toggle */}
                      <div className={`rounded-2xl shadow-lg border p-6 ${
                        isDarkMode 
                          ? 'bg-[#1a1a1a] border-slate-700' 
                          : 'bg-white border-slate-200'
                      }`}>
                        <div className="flex items-center justify-between">
                          <div className="flex-1">
                            <h3 className={`text-lg font-semibold mb-1 ${
                              isDarkMode ? 'text-white' : 'text-slate-800'
                            }`}>
                              Real-Time Updates
                            </h3>
                            <p className={`text-sm ${
                              isDarkMode ? 'text-slate-400' : 'text-slate-600'
                            }`}>
                              {realtimeUpdatesDisabled 
                                ? 'Disabled - Reduces Firestore quota usage by 90%+. Data loads once but won\'t update automatically.'
                                : 'Enabled - Dashboard updates automatically when data changes. Uses more Firestore reads.'}
                            </p>
                            {realtimeUpdatesDisabled && (
                              <p className={`text-xs mt-2 ${
                                  isDarkMode ? 'text-red-300' : 'text-amber-600'
                              }`}>
                                âš ï¸ Refresh the page after toggling for changes to take effect.
                              </p>
                            )}
                          </div>
                          <button
                            type="button"
                            onClick={async () => {
                              const newValue = !realtimeUpdatesDisabled
                              try {
                                // Update localStorage immediately (backup)
                                if (newValue) {
                                  localStorage.setItem('disableRealtimeUpdates', 'true')
                                } else {
                                  localStorage.removeItem('disableRealtimeUpdates')
                                }
                                setRealtimeUpdatesDisabled(newValue)
                                
                                // Save to Firestore (primary storage) with localStorage as backup
                                if (profUid) {
                                  try {
                                    const currentProfile = await getProfessorByUid(profUid)
                                    const updatedProfile = {
                                      ...currentProfile,
                                      preferences: {
                                        ...(currentProfile?.preferences || {}),
                                        disableRealtimeUpdates: newValue,
                                      }
                                    }
                                    // Save to Firestore with localStorage backup
                                    // setWithBackup replaced - use updateProfessor instead updatedProfile, { merge: true })
                                    console.log('âœ… Real-time preference saved to Firestore')
                                  } catch (firestoreError) {
                                    // Firestore failed, but localStorage backup already saved
                                    console.warn('Could not save to Firestore, using localStorage backup:', firestoreError.message)
                                  }
                                }
                                
                                addCustomAlert('info', 'Real-Time Updates', 
                                  newValue 
                                    ? 'Real-time updates disabled. Refresh page to apply. This reduces Firestore quota usage significantly.'
                                    : 'Real-time updates enabled. Refresh page to apply.',
                                  false
                                )
                              } catch (error) {
                                console.error('Failed to update real-time settings:', error)
                              }
                            }}
                            className={`relative inline-flex h-8 w-16 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#7A1315] focus:ring-offset-2 ${
                              realtimeUpdatesDisabled ? 'bg-slate-400' : 'bg-[#7A1315]'
                            }`}
                            aria-label="Toggle real-time updates"
                          >
                            <span
                              className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${
                                realtimeUpdatesDisabled ? 'translate-x-1' : 'translate-x-9'
                              }`}
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                    </div>
            </div>
          </div>
        </div>
      )}

      {/* Comprehensive Add Student Modal */}
      {showAddStudentModal && (
        <div className="fixed inset-0 modal items-center justify-center z-50 p-4 flex" onClick={() => {
          setShowAddStudentModal(false)
          setAddStudentModalTab('import')
          setSelectedStudentsForBulk([])
          setSelectedSubjectsForBulk([])
          setSelectAllStudents(false)
          setStudentSearchTerm('') // Clear search when closing modal
          setShowSearchDropdown(false) // Close dropdown
          setArchivedStudentDetailView(null) // Clear detail view
          setCsvFile(null) // Clear CSV file
          setCsvPreview([]) // Clear CSV preview
        }}>
          <div className="glass rounded-2xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            <div className="text-center mb-6">
              <div className="w-20 h-20 mx-auto mb-4 rounded-3xl bg-gradient-to-br from-[#7A1315] via-[#b11e22] to-[#f97373] shadow-xl flex items-center justify-center border border-white/40">
                <div className="relative">
                  {/* Main user silhouette */}
                  <svg className="w-9 h-9 text-white drop-shadow" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12a4 4 0 100-8 4 4 0 000 8zM4 20a8 8 0 0116 0v1.25A.75.75 0 0119.25 22H4.75A.75.75 0 014 21.25V20z" />
                </svg>
                  {/* Add badge */}
                  <span className="absolute -bottom-1 -right-1 inline-flex items-center justify-center w-5 h-5 rounded-full bg-white text-[#7A1315] shadow-md border border-red-100">
                    <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" />
                    </svg>
                  </span>
              </div>
              </div>
              <h3 className="text-2xl font-bold text-slate-800 mb-1">Student Management</h3>
              <p className="text-slate-600 text-sm">Enroll existing students or create new profiles</p>
            </div>

            {/* Tab Navigation */}
            <div className={`flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6 border-b ${
              isDarkMode ? 'border-slate-800' : 'border-white/70'
            }`}>
              <div className={`flex flex-wrap gap-2 p-1 rounded-2xl shadow-inner ${
                isDarkMode ? 'bg-[#111317]' : 'bg-white'
              }`}>
                <button
                  onClick={() => {
                    setAddStudentModalTab('import')
                    setCsvFile(null)
                    setCsvPreview([])
                  }}
                  className={`px-5 py-2 rounded-xl font-semibold transition-all ${
                    addStudentModalTab === 'import'
                      ? isDarkMode
                        ? 'bg-[#7A1315] text-white shadow-lg shadow-red-900/40'
                        : 'bg-white text-maroon-600 shadow'
                      : isDarkMode
                        ? 'text-slate-300 hover:text-white'
                      : 'text-slate-500 hover:text-slate-700'
                  }`}
                >
                  Import File
                </button>
                <button
                  onClick={() => {
                    setAddStudentModalTab('archived')
                    setSelectedStudentsForBulk([])
                    setSelectedSubjectsForBulk([])
                    setSelectAllStudents(false)
                    setStudentSearchTerm('') // Clear search when switching tabs
                    setShowSearchDropdown(false) // Close dropdown
                  }}
                  className={`px-5 py-2 rounded-xl font-semibold transition-all ${
                    addStudentModalTab === 'archived'
                      ? isDarkMode
                        ? 'bg-[#7A1315] text-white shadow-lg shadow-red-900/40'
                        : 'bg-white text-maroon-600 shadow'
                      : isDarkMode
                        ? 'text-slate-300 hover:text-white'
                      : 'text-slate-500 hover:text-slate-700'
                  }`}
                >
                  Archived Students
                </button>
                <button
                  onClick={() => {
                    setAddStudentModalTab('create')
                    setSelectedStudentsForBulk([])
                    setSelectedSubjectsForBulk([])
                    setSelectAllStudents(false)
                    setStudentSearchTerm('') // Clear search when switching tabs
                    setShowSearchDropdown(false) // Close dropdown
                  }}
                  className={`px-5 py-2 rounded-xl font-semibold transition-all ${
                    addStudentModalTab === 'create'
                      ? isDarkMode
                        ? 'bg-[#7A1315] text-white shadow-lg shadow-red-900/40'
                        : 'bg-white text-maroon-600 shadow'
                      : isDarkMode
                        ? 'text-slate-300 hover:text-white'
                      : 'text-slate-500 hover:text-slate-700'
                  }`}
                >
                  Create New Student
                </button>
              </div>
              
              {/* Search Bar - Only show when Archived Students tab is active */}
              {addStudentModalTab === 'archived' && (
                <div className="flex items-center space-x-2">
                  <div className="relative w-64">
                    <input
                      type="text"
                      placeholder="Search by name or ID..."
                      value={studentSearchTerm}
                      onChange={(e) => {
                        setStudentSearchTerm(e.target.value)
                        setShowSearchDropdown(true) // Show dropdown when typing
                      }}
                      onFocus={() => {
                        if (studentSearchTerm.trim()) {
                          setShowSearchDropdown(true) // Show dropdown on focus if there's a search term
                        }
                      }}
                      onBlur={() => {
                        // Delay closing to allow click on dropdown items
                        setTimeout(() => setShowSearchDropdown(false), 200)
                      }}
                      className="pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-maroon-500 focus:border-maroon-500 w-full text-sm"
                    />
                    <svg 
                      className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" 
                      fill="none" 
                      stroke="currentColor" 
                      viewBox="0 0 24 24"
                    >
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    {studentSearchTerm && (
                      <button
                        onClick={() => {
                          setStudentSearchTerm('')
                          setShowSearchDropdown(false)
                        }}
                        className="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                    
                    {/* Autocomplete Dropdown */}
                    {showSearchDropdown && studentSearchTerm.trim() && (() => {
                      // Get filtered students matching the search term
                      const filteredStudents = students.filter(student => {
                        // First filter: Show students archived from selected subjects
                        const matchesSubjectFilter = selectedSubjectsForBulk.length === 0
                          ? (student.archivedSubjects || []).length > 0
                          : selectedSubjectsForBulk.some(subjectCode => 
                              (student.archivedSubjects || []).includes(subjectCode)
                            )
                        
                        if (!matchesSubjectFilter) return false
                        
                        // Second filter: Apply search term (name or ID)
                        const searchLower = studentSearchTerm.toLowerCase().trim()
                        const nameMatch = student.name?.toLowerCase().includes(searchLower) || false
                        const idMatch = student.id?.toString().includes(searchLower) || false
                        
                        return nameMatch || idMatch
                      }).slice(0, 10) // Limit to top 10 results
                      
                      if (filteredStudents.length === 0) return null
                      
                      return (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                          {filteredStudents.map(student => {
                            const normalizedId = normalizeStudentId(student.id)
                            const isSelected = selectedStudentIdSet.has(normalizedId)
                            return (
                              <div
                                key={student.id}
                                onMouseDown={(e) => {
                                  e.preventDefault() // Prevent input blur
                                  if (isSelected) {
                                    setSelectedStudentsForBulk(selectedStudentsForBulk.filter(id => normalizeStudentId(id) !== normalizedId))
                                  } else {
                                    setSelectedStudentsForBulk([...selectedStudentsForBulk, normalizedId])
                                  }
                                  setShowSearchDropdown(false)
                                  setSelectAllStudents(false)
                                }}
                                className={`px-4 py-2 cursor-pointer hover:bg-amber-50 transition-colors flex items-center justify-between ${
                                  isSelected ? 'bg-amber-100' : ''
                                }`}
                              >
                                <div className="flex-1">
                                  <div className="font-medium text-slate-800">{student.name}</div>
                                  <div className="text-xs text-slate-500">ID: {student.id}</div>
                                </div>
                                {isSelected && (
                                  <svg className="w-5 h-5 text-maroon-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                  </svg>
                                )}
                              </div>
                            )
                          })}
                        </div>
                      )
                    })()}
                  </div>
                </div>
              )}
            </div>

            {/* Tab Content */}
            <div className="flex-1 overflow-y-auto">
              {addStudentModalTab === 'import' ? (
                <div className="space-y-6">
                  <div className={`rounded-2xl border shadow-lg px-6 py-5 ${
                    isDarkMode ? 'bg-[#1b1b1b] border-slate-700' : 'bg-white border-slate-200'
                  }`}>
                    <div className="flex items-center justify-between mb-4">
                  <div>
                        <p className="text-xs uppercase tracking-[0.2em] text-maroon-500">Step 1</p>
                        <h4 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                          Select Subject to Enroll
                        </h4>
                        <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                          Choose the class that will receive the uploaded students.
                        </p>
                      </div>
                      <div className={`hidden md:flex items-center px-3 py-1 rounded-full text-xs font-semibold ${
                        isDarkMode ? 'bg-slate-800 text-slate-200' : 'bg-slate-100 text-slate-600'
                      }`}>
                        {subjects.length} subjects available
                      </div>
                    </div>
                    <div className="mt-4">
                    <select
                      value={studentSubjectFilter || ''}
                      onChange={(e) => setStudentSubjectFilter(e.target.value)}
                        className={`form-select-field focus:ring-2 focus:ring-maroon-500 w-full ${
                          isDarkMode ? 'bg-[#111827] border-slate-700 text-slate-100' : ''
                        }`}
                      required
                    >
                      <option value="">-- Select a Subject --</option>
                      {subjects.map(subject => (
                        <option key={subject.code} value={subject.code}>
                          {subject.code} â€” {subject.name}
                        </option>
                      ))}
                    </select>
                    {!studentSubjectFilter && (
                        <p className={`text-xs mt-2 flex items-center gap-1 ${
                          isDarkMode ? 'text-slate-400' : 'text-amber-600'
                        }`}>
                          <span className={`w-2 h-2 rounded-full inline-block ${
                            isDarkMode ? 'bg-slate-500' : 'bg-amber-500'
                          }`} />
                          Please select a subject to enable the import button.
                        </p>
                      )}
                    </div>
                  </div>

                  <div className={`rounded-2xl border shadow-lg px-6 py-5 ${
                    isDarkMode ? 'bg-[#1b1b1b] border-slate-700' : 'bg-white border-slate-200'
                  }`}>
                    <div className="flex items-center justify-between mb-4">
                  <div>
                        <p className="text-xs uppercase tracking-[0.2em] text-maroon-500">Step 2</p>
                        <h4 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                      Upload CSV or Excel File
                        </h4>
                        <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                          Use the official template (ID, Name, Email). Weâ€™ll validate everything before saving.
                        </p>
                      </div>
                      {csvFile && (
                        <span className={`text-xs font-semibold px-3 py-1 rounded-full ${
                          isDarkMode ? 'bg-emerald-500/20 text-emerald-300' : 'bg-emerald-100 text-emerald-700'
                        }`}>
                          {Math.round(csvFile.size / 1024)} KB
                        </span>
                      )}
                    </div>
                    <div className={`border-2 border-dashed rounded-2xl p-6 text-center transition-all ${
                      isDarkMode
                        ? 'border-slate-600 bg-[#151515]/60'
                        : 'border-slate-300 bg-slate-50/70'
                    } ${csvFile ? 'ring-2 ring-maroon-500/40' : ''}`}>
                      <input
                        type="file"
                        accept=".csv,.xlsx,.xls"
                        onChange={(e) => {
                          const file = e.target.files[0]
                          if (file) {
                            setCsvFile(file)
                            setCsvPreview([]) // Clear previous preview
                            parseCSV(file)
                          } else {
                            setCsvFile(null)
                            setCsvPreview([])
                          }
                        }}
                        className="hidden"
                        id="csvFileInput"
                      />
                      <label
                        htmlFor="csvFileInput"
                        className="cursor-pointer flex flex-col items-center space-y-2"
                      >
                        <svg className={`w-12 h-12 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-slate-700'}`}>
                          {csvFile ? csvFile.name : 'Click to upload CSV or Excel file'}
                        </span>
                        <span className={`text-xs ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                          Supported formats: CSV, XLSX, XLS Â· Required columns: ID, Name, Email
                        </span>
                      </label>
                      {csvFile && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            setCsvFile(null)
                            setCsvPreview([])
                            // Reset file input
                            const fileInput = document.getElementById('csvFileInput')
                            if (fileInput) fileInput.value = ''
                          }}
                          className="mt-2 text-xs text-red-500 hover:text-red-700"
                        >
                          Remove file
                        </button>
                      )}
                    </div>
                  </div>

                  {csvPreview.length > 0 ? (
                    <div className={`rounded-2xl border shadow-inner ${
                      isDarkMode ? 'bg-[#101010] border-slate-700' : 'bg-white border-slate-200'
                    }`}>
                      <div className="flex items-center justify-between px-4 pt-4">
                    <div>
                          <p className="text-xs uppercase tracking-[0.3em] text-maroon-500">Step 3</p>
                          <h4 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                        Preview ({csvPreview.length} students)
                          </h4>
                        </div>
                        <button
                          className={`text-xs font-semibold px-3 py-1 rounded-full ${
                            isDarkMode ? 'bg-slate-800 text-slate-200' : 'bg-slate-100 text-slate-600'
                          }`}
                          onClick={() => setCsvPreview([])}
                        >
                          Clear Preview
                        </button>
                      </div>
                      <div className="max-h-64 overflow-y-auto mt-3">
                        <table className="min-w-full divide-y divide-slate-200">
                          <thead className={isDarkMode ? 'bg-slate-800/80' : 'bg-slate-50'}>
                            <tr>
                              <th className="px-4 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">ID</th>
                              <th className="px-4 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Name</th>
                              <th className="px-4 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Email</th>
                            </tr>
                          </thead>
                          <tbody className={isDarkMode ? 'bg-[#0f0f0f] divide-slate-800' : 'bg-white divide-slate-200'}>
                            {csvPreview.map((student, index) => (
                              <tr key={index}>
                                <td className="px-4 py-2 text-sm font-semibold text-slate-800">{student.id}</td>
                                <td className="px-4 py-2 text-sm text-slate-800">{student.name}</td>
                                <td className="px-4 py-2 text-sm text-slate-600">{student.email ? student.email : 'N/A'}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  ) : csvFile ? (
                    <div className={`mt-4 p-4 rounded-2xl border ${
                      isDarkMode ? 'bg-amber-900/20 border-amber-700 text-amber-200' : 'bg-amber-50 border-amber-200 text-amber-800'
                    }`}>
                      <p className="text-sm font-semibold">
                        âš ï¸ No data found in file
                      </p>
                      <p className="text-xs mt-1">
                        Please check that your file contains columns labeled "ID" (or "Student ID") and "Name" (or "Student Name").
                      </p>
                      <p className="text-xs mt-1">
                        Check the browser console (F12) for detailed parsing information.
                      </p>
                    </div>
                  ) : null}

                  <div className={`flex flex-col sm:flex-row sm:justify-end sm:items-center gap-3 pt-4 border-t ${
                    isDarkMode ? 'border-slate-700' : 'border-slate-200'
                  }`}>
                    <button
                      onClick={() => {
                        setShowAddStudentModal(false)
                        setCsvFile(null)
                        setCsvPreview([])
                        setStudentSubjectFilter('')
                      }}
                      className="px-6 py-2 text-slate-600 hover:text-slate-800 font-medium"
                    >
                      Cancel
                    </button>
                    <button
                      type="button"
                      onClick={async (e) => {
                        e.preventDefault()
                        e.stopPropagation()
                        
                        console.log('ðŸš€ Add Student button clicked:', { 
                          csvFile: csvFile?.name, 
                          subject: studentSubjectFilter, 
                          previewCount: csvPreview.length,
                          hasFile: !!csvFile,
                          hasSubject: !!studentSubjectFilter,
                          isImporting,
                          previewData: csvPreview,
                          subjectsAvailable: subjects.length
                        })
                        
                        // Validate before importing
                        if (!csvFile) {
                          console.error('âŒ Validation failed: No file')
                          addCustomAlert('error', 'No File', 'Please upload a CSV or Excel file first.', false)
                          return
                        }
                        if (!studentSubjectFilter) {
                          console.error('âŒ Validation failed: No subject selected')
                          addCustomAlert('error', 'No Subject Selected', 'Please select a subject to enroll students.', false)
                          return
                        }
                        if (csvPreview.length === 0) {
                          console.error('âŒ Validation failed: No preview data', { csvPreview })
                          addCustomAlert('error', 'No Data', 'The file appears to be empty or could not be parsed. Please check the file format and try again.', false)
                          return
                        }
                        
                        try {
                          console.log('âœ… All validations passed, calling handleImportCSV...')
                          await handleImportCSV()
                          console.log('âœ… handleImportCSV completed')
                        } catch (error) {
                          console.error('âŒ Error in handleImportCSV:', error)
                          addCustomAlert('error', 'Import Failed', `Failed to import students: ${error.message}. Please check the console for details.`, false)
                        }
                      }}
                      disabled={!csvFile || !studentSubjectFilter || csvPreview.length === 0 || isImporting}
                      className="btn text-white px-6 py-2 rounded-xl font-semibold shadowLg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                      title={
                        !csvFile ? 'Please upload a file first' :
                        !studentSubjectFilter ? 'Please select a subject first' :
                        csvPreview.length === 0 ? `No data found. Check console (F12) for details. Expected: ID, Name, Email columns.` :
                        isImporting ? 'Import in progress...' :
                        `Click to import ${csvPreview.length} student${csvPreview.length !== 1 ? 's' : ''}`
                      }
                    >
                      {isImporting ? 'Importing...' : 'Add Student'}
                    </button>
                  </div>
                </div>
              ) : addStudentModalTab === 'archived' ? (
                <div className="space-y-6">
                  {/* Subject Selection */}
                  <div className={`rounded-2xl border shadow-lg px-6 py-5 ${
                    isDarkMode ? 'bg-[#1b1b1b] border-slate-700' : 'bg-white border-slate-200'
                  }`}>
                    <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                  <div>
                        <p className="text-xs uppercase tracking-[0.2em] text-maroon-500">Recovery Scope</p>
                        <h4 className={`text-lg font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                      Select Subjects to Restore From
                        </h4>
                        <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                          Choose one or more subjects to re-enroll archived students.
                        </p>
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          type="button"
                          onClick={() => setSelectedSubjectsForBulk([])}
                          className="px-3 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200"
                        >
                          Clear
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            const allSubjects = subjects.map(subject => subject.code)
                            setSelectedSubjectsForBulk(allSubjects)
                          }}
                          className="px-3 py-1 text-xs font-semibold rounded-full bg-emerald-100 text-emerald-700 hover:bg-emerald-200"
                        >
                          Select All
                        </button>
                      </div>
                    </div>
                    <div className="mt-4 relative" ref={restoreSubjectDropdownRef}>
                      <button
                        type="button"
                        onClick={() => setShowRestoreSubjectDropdown(prev => !prev)}
                        className={`w-full flex items-center justify-between rounded-2xl border px-4 py-3 text-left transition-all ${
                          isDarkMode ? 'border-slate-600 bg-[#0f0f0f]' : 'border-slate-200 bg-white'
                        }`}
                      >
                        <div className="pr-4">
                          <p className={`text-xs ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                            {selectedSubjectsForBulk.length > 0
                              ? `${selectedSubjectsForBulk.length} subject${selectedSubjectsForBulk.length === 1 ? '' : 's'} selected`
                              : 'No subjects selected'}
                          </p>
                          <p className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-slate-800'} truncate`}>
                            {selectedSubjectsForBulk.length > 0
                              ? selectedSubjectsForBulk.map(getSubjectLabel).join(', ')
                              : 'Click to choose subjects'}
                          </p>
                        </div>
                        <svg
                          className={`w-5 h-5 flex-shrink-0 transition-transform ${
                            showRestoreSubjectDropdown ? 'rotate-180' : ''
                          } ${isDarkMode ? 'text-white' : 'text-maroon-600'}`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                      {showRestoreSubjectDropdown && (
                        <div
                          className={`absolute z-40 mt-2 w-full rounded-2xl border shadow-2xl ${
                            // Always use a clean white panel for readability
                            'bg-white border-slate-200'
                          }`}
                        >
                          <div className="max-h-56 overflow-y-auto divide-y divide-slate-100">
                            {subjects.length === 0 ? (
                              <p className={`text-sm px-4 py-3 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                                No subjects available.
                              </p>
                            ) : (
                              subjects.map(subject => {
                                const checked = selectedSubjectsForBulk.includes(subject.code)
                                return (
                                  <label
                                    key={subject.code}
                                    className="flex items-center justify-between px-4 py-2 cursor-pointer hover:bg-slate-50"
                                    onMouseDown={e => e.preventDefault()}
                                  >
                                    <div className="flex items-center gap-3">
                                      <input
                                        type="checkbox"
                                        checked={checked}
                                        onChange={() => toggleRestoreSubjectSelection(subject.code)}
                                        className="form-checkbox h-4 w-4 text-maroon-600 rounded"
                                      />
                                      <span className={isDarkMode ? 'text-white' : 'text-slate-800'}>
                          {subject.code} â€” {subject.name}
                                      </span>
                                    </div>
                                    {checked && (
                                      <svg className="w-4 h-4 text-maroon-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                      </svg>
                                    )}
                                  </label>
                                )
                              })
                            )}
                          </div>
                          <div className={`flex items-center justify-end gap-3 px-4 py-2 border-t ${
                            isDarkMode ? 'border-slate-700' : 'border-slate-100'
                          }`}>
                            <button
                              type="button"
                              onClick={() => setShowRestoreSubjectDropdown(false)}
                              className="text-sm font-semibold text-maroon-600 hover:text-maroon-800"
                            >
                              Done
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Archived Student Selection List */}
                  <div>
                      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                        <div>
                      <label className="block text-sm font-semibold text-slate-700">
                            Select Archived Students
                      </label>
                          <p className="text-xs text-slate-500">
                            {selectedStudentsForBulk.length} student{selectedStudentsForBulk.length === 1 ? '' : 's'} selected
                          </p>
                        </div>
                        <div className="flex flex-wrap gap-2 justify-end">
                      <button
                        onClick={() => {
                          const archivedStudents = students.filter(student => {
                            // First filter: Show students archived from selected subjects
                            const matchesSubjectFilter = selectedSubjectsForBulk.length === 0
                              ? (student.archivedSubjects || []).length > 0
                              : selectedSubjectsForBulk.some(subjectCode => 
                                  (student.archivedSubjects || []).includes(subjectCode)
                                )
                            
                            if (!matchesSubjectFilter) return false
                            
                            // Second filter: Apply search term (name or ID)
                            if (studentSearchTerm.trim() === '') return true
                            
                            const searchLower = studentSearchTerm.toLowerCase().trim()
                            const nameMatch = student.name?.toLowerCase().includes(searchLower) || false
                            const idMatch = student.id?.toString().includes(searchLower) || false
                            
                            return nameMatch || idMatch
                          })
                          
                          if (selectAllStudents) {
                            setSelectedStudentsForBulk([])
                            setSelectAllStudents(false)
                            } else {
                              setSelectedStudentsForBulk(archivedStudents.map(s => normalizeStudentId(s.id)).filter(Boolean))
                            setSelectAllStudents(true)
                          }
                        }}
                        className={`px-4 py-2 rounded-lg font-medium text-sm transition-all ${
                          selectAllStudents
                            ? 'bg-maroon-600 text-white hover:bg-maroon-700'
                            : 'bg-slate-200 text-slate-700 hover:bg-slate-300'
                        }`}
                      >
                        {selectAllStudents ? 'Deselect All' : 'Select All'}
                      </button>
                          <button
                            onClick={async () => {
                              if (selectedStudentsForBulk.length === 0) {
                                addCustomAlert('warning', 'No Selection', 'Please select at least one archived student to delete.', false)
                                return
                              }
                              
                              if (!window.confirm(`Delete ${selectedStudentsForBulk.length} selected student(s)? This action cannot be undone.`)) {
                                return
                              }
                              
                              // Remove students from all enrollments
                              const selectedIdSet = new Set(selectedStudentsForBulk.map(normalizeStudentId))
                              let updatedEnrolls = { ...enrolls }
                              Object.keys(updatedEnrolls).forEach(subjectCode => {
                                updatedEnrolls[subjectCode] = (updatedEnrolls[subjectCode] || []).filter(
                                  id => !selectedIdSet.has(normalizeStudentId(id))
                                )
                              })
                              
                              // Remove students from students array
                              const updatedStudents = students.filter(
                                s => !selectedIdSet.has(normalizeStudentId(s.id))
                              )
                              
                              // Remove grades and records for deleted students
                              const updatedGrades = { ...grades }
                              Object.keys(updatedGrades).forEach(key => {
                                const grade = updatedGrades[key]
                                if (grade && selectedStudentIdSet.has(normalizeStudentId(grade.studentId))) {
                                  delete updatedGrades[key]
                                }
                              })
                              
                              const updatedRecords = { ...records }
                              Object.keys(updatedRecords).forEach(key => {
                                const record = updatedRecords[key]
                                if (record && selectedStudentIdSet.has(normalizeStudentId(record.studentId))) {
                                  delete updatedRecords[key]
                                }
                              })
                              
                              setStudents(updatedStudents)
                              setNormalizedEnrolls(updatedEnrolls)
                              setGrades(updatedGrades)
                              setRecords(updatedRecords)
                              
                              const newAlert = {
                                id: Date.now(),
                                type: 'general',
                                title: 'Students Deleted',
                                message: `Deleted ${selectedStudentsForBulk.length} archived student(s).`,
                                timestamp: new Date(),
                                read: false,
                              }
                              const updatedAlerts = [newAlert, ...alerts]
                              setAlerts(updatedAlerts)
                              
                              await saveData(subjects, updatedStudents, updatedEnrolls, updatedAlerts, updatedRecords, updatedGrades, profUid, true)
                              
                              setSelectedStudentsForBulk([])
                              setSelectAllStudents(false)
                              
                              addCustomAlert('success', 'Students Deleted', 'Selected archived students were removed permanently.', false)
                            }}
                            disabled={selectedStudentsForBulk.length === 0}
                            className={`px-4 py-2 rounded-lg font-medium text-sm transition-all ${
                              selectedStudentsForBulk.length === 0
                                ? 'bg-red-200 text-red-400 cursor-not-allowed'
                                : 'bg-red-600 text-white hover:bg-red-700'
                            }`}
                          >
                            Delete Selected
                          </button>
                        </div>
                    </div>
                    
                    {/* Scrollable Archived Student List */}
                      <div className="border border-amber-200 rounded-2xl overflow-hidden bg-gradient-to-br from-amber-50/60 to-amber-100/30 shadow-inner">
                        <div className="max-h-72 overflow-y-auto custom-scrollbar">
                        {students
                          .filter(student => {
                            // First filter: Show students archived from selected subjects
                            const matchesSubjectFilter = selectedSubjectsForBulk.length === 0
                              ? (student.archivedSubjects || []).length > 0
                              : selectedSubjectsForBulk.some(subjectCode => 
                                  (student.archivedSubjects || []).includes(subjectCode)
                                )
                            
                            if (!matchesSubjectFilter) return false
                            
                            // Second filter: Apply search term (name or ID)
                            if (studentSearchTerm.trim() === '') return true
                            
                            const searchLower = studentSearchTerm.toLowerCase().trim()
                            const nameMatch = student.name?.toLowerCase().includes(searchLower) || false
                            const idMatch = student.id?.toString().includes(searchLower) || false
                            
                            return nameMatch || idMatch
                          })
                          .map(student => {
                            const normalizedId = normalizeStudentId(student.id)
                            const isSelected = selectedStudentIdSet.has(normalizedId)
                            const enrolledIn = Object.keys(enrolls).filter(code => 
                              (enrolls[code] || []).some(id => normalizeStudentId(id) === normalizedId)
                            )
                            const archivedFrom = student.archivedSubjects || []
                            const archivedFromSelected = selectedSubjectsForBulk.length > 0
                              ? archivedFrom.filter(code => selectedSubjectsForBulk.includes(code))
                              : archivedFrom
                            
                            return (
                              <div key={student.id}>
                                <div
                                  className={`flex items-center space-x-3 px-4 py-3 border-b border-amber-100 hover:bg-amber-50 transition-colors cursor-pointer ${
                                    isSelected ? 'bg-amber-100' : ''
                                  }`}
                                  onClick={(e) => {
                                    // Don't trigger if clicking checkbox
                                    if (e.target.type !== 'checkbox') {
                                      setArchivedStudentDetailView(
                                        archivedStudentDetailView === student.id ? null : student.id
                                      )
                                    }
                                  }}
                                >
                                  <input
                                    type="checkbox"
                                    checked={isSelected}
                                    onChange={(e) => {
                                      e.stopPropagation()
                                    if (e.target.checked) {
                                      setSelectedStudentsForBulk([...selectedStudentsForBulk, normalizedId])
                                        setSelectAllStudents(false)
                                      } else {
                                      setSelectedStudentsForBulk(selectedStudentsForBulk.filter(id => normalizeStudentId(id) !== normalizedId))
                                        setSelectAllStudents(false)
                                      }
                                    }}
                                    onClick={(e) => e.stopPropagation()}
                                    className="w-5 h-5 text-maroon-600 border-slate-300 rounded focus:ring-maroon-500 cursor-pointer"
                                  />
                                  <div className="flex-1 min-w-0">
                                    <div className="text-sm font-semibold text-amber-900">{student.name}</div>
                                    <div className="text-xs text-amber-700">ID: {student.id}</div>
                                    {archivedFromSelected.length > 0 && (
                                      <div className="text-xs text-amber-600 mt-1">
                                        Archived from {archivedFromSelected.length} selected subject(s)
                                      </div>
                                    )}
                                    {enrolledIn.length > 0 && (
                                      <div className="text-xs text-slate-400 mt-1">
                                        Also enrolled in {enrolledIn.length} other subject(s)
                                      </div>
                                    )}
                                  </div>
                                  <svg 
                                    className={`w-5 h-5 text-amber-600 transition-transform ${
                                      archivedStudentDetailView === student.id ? 'rotate-180' : ''
                                    }`}
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                  >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                  </svg>
                                </div>
                                
                                {/* Detailed View */}
                                {archivedStudentDetailView === student.id && (
                                  <div className="bg-amber-50 border-l-4 border-amber-400 px-4 py-4 space-y-4">
                                    {/* Removed Subjects (Archived History) */}
                                    <div>
                                      <h5 className="text-sm font-bold text-amber-900 mb-2 flex items-center">
                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                        Removed Subjects (Archived History)
                                      </h5>
                                      {archivedFrom.length > 0 ? (
                                        <div className="space-y-2">
                                          {archivedFrom.map(subjectCode => {
                                            const subject = subjects.find(s => s.code === subjectCode)
                                            return (
                                              <div key={subjectCode} className="bg-white rounded-lg p-3 border border-amber-200">
                                                <div className="text-sm font-semibold text-amber-900">
                                                  {subject ? subject.name : subjectCode}
                                                </div>
                                                <div className="text-xs text-amber-600 mt-1">
                                                  {subject ? `${subject.code} â€¢ ${subject.credits} Credits` : subjectCode}
                                                </div>
                                              </div>
                                            )
                                          })}
                                        </div>
                                      ) : (
                                        <div className="text-sm text-amber-600 italic bg-white rounded-lg p-3 border border-amber-200">
                                          No archived subjects
                                        </div>
                                      )}
                                    </div>

                                    {/* Enrolled Subjects (Active Status) */}
                                    <div>
                                      <h5 className="text-sm font-bold text-emerald-900 mb-2 flex items-center">
                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Enrolled Subjects (Active Status)
                                      </h5>
                                      {enrolledIn.length > 0 ? (
                                        <div className="space-y-2">
                                          {enrolledIn.map(subjectCode => {
                                            const subject = subjects.find(s => s.code === subjectCode)
                                            return (
                                              <div key={subjectCode} className="bg-white rounded-lg p-3 border border-emerald-200">
                                                <div className="text-sm font-semibold text-emerald-900">
                                                  {subject ? subject.name : subjectCode}
                                                </div>
                                                <div className="text-xs text-emerald-600 mt-1">
                                                  {subject ? `${subject.code} â€¢ ${subject.credits} Credits` : subjectCode}
                                                </div>
                                              </div>
                                            )
                                          })}
                                        </div>
                                      ) : (
                                        <div className="text-sm text-emerald-600 italic bg-white rounded-lg p-3 border border-emerald-200">
                                          Not currently enrolled in any subjects
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                )}
                              </div>
                            )
                          })}
                        {students.filter(student => {
                          // First filter: Show students archived from selected subjects
                          const matchesSubjectFilter = selectedSubjectsForBulk.length === 0
                            ? (student.archivedSubjects || []).length > 0
                            : selectedSubjectsForBulk.some(subjectCode => 
                                (student.archivedSubjects || []).includes(subjectCode)
                              )
                          
                          if (!matchesSubjectFilter) return false
                          
                          // Second filter: Apply search term (name or ID)
                          if (studentSearchTerm.trim() === '') return true
                          
                          const searchLower = studentSearchTerm.toLowerCase().trim()
                          const nameMatch = student.name?.toLowerCase().includes(searchLower) || false
                          const idMatch = student.id?.toString().includes(searchLower) || false
                          
                          return nameMatch || idMatch
                        }).length === 0 && (
                          <div className="px-4 py-8 text-center text-amber-600">
                            {studentSearchTerm.trim() 
                              ? `No archived students found matching "${studentSearchTerm}" for the selected subjects.`
                              : 'No archived students found for the selected subjects.'}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="space-y-5">
          <div className={`rounded-2xl border shadow-lg px-6 py-5 ${
            isDarkMode ? 'bg-[#1b1b1b] border-slate-700' : 'bg-white border-slate-200'
          }`}>
            <p className="text-xs uppercase tracking-[0.2em] text-maroon-500">Basic Information</p>
            <h4 className={`mt-1 text-lg font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
              Create New Student Profile
            </h4>
            <p className={`text-sm mb-4 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
              Enter the official student ID, full name, and institutional email. Weâ€™ll automatically create the profile.
            </p>
            <div className="space-y-4 mt-2">
                  <div>
                    <label htmlFor="new-student-id" className="sr-only">Student ID</label>
                    <input
                      id="new-student-id"
                      name="new-student-id"
                      type="text"
                      value={newStudent.id}
                      onChange={(e) => {
                        const value = e.target.value.replace(/\D/g, '')
                        setNewStudent(prev => ({ ...prev, id: value }))
                      }}
                      placeholder="Student ID"
                      className={`form-input-field focus:ring-2 focus:ring-maroon-500 ${
                        isDarkMode ? 'bg-[#101010] border-slate-700 text-white placeholder:text-slate-500' : ''
                      }`}
                      pattern="[0-9]*"
                      inputMode="numeric"
                    />
                  </div>
                  <div>
                    <label htmlFor="new-student-name" className="sr-only">Student full name</label>
                    <input
                      id="new-student-name"
                      name="new-student-name"
                      type="text"
                      value={newStudent.name}
                      onChange={(e) => setNewStudent(prev => ({ ...prev, name: e.target.value }))}
                      placeholder="Student full name"
                      className={`form-input-field focus:ring-2 focus:ring-maroon-500 ${
                        isDarkMode ? 'bg-[#101010] border-slate-700 text-white placeholder:text-slate-500' : ''
                      }`}
                    />
                  </div>
                  <div>
                    <label htmlFor="new-student-email" className="sr-only">Institutional email</label>
                    <input
                      id="new-student-email"
                      name="new-student-email"
                      type="email"
                      value={newStudent.email}
                      onChange={(e) => setNewStudent(prev => ({ ...prev, email: e.target.value }))}
                      placeholder="Institutional email"
                      className={`form-input-field focus:ring-2 focus:ring-maroon-500 ${
                        isDarkMode ? 'bg-[#101010] border-slate-700 text-white placeholder:text-slate-500' : ''
                      }`}
                    />
                  </div>
            </div>
          </div>
          <div className={`rounded-2xl border shadow-lg px-6 py-5 ${
            isDarkMode ? 'bg-[#1b1b1b] border-slate-700' : 'bg-white border-slate-200'
          }`}>
            <p className="text-xs uppercase tracking-[0.2em] text-maroon-500">Enrollment</p>
            <h4 className={`mt-1 text-lg font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
              Assign Subjects
            </h4>
            <p className={`text-sm mb-3 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
              Select one or more subjects where this student should be enrolled immediately.
            </p>
            <div className="mt-3 relative" ref={newStudentSubjectDropdownRef}>
              <button
                type="button"
                onClick={() => setShowNewStudentSubjectDropdown(prev => !prev)}
                className={`w-full flex items-center justify-between rounded-2xl border px-4 py-3 text-left transition-all ${
                  isDarkMode ? 'border-slate-600 bg-[#0f0f0f]' : 'border-slate-200 bg-white'
                }`}
              >
                <div className="pr-4">
                  <p className={`text-xs ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                    {newStudent.subjects?.length > 0
                      ? `${newStudent.subjects.length} subject${newStudent.subjects.length === 1 ? '' : 's'} selected`
                      : 'No subjects selected'}
                  </p>
                  <p className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-slate-800'} truncate`}>
                    {newStudent.subjects?.length > 0
                      ? newStudent.subjects.map(getSubjectLabel).join(', ')
                      : 'Click to choose subjects'}
                  </p>
                </div>
                <svg
                  className={`w-5 h-5 flex-shrink-0 transition-transform ${
                    showNewStudentSubjectDropdown ? 'rotate-180' : ''
                  } ${isDarkMode ? 'text-white' : 'text-maroon-600'}`}
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              {showNewStudentSubjectDropdown && (
                <div
                  className={`absolute z-40 mt-2 w-full rounded-2xl border shadow-2xl ${
                    // Use white panel so rows donâ€™t appear black
                    'bg-white border-slate-200'
                  }`}
                >
                  <div className="max-h-56 overflow-y-auto divide-y divide-slate-100">
                    {subjects.length === 0 ? (
                      <p className={`text-sm px-4 py-3 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                        No subjects available. Create a subject first.
                      </p>
                    ) : (
                      subjects.map(subject => {
                        const checked = (newStudent.subjects || []).includes(subject.code)
                        return (
                          <label
                            key={subject.code}
                            className="flex items-center justify-between px-4 py-2 cursor-pointer hover:bg-slate-50"
                            onMouseDown={e => e.preventDefault()}
                          >
                            <div className="flex items-center gap-3">
                              <input
                                type="checkbox"
                                checked={checked}
                                onChange={() => toggleNewStudentSubjectSelection(subject.code)}
                                className="form-checkbox h-4 w-4 text-maroon-600 rounded"
                              />
                              <span className={isDarkMode ? 'text-white' : 'text-slate-800'}>
                        {subject.code} â€” {subject.name}
                              </span>
                            </div>
                            {checked && (
                              <svg className="w-4 h-4 text-maroon-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                              </svg>
                            )}
                          </label>
                        )
                      })
                    )}
                  </div>
                  <div className={`flex items-center justify-between px-4 py-2 border-t ${
                    isDarkMode ? 'border-slate-700' : 'border-slate-100'
                  }`}>
                    <button
                      type="button"
                      onClick={() => setNewStudent(prev => ({ ...prev, subjects: [] }))}
                      className="text-xs font-semibold text-slate-500 hover:text-slate-700"
                    >
                      Clear
                    </button>
                    <button
                      type="button"
                      onClick={() => setShowNewStudentSubjectDropdown(false)}
                      className="text-sm font-semibold text-maroon-600 hover:text-maroon-800"
                    >
                      Done
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
                </div>
              )}
            </div>

            {/* Action Buttons - Only show for Archived and Create tabs, not Import tab */}
            {addStudentModalTab !== 'import' && (
            <div className="flex justify-end space-x-4 mt-6 pt-6 border-t border-slate-200">
              <button
                type="button"
                onClick={() => {
                  setShowAddStudentModal(false)
                  setAddStudentModalTab('archived')
                  setSelectedStudentsForBulk([])
                  setSelectedSubjectsForBulk([])
                  setSelectAllStudents(false)
                  setArchivedStudentDetailView(null)
                }}
                className="px-6 py-3 text-slate-600 hover:text-slate-800 font-medium rounded-xl hover:bg-slate-100 transition-all"
              >
                Cancel
              </button>
              {addStudentModalTab === 'archived' ? (
                <button
                  onClick={async () => {
                    try {
                      if (selectedStudentsForBulk.length === 0) {
                        addCustomAlert('warning', 'No Selection', 'Please select at least one archived student.', false)
                        return
                      }
                      if (selectedSubjectsForBulk.length === 0) {
                        addCustomAlert('warning', 'No Subject Selected', 'Please select at least one subject to restore from.', false)
                        return
                      }

                      // Bulk restore archived students
                      let updatedEnrolls = { ...enrolls }
                      let updatedStudents = [...students]
                      let restoredCount = 0
                      let studentsRestored = new Set()

                      for (const studentId of selectedStudentsForBulk) {
                        const normalizedId = normalizeStudentId(studentId)
                        const student = students.find(s => normalizeStudentId(s.id) === normalizedId)
                        if (!student) continue

                        // Remove from archived subjects
                        const needsUnarchive = selectedSubjectsForBulk.some(code => 
                          (student.archivedSubjects || []).includes(code)
                        )
                        if (needsUnarchive) {
                          updatedStudents = updatedStudents.map(s => {
                            if (normalizeStudentId(s.id) === normalizedId) {
                              return {
                                ...s,
                                archivedSubjects: (s.archivedSubjects || []).filter(code => 
                                  !selectedSubjectsForBulk.includes(code)
                                )
                              }
                            }
                            return s
                          })
                        }

                        // Restore enrollment in selected subjects
                        for (const subjectCode of selectedSubjectsForBulk) {
                          // Only restore if student was archived from this subject
                          const wasArchived = (student.archivedSubjects || []).includes(subjectCode)
                          if (!wasArchived) continue

                          if (!updatedEnrolls[subjectCode]) {
                            updatedEnrolls[subjectCode] = []
                          }
                          if (!updatedEnrolls[subjectCode].some(id => normalizeStudentId(id) === normalizedId)) {
                            updatedEnrolls[subjectCode].push(normalizedId)
                            restoredCount++
                            studentsRestored.add(normalizedId)
                          }

                          // Sync to student dashboard
                          try {
                            const verification = await verifyStudentIdEmailPair(student.id, student.email)
                            if (verification.verified && verification.uid) {
                              const subject = subjects.find(s => s.code === subjectCode)
                              if (subject) {
                                const currentDashboard = await getStudentDashboard(verification.uid)
                                const currentSubjects = currentDashboard?.subjects || []
                                const subjectExists = currentSubjects.find(s => s.code === subjectCode)
                                if (!subjectExists) {
                                  const updatedSubjects = [...currentSubjects, subject]
                                  await syncStudentSubjects(verification.uid, updatedSubjects)
                                }
                              }
                            }
                          } catch (error) {
                            console.warn(`Failed to sync restoration for student ${studentId}`, error)
                          }
                        }
                      }

                      // Update state immediately
                      setNormalizedEnrolls(updatedEnrolls)
                      setStudents(updatedStudents)

                      // Create success alert
                      const newAlert = {
                        id: Date.now(),
                        type: 'general',
                        title: 'Students Restored',
                        message: `Successfully restored ${studentsRestored.size} student(s) from ${selectedSubjectsForBulk.length} subject(s)`,
                        timestamp: new Date(),
                        read: false,
                        studentIds: [...selectedStudentsForBulk],
                        subjectCodes: [...selectedSubjectsForBulk],
                        target_courseId: selectedSubjectsForBulk[0] || null,
                      }
                      const updatedAlerts = [newAlert, ...alerts]
                      setAlerts(updatedAlerts)

                      // Save to Firestore immediately (critical operation)
                      const saveResult = await saveData(subjects, updatedStudents, updatedEnrolls, updatedAlerts, records, grades, profUid, true)

                      if (!saveResult) {
                        console.error('âŒ CRITICAL: Restore save operation returned false - data may not have been saved!')
                        addCustomAlert('error', 'Save Failed', 'Failed to save restored students to Firestore. Data may not persist after refresh. Please try again.', false)
                        return
                      }

                      // Show success message
                      addCustomAlert('success', 'Students Restored', `Successfully restored ${studentsRestored.size} student(s) from ${selectedSubjectsForBulk.length} subject(s).`, false)

                      // Close modal and reset selections
                      setShowAddStudentModal(false)
                      setSelectedStudentsForBulk([])
                      setSelectedSubjectsForBulk([])
                      setSelectAllStudents(false)
                    } catch (error) {
                      console.error('Error restoring students:', error)
                      addCustomAlert('error', 'Restore Failed', `Failed to restore students: ${error.message}`, false)
                    }
                  }}
                  className="btn text-white px-6 py-3 rounded-xl font-semibold shadowLg hover:shadow-xl transition-all duration-300"
                >
                  Restore Selected Students
                </button>
              ) : (
                <button
                  onClick={async () => {
                    await handleAddStudent()
                    setShowAddStudentModal(false)
                    setAddStudentModalTab('enroll')
                    setNewStudent({ id: '', name: '', email: '', subjects: [] })
                  }}
                  className="btn text-white px-6 py-3 rounded-xl font-semibold shadowLg hover:shadow-xl transition-all duration-300"
                >
                  Add Student
                </button>
              )}
            </div>
            )}
          </div>
        </div>
      )}

      {/* Add Student to Subject Modal */}
      {showAddStudentToSubjectModal && selectedSubjectForStudent && (
        <div className="fixed inset-0 modal items-center justify-center z-50 p-4 flex" onClick={() => {
          setShowAddStudentToSubjectModal(false)
          setSelectedSubjectForStudent(null)
          setStudentToAdd('')
          setNewStudentQuick({ id: '', name: '', email: '' })
        }}>
          <div className={`glass rounded-2xl p-8 w-full max-w-md shadow-2xl ${
            isDarkMode ? 'bg-[#2c2c2c] border border-slate-700' : ''
          }`} onClick={(e) => e.stopPropagation()}>
            <div className="text-center mb-6">
              <div className="w-16 h-16 bg-[#7A1315] rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg relative">
                <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                  {/* Main person icon */}
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor" />
                </svg>
                {/* Plus sign overlay - positioned in bottom right */}
                <div className="absolute bottom-0 right-0 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-md">
                  <svg className="w-3 h-3 text-[#7A1315]" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={3}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                </svg>
              </div>
              </div>
              <h3 className={`text-2xl font-bold mb-2 ${
                isDarkMode ? 'text-white' : 'text-slate-800'
              }`}>Add Student to Subject</h3>
              <p className={isDarkMode ? 'text-slate-300' : 'text-slate-600'}>
                {(() => {
                  const subject = subjects.find(s => s.code === selectedSubjectForStudent)
                  return subject ? `Add student to ${subject.name} (${subject.code})` : 'Select a student to enroll'
                })()}
              </p>
            </div>
            <div className="space-y-5">
              {/* Select Student Dropdown - Full Width, Prominent */}
              <div className="relative">
              <select
                value={studentToAdd}
                onChange={(e) => setStudentToAdd(e.target.value)}
                  className={`w-full form-select-field focus:ring-2 focus:ring-maroon-500 appearance-none pr-10 ${
                    isDarkMode 
                      ? 'bg-[#1a1a1a] text-white border-slate-600' 
                      : 'bg-white text-slate-800 border-slate-300'
                  }`}
                  style={{
                    backgroundImage: 'none',
                    WebkitAppearance: 'none',
                    MozAppearance: 'none'
                  }}
              >
                <option value="">Select Student</option>
                {students
                  .filter(student => {
                    // Exclude students who are already enrolled in this subject
                    const normalizedId = normalizeStudentId(student.id)
                    const isEnrolled = (enrolls[selectedSubjectForStudent] || []).some(id => normalizeStudentId(id) === normalizedId)
                    // Exclude students who are archived for this subject
                    const isArchived = (student.archivedSubjects || []).includes(selectedSubjectForStudent)
                    return !isEnrolled && !isArchived
                  })
                  .map(student => (
                    <option key={student.id} value={student.id}>
                      {student.name} - ID: {student.id}
                    </option>
                  ))}
              </select>
                {/* Custom dropdown arrow icon */}
                <div className="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none z-10">
                  <svg 
                    className={`w-5 h-5 ${isDarkMode ? 'text-white' : 'text-[#7A1315]'}`}
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                    strokeWidth={2.5}
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>
              
              <div className={`space-y-3 mt-4 border-t pt-4 ${
                isDarkMode ? 'border-slate-600' : 'border-slate-200'
              }`}>
                <p className={`text-sm font-semibold ${
                  isDarkMode ? 'text-slate-300' : 'text-slate-700'
                }`}>Or create new student:</p>
                <div>
                  <label htmlFor="quick-student-id" className="sr-only">New Student ID</label>
                  <input
                    id="quick-student-id"
                    name="quick-student-id"
                    type="text"
                    value={newStudentQuick.id}
                    onChange={(e) => {
                      // Only allow numerical input
                      const value = e.target.value.replace(/\D/g, '')
                      setNewStudentQuick(prev => ({ ...prev, id: value }))
                    }}
                    placeholder="New Student ID"
                    className={`w-full rounded-xl px-4 py-3 text-sm border transition-all focus:ring-2 focus:ring-maroon-500 ${
                      isDarkMode 
                        ? 'bg-[#1a1a1a] text-white border-slate-600 placeholder:text-slate-400' 
                        : 'bg-white/80 text-slate-800 border-slate-200 placeholder:text-slate-500'
                    }`}
                    pattern="[0-9]*"
                    inputMode="numeric"
                  />
                </div>
                <div>
                  <label htmlFor="quick-student-name" className="sr-only">New Student Name</label>
                  <input
                    id="quick-student-name"
                    name="quick-student-name"
                    type="text"
                    value={newStudentQuick.name}
                    onChange={(e) => setNewStudentQuick(prev => ({ ...prev, name: e.target.value }))}
                    placeholder="New Student Name"
                    className={`w-full rounded-xl px-4 py-3 text-sm border transition-all focus:ring-2 focus:ring-maroon-500 ${
                      isDarkMode 
                        ? 'bg-[#1a1a1a] text-white border-slate-600 placeholder:text-slate-400' 
                        : 'bg-white/80 text-slate-800 border-slate-200 placeholder:text-slate-500'
                    }`}
                  />
                </div>
                <div>
                  <label htmlFor="quick-student-email" className="sr-only">Email (optional)</label>
                  <input
                    id="quick-student-email"
                    name="quick-student-email"
                    type="email"
                    value={newStudentQuick.email}
                    onChange={(e) => setNewStudentQuick(prev => ({ ...prev, email: e.target.value }))}
                    placeholder="Email (optional)"
                    className={`w-full rounded-xl px-4 py-3 text-sm border transition-all focus:ring-2 focus:ring-maroon-500 ${
                      isDarkMode 
                        ? 'bg-[#1a1a1a] text-white border-slate-600 placeholder:text-slate-400' 
                        : 'bg-white/80 text-slate-800 border-slate-200 placeholder:text-slate-500'
                    }`}
                  />
                </div>
              </div>
            </div>
            <div className="flex justify-end space-x-4 mt-8">
              <button
                type="button"
                onClick={() => {
                  setShowAddStudentToSubjectModal(false)
                  setSelectedSubjectForStudent(null)
                  setStudentToAdd('')
                  setNewStudentQuick({ id: '', name: '', email: '' })
                }}
                className={`px-6 py-3 font-medium rounded-xl transition-all ${
                  isDarkMode 
                    ? 'text-slate-300 hover:text-white hover:bg-slate-700' 
                    : 'text-slate-600 hover:text-slate-800 hover:bg-slate-100'
                }`}
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  await handleAddStudentToSubject()
                }}
                className="btn text-white px-6 py-3 rounded-xl font-semibold shadowLg hover:shadow-xl transition-all duration-300"
              >
                Add Student
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default Prof
